<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.19.3 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Mesh networking: A guide to using free and open-source software with common hardware - CGomesu</title>
<meta name="description" content="A blog and portfolio website built with Jekyll and hosted on Github Pages">


  <meta name="author" content="Carlos Gomes">


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="CGomesu">
<meta property="og:title" content="Mesh networking: A guide to using free and open-source software with common hardware">
<meta property="og:url" content="/blog/Mesh-networking-openwrt-batman/">


  <meta property="og:description" content="A blog and portfolio website built with Jekyll and hosted on Github Pages">



  <meta property="og:image" content="/assets/posts/2020-11-24-mesh-networking-openwrt-batman/header.jpg">





  <meta property="article:published_time" content="2020-12-07T12:10:00-03:00">





  

  


<link rel="canonical" href="/blog/Mesh-networking-openwrt-batman/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "",
      "url": "/"
    
  }
</script>


  <meta name="google-site-verification" content="FA-B3i_TqYeaLPYwZvxxOsx07Coy_drBKJ0M_4DD0Gw" />





<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="CGomesu Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->
<link rel="icon" href="/assets/img/site/favicon.ico" type="image/x-icon">

<!-- end custom head snippets -->

  </head>

  <body class="layout--single wide">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/assets/img/site/logo.png" alt=""></a>
        
        <a class="site-title" href="/">
           
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/">Home</a>
            </li><li class="masthead__menu-item">
              <a href="/blog/">Blog</a>
            </li><li class="masthead__menu-item">
              <a href="/contact/">Contact</a>
            </li><li class="masthead__menu-item">
              <a href="/mtg/">MtG</a>
            </li><li class="masthead__menu-item">
              <a href="/publications/">Publications</a>
            </li><li class="masthead__menu-item">
              <a href="/projects/">Projects</a>
            </li><li class="masthead__menu-item">
              <a href="/donations/">Donations</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      
  







<div class="page__hero--overlay"
  style="background-color: #000; background-image: linear-gradient(rgba(0, 0, 0, 0.85), rgba(0, 0, 0, 0.85)), url('/assets/posts/2020-11-24-mesh-networking-openwrt-batman/header.jpg');"
>
  
    <div class="wrapper">
      <h1 id="page-title" class="page__title" itemprop="headline">
        
          Mesh networking: A guide to using free and open-source software with common hardware

        
      </h1>
      
        <p class="page__lead">
</p>
      
      
        <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  127 minute read

</p>
      
      
      
    </div>
  
  
</div>





<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="/assets/img/profile/profile-00.jpg" alt="Carlos Gomes" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Carlos Gomes</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>I’m a scientist, psychologist, math modeler, programmer, mtg player, free knowledge supporter, sbc fanatic, and electronics hobbyist.</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Learn more</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Brazil</span>
        </li>
      

      
        
          
            <li><a href="mailto:me@cgomesu.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Main e-mail</span></a></li>
          
        
          
            <li><a href="/donations" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-donate" aria-hidden="true"></i><span class="label">Donations</span></a></li>
          
        
          
            <li><a href="https://cgomesu.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-link" aria-hidden="true"></i><span class="label">https://cgomesu.com</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Mesh networking: A guide to using free and open-source software with common hardware">
    <meta itemprop="description" content="">
    <meta itemprop="datePublished" content="2020-12-07T12:10:00-03:00">
    

    <div class="page__inner-wrap">
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-list"></i> Table of Contents</h4></header>
              <ul class="toc__menu">
  <li><a href="#changelog">Changelog</a></li>
  <li><a href="#introduction">Introduction</a></li>
  <li><a href="#why-am-i-writing-this-guide">Why am I writing this guide?</a></li>
  <li><a href="#objectives">Objectives</a></li>
  <li><a href="#outline">Outline</a></li>
  <li><a href="#concepts-and-documentation">Concepts and documentation</a>
    <ul>
      <li><a href="#main-network-definitions">Main network definitions</a></li>
      <li><a href="#network-topologies">Network topologies</a></li>
      <li><a href="#mesh-networks">Mesh networks</a>
        <ul>
          <li><a href="#what-are-mesh-networks">What are mesh networks?</a></li>
          <li><a href="#where-can-i-learn-more-about-mesh-networking">Where can I learn more about mesh networking?</a></li>
          <li><a href="#routing-protocols">Routing protocols</a>
            <ul>
              <li><a href="#batman-adv">batman-adv</a></li>
              <li><a href="#batctl">batctl</a></li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#hardware">Hardware</a>
    <ul>
      <li><a href="#hardware-specific-configurations">Hardware-specific configurations</a>
        <ul>
          <li><a href="#ath9k-modules">ath9k modules</a></li>
          <li><a href="#ath10k-modules">ath10k modules</a></li>
        </ul>
      </li>
      <li><a href="#useful-hardware-resources">Useful hardware resources</a></li>
    </ul>
  </li>
  <li><a href="#software">Software</a>
    <ul>
      <li><a href="#vi-text-editor">VI text editor</a>
        <ul>
          <li><a href="#vi-cheat-table">VI cheat table</a></li>
          <li><a href="#alternatives-to-vi">Alternatives to VI</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#implementation">Implementation</a>
    <ul>
      <li><a href="#planning">Planning</a></li>
      <li><a href="#openwrt-installation-and-initial-configuration">OpenWrt installation and initial configuration</a>
        <ul>
          <li><a href="#initial-configuration">Initial configuration</a></li>
          <li><a href="#default-config-for-the-hardware">Default config for the hardware</a></li>
          <li><a href="#updating-and-installing-packages">Updating and installing packages</a></li>
        </ul>
      </li>
      <li><a href="#mesh-node-basic-config">Mesh node basic config</a></li>
      <li><a href="#troubleshooting-mesh-issues">Troubleshooting mesh issues</a></li>
      <li><a href="#configuring-common-mesh-networks">Configuring common mesh networks</a>
        <ul>
          <li><a href="#gateway-bridge">Gateway-Bridge</a>
            <ul>
              <li><a href="#mesh-gateway-configuration">Mesh gateway configuration</a></li>
              <li><a href="#mesh-bridge-configuration">Mesh bridge configuration</a></li>
            </ul>
          </li>
          <li><a href="#bridge-bridge">Bridge-Bridge</a></li>
          <li><a href="#gateway-gateway">Gateway-Gateway</a></li>
        </ul>
      </li>
      <li><a href="#mesh-vlans">Mesh VLANs</a>
        <ul>
          <li><a href="#mesh-gateway-with-vlan-configuration">Mesh gateway with VLAN configuration</a></li>
          <li><a href="#mesh-bridge-with-vlan-configuration">Mesh bridge with VLAN configuration</a></li>
        </ul>
      </li>
      <li><a href="#getting-started-with-batman-adv-on-any-linux-device">Getting started with batman-adv on any Linux device</a></li>
    </ul>
  </li>
  <li><a href="#bonus-content-physical-computing">Bonus content: Physical computing</a></li>
  <li><a href="#bonus-content-moving-from-openwrt-19-to-21">Bonus content: Moving from OpenWrt 19 to 21</a></li>
  <li><a href="#final-remarks">Final remarks</a>
    <ul>
      <li><a href="#other-similar-mesh-solutions">Other similar mesh solutions</a></li>
    </ul>
  </li>
</ul>

            </nav>
          </aside>
        
        <h1 id="changelog">Changelog</h1>
<p class="notice--success"><strong>October 6th, 2021</strong>: The guide was completely updated to make it consistent with the current stable release, namely <strong>OpenWrt 21.02</strong>.  In brief, most of the changes had to do with the <a href="https://openwrt.org/releases/21.02/notes-21.02.0#new_network_configuration_syntax_and_boardjson_change"><strong>new network syntax</strong></a> and <a href="https://openwrt.org/releases/21.02/notes-21.02.0#increased_minimum_hardware_requirements8_mb_flash_64_mb_ram"><strong>increased hardware requirements</strong></a>.  More specifically, OpenWrt 21.02 drops the use of <code class="language-plaintext highlighter-rouge">ifname</code> and make a more clear distinction between layer 2 and layer 3 configurations in the <code class="language-plaintext highlighter-rouge">/etc/config/network</code> file. In addition, the minimum requirements to run OpenWrt are now <code class="language-plaintext highlighter-rouge">8MB</code> of flash memory and <code class="language-plaintext highlighter-rouge">64MB</code> of RAM.  The latter change prompted me to use a new TP-Link router for the examples, namely the TL-WDR4300, instead of the old WR1043ND (v1). This new router is still a low-end device, which makes very affordable and easy to find worldwide, but contrary to the WR1043ND, it is actually a <em>dual-band</em> router.  This was an opportunity to illustrate wireless segmentation for mesh vs. non-mesh communication, which is something I think is almost required in most use cases, so <a href="/assets/posts/2020-11-24-mesh-networking-openwrt-batman/segmentation.jpg">the new guide makes use of it by default</a>. I also took this opportunity to update many, many other things.  To mention two main ones: (a) at the end of the <a href="#openwrt-installation-and-initial-configuration">OpenWrt installation and initial configuration</a> section, there’s now a description of how to build custom images that contain all the required mesh packages; and (b) the section <a href="#bonus-content-moving-from-openwrt-19-to-21">Bonus content: Moving from OpenWrt 19 to 21</a> was update to help users who followed the earlier version of this guide to transition to the new release. This was a big one and took a few days to get it done.  Hope you find it useful!</p>
<p class="notice--info"><strong>September 16th, 2021</strong>: Updated the information about OpenWrt 21 in the section <a href="#bonus-content-moving-from-openwrt-19-to-21"><strong>Bonus content: Moving from OpenWrt 19 to 21</strong></a>.  In brief, DSA support is still very limited and OpenWrt has officially started rolling out version 21 with the <a href="https://openwrt.org/releases/21.02/notes-21.02.0">release of OpenWrt 21.02</a>. I’m currently testing the new version and network configuration on a few devices and once I get everything running as well as it was in version 19, I will update the entire article to reflect the new (and current) configuration.  It is, of course, still possible to download and use <a href="https://downloads.openwrt.org/releases/19.07.8/targets/">the latest OpenWrt 19 images</a>, which should be just fine for a long time still.  However, if you want to make use of OpenWrt 21, then read the aforementioned bonus section for guidance on the syntax changes and updated hardware requirements.</p>
<p class="notice--info"><strong>July 6th, 2021</strong>: Added information about transitioning from OpenWrt 19 (current stable release) to OpenWrt 21 (next stable release) to a new section called <a href="#bonus-content-moving-from-openwrt-19-to-21"><strong>Bonus content: Moving from OpenWrt 19 to 21</strong></a>.  In brief, the <em>next</em> stable release includes changes to the network configuration syntax that are incompatible with this guide.  Once the release version 21 becomes the <em>current</em> stable, however, I will update the main guide to reflect those changes.  In the meantime, I added a few references to the OpenWrt forum that should help anyone interested in using version 21 instead of 19.  Thanks to <a href="https://forum.openwrt.org/u/SteveNewcomb">Steve</a> for testing and sharing his <code class="language-plaintext highlighter-rouge">batman-adv</code> configuration running on OpenWrt 21.</p>
<p class="notice--info"><strong>Feb 17th, 2021</strong>: Per a reader’s suggestion (Joshua), I added a <a href="#vi-cheat-table"><code class="language-plaintext highlighter-rouge">vi</code> cheat table</a> that has a summary of the main commands, and in the <a href="#mesh-node-basic-config">Mesh node basic config</a> section, I included additional instructions on how to copy and paste the configuration files from one mesh node to another using <code class="language-plaintext highlighter-rouge">scp</code>.  (Alternatively, it’s also possible to do so using Luci’s backup/restore option.)</p>
<p class="notice--info"><strong>Jan 9th, 2021</strong>, Update #2: Added instructions on how to automatically upgrade all installed packages with a single command.  This information is in <a href="#updating-and-installing-packages">Updating and installing packages</a>.</p>
<p class="notice--info"><strong>Jan 9th, 2021</strong>, Update #1: Added a new section about <a href="#hardware-specific-configurations">hardware-specific configurations</a> that are sometimes required for enabling the <code class="language-plaintext highlighter-rouge">mesh point</code> mode of operation.</p>
<p class="notice--info"><strong>Dec 7th, 2020</strong>: Publication of the original guide</p>

<p><a href="#" class="btn btn--light-outline btn--small">top</a></p>

<h1 id="introduction">Introduction</h1>
<p>In this tutorial, we will learn how to create <a href="https://en.wikipedia.org/wiki/Wireless_mesh_network"><strong>mesh networks</strong></a> (<a href="https://en.wikipedia.org/wiki/IEEE_802.11s"><strong>IEEE 802.11s</strong></a>) using <a href="https://openwrt.org/"><strong>OpenWrt</strong></a> and the <a href="https://en.wikipedia.org/wiki/Data_link_layer">layer-2</a> implementation of the <em>Better Approach to Mobile Adhoc Networking</em>, called <a href="https://www.kernel.org/doc/html/v4.15/networking/batman-adv.html"><strong>batman-adv</strong></a>.  All the software mentioned here is <strong>free</strong> and <strong>open-source</strong>, as opposed to commercial alternatives (<a href="https://unifi-mesh.ui.com">UniFi Mesh</a> or <a href="https://store.google.com/us/product/nest_wifi">Google’s Nest Wifi</a>).</p>

<p>This is not meant to be an exhaustive presentation of any of the covered topics. If you have suggestions on how to improve this guide, feel free to <a href="/contact/">get in touch with me</a>. I’m always eager to learn new things and share them. Also, I plan on updating this article every once in a while to best reflect my knowledge about the topics covered here and to add information provided by the readers. Check the <a href="#changelog">changelog</a> for updates.</p>

<p><a href="#" class="btn btn--light-outline btn--small">top</a></p>

<h1 id="why-am-i-writing-this-guide">Why am I writing this guide?</h1>
<p>Even though the concept of mesh networking has been around for quite some time now, the documentation of its implementation is still scarce/nichey, proprietary, or outdated.  I don’t feel qualified to speculate on why this is so but I find it odd because many of the radio devices found in popular wireless routers actually support mesh networking–but the original firmware rarely supports it.</p>

<p>My intention with this tutorial is to help closing the gap between concept and implementation of mesh networking using up-to-date software that anyone can download and install on cheap, commonly available hardware–primarily consumer wireless routers (from old to new, single- or multi-band) but the principles should be extendable to any cellphones, laptops, PCs or servers running <strong>Linux</strong>.  The content is partially based on my own experience and builds upon the work of other, much more talented individuals who shared their knowledge on the Web.  More specifically, the content is notably influenced by the following:</p>

<ul>
  <li>Brian Innes workshop about using Raspberry Pis to create a mesh network for sharing sensor data wirelessly (<a href="https://github.com/binnes/WiFiMeshRaspberryPi">Github repo</a>)</li>
  <li>Andreas Spiess <a href="https://www.youtube.com/watch?v=TY6m6fS8bxU">LoRa mesh project</a></li>
  <li>Maintaners of the <a href="https://openwrt.org/docs/start">OpenWRT documentation</a> and the <a href="https://www.open-mesh.org/projects/batman-adv/wiki">B.A.T.M.A.N. wiki</a></li>
  <li>Multiple users from the OpenWrt forum who shared their opinions over the years. To name a few,  the users <a href="https://forum.openwrt.org/u/jeff">jeff</a>, <a href="https://forum.openwrt.org/u/mcarni">mcarni</a>, <a href="https://forum.openwrt.org/u/oavaldezi">oavaldezi</a>, <a href="https://forum.openwrt.org/u/slh">slh</a>, and many others. Thanks for keeping the posts public.</li>
</ul>

<p><a href="#" class="btn btn--light-outline btn--small">top</a></p>

<h1 id="objectives">Objectives</h1>
<ol>
  <li>Get familiar with <code class="language-plaintext highlighter-rouge">/etc/config/</code> files in OpenWrt devices (namely, <code class="language-plaintext highlighter-rouge">wireless</code>, <code class="language-plaintext highlighter-rouge">network</code>, <code class="language-plaintext highlighter-rouge">dhcp</code>, <code class="language-plaintext highlighter-rouge">firewall</code>) to quickly and permanently configure mesh nodes.</li>
  <li>Edit files directly from the terminal using the default text editor <code class="language-plaintext highlighter-rouge">vi</code>.</li>
  <li>Configure OpenWrt devices to play one of three possible roles in the network: (a) mesh node, (b) mesh + bridge node, or (c) mesh + gateway node.</li>
  <li>Install and configure the Kernel module <code class="language-plaintext highlighter-rouge">batman-adv</code> on an OpenWrt device using the <code class="language-plaintext highlighter-rouge">opkg</code> package manager.</li>
  <li>Use <code class="language-plaintext highlighter-rouge">batctl</code> to test, debug, and monitor connectivity within the mesh.</li>
  <li>Use two radios to segment mesh (5Ghz) from non-mesh (2.4Ghz) wireless communication.</li>
  <li>Add encryption to the mesh network with the package <code class="language-plaintext highlighter-rouge">wpad-mesh-openssl</code>.</li>
  <li>Use VLANs to create <code class="language-plaintext highlighter-rouge">default</code>, <code class="language-plaintext highlighter-rouge">iot</code>, and <code class="language-plaintext highlighter-rouge">guest</code> networks within the mesh using <code class="language-plaintext highlighter-rouge">batman-adv</code>.</li>
</ol>

<p><a href="#" class="btn btn--light-outline btn--small">top</a></p>

<h1 id="outline">Outline</h1>
<p>From this point forward, the article is divided into four main parts:</p>
<ol>
  <li><a href="#concepts-and-documentation">Concepts and documentation</a>: <em>Optional for advanced users.</em> Brief introduction to just enough network concepts to allow the implementation of simple mesh networks. When appropriate, a link to the relevant OpenWrt documentation was also provided.</li>
  <li><a href="#hardware">Hardware</a>: <em>Optional for everyone</em>. A few notes about the hardware used in the examples and recommendations for those who are planning on buying new/used devices for their mesh project.</li>
  <li><a href="#software">Software</a>: <em>Optional for everyone</em>. A few notes about the software used in the examples.</li>
  <li><a href="#implementation">Implementation</a>: <em>Required</em>. Step-by-step procedure to configure mesh nodes, bridges, and gateways.  It goes from flashing OpenWrt to configuring VLANs with <code class="language-plaintext highlighter-rouge">batman-adv</code>. You probably came here for this part.</li>
</ol>

<p><a href="#" class="btn btn--light-outline btn--small">top</a></p>

<h1 id="concepts-and-documentation">Concepts and documentation</h1>

<h2 id="main-network-definitions">Main network definitions</h2>
<ul>
  <li>Mesh <a href="https://en.wikipedia.org/wiki/Node_(networking)">node</a>: Any network device that is connected to the mesh network and that helps routing data to (and from) mesh clients.  Here, however, if a mesh node acts as a bridge or gateway, it will always be referred by the latter role, even though by definition, mesh bridges and mesh gateways are also mesh nodes.<br />
In addition, even though it’s possible to route mesh traffic via cable, in this tutorial, <em>all mesh nodes are also wireless devices</em>, meaning that they have access to a radio with <a href="https://en.wikipedia.org/wiki/IEEE_802.11s"><strong>mesh point</strong> (802.11s)</a> capabilities.
    <ul>
      <li><a href="https://openwrt.org/docs/guide-user/network/wifi/basic">Learn about the OpenWrt wireless config <strong>/etc/config/wireless</strong></a></li>
    </ul>
  </li>
  <li>
    <p><a href="https://en.wikipedia.org/wiki/Bridging_(networking)">Bridge</a>: A network device that joins any two or more network interfaces (e.g., LAN Ethernet and wireless) into a single network.  Here, when a device is referred to as a bridge, it means that in addition to being a mesh node, the only other thing it does is bridge interfaces.  But of course, a gateway <em>device</em>, such as a router with a built-in modem, or a firewall appliance, may also work as a bridge for multiple interfaces. The distinction in the examples is just used to highlight its main role in the network.  Therefore, a mesh bridge in this tutorial is a mesh node that simply bridges the mesh network with a WiFi access point  for non-mesh clients, for example, or its LAN ports.</p>
  </li>
  <li><a href="https://en.wikipedia.org/wiki/Gateway_(telecommunications)">Gateway</a>: A network device that translates traffic from one network (LAN) to another (WAN) and here, acts as both a <strong>firewall</strong> and <strong>DHCP server</strong>.  (If there’s more than one DHCP server in the same network, they assign IPs to different ranges, such as <code class="language-plaintext highlighter-rouge">.1-100</code>, <code class="language-plaintext highlighter-rouge">.101-200</code>, and so on.)
    <ul>
      <li><a href="https://openwrt.org/docs/guide-user/base-system/basic-networking">Learn about the OpenWrt network config <strong>/etc/config/network</strong></a></li>
    </ul>
  </li>
  <li>
    <p><a href="https://en.wikipedia.org/wiki/Domain_Name_System">DNS</a>: In brief, a system for translating domain names (e.g., <code class="language-plaintext highlighter-rouge">cgomesu.com</code>) into IP addresses (<code class="language-plaintext highlighter-rouge">185.199.108.153</code>, <code class="language-plaintext highlighter-rouge">185.199.109.153</code>, <code class="language-plaintext highlighter-rouge">185.199.110.153</code>, <code class="language-plaintext highlighter-rouge">185.199.111.153</code>). DNS filtering systems, such as <a href="https://pi-hole.net/">PiHole</a>, work by catching such requests–usually sent through port <code class="language-plaintext highlighter-rouge">53</code>–and checking if the domain is blacklisted or not.  In this tutorial, we will always use an external DNS server, such as <code class="language-plaintext highlighter-rouge">1.1.1.1</code> (Cloudflare) or <code class="language-plaintext highlighter-rouge">8.8.8.8</code> (Google), but if you have your own DNS resolver, feel free to use it instead when configuring your mesh network but then make sure the mesh network/VLAN has access to its address.</p>
  </li>
  <li><a href="https://en.wikipedia.org/wiki/Dynamic_Host_Configuration_Protocol">DHCP</a>: An IP management system that dynamically assigns layer-3 addresses for devices connected to a network. For instance, it might dynamically assign IPs between <code class="language-plaintext highlighter-rouge">192.168.1.0</code> and <code class="language-plaintext highlighter-rouge">192.168.1.255</code> (i.e., <code class="language-plaintext highlighter-rouge">192.168.1.0/24</code>) to any devices connected to LAN. Of note, because this is a network layer protocol, it uses IP addresses, whereas <code class="language-plaintext highlighter-rouge">batman-adv</code> uses MAC addresses because it works at the data link layer (and therefore, <code class="language-plaintext highlighter-rouge">batman-adv</code> actually doesn’t need DHCP and IPs to discover and manage mesh clients but we’re going to use them to make it more intuitive and easier to integrate mesh with non-mesh clients).
    <ul>
      <li><a href="https://openwrt.org/docs/guide-user/base-system/dhcp">Learn about the OpenWrt DNS and DHCP config <strong>/etc/config/dhcp</strong></a></li>
    </ul>
  </li>
  <li><a href="https://en.wikipedia.org/wiki/Firewall_(computing)">Firewall</a>: A network system that monitors and controls network traffic, such as specifying rules for incoming WAN traffic (e.g., <code class="language-plaintext highlighter-rouge">deny all</code>), outgoing LAN traffic (<code class="language-plaintext highlighter-rouge">accept all</code>), geoblocking and IP filtering systems, intrusion prevention/detection systems (<a href="https://suricata-ids.org/">Suricata</a>), and so on.  <a href="https://opnsense.org/">OpenSense</a> and <a href="https://www.pfsense.org/">pfSense</a> are examples of dedicated firewall software. If a mesh node is acting as a mesh gateway, it’s imperative to configure the firewall or your mesh network will likely end up without access to external networks (e.g., WAN) and their services (e.g., DNS servers).
    <ul>
      <li><a href="https://openwrt.org/docs/guide-user/firewall/firewall_configuration">Learn about the OpenWrt firewall config <strong>/etc/config/firewall</strong></a></li>
    </ul>
  </li>
  <li><a href="https://en.wikipedia.org/wiki/Virtual_LAN">VLAN</a>: A <em>virtual</em> LAN that is partitioned and isolated in a network at the layer-2 level.  They are often followed by an integer to differentiate each other (e.g., VLAN 1, VLAN 50) and used to better manage network clients that belong to different groups (e.g., administrators, IoT devices, security cameras, guests).</li>
</ul>

<h2 id="network-topologies">Network topologies</h2>

<!-- Courtesy of embedresponsively.com //-->
<div class="responsive-video-container">

  <iframe src="https://www.youtube-nocookie.com/embed/zbqrNg4C98U" frameborder="0" allowfullscreen=""></iframe>

</div>

<h2 id="mesh-networks">Mesh networks</h2>

<h3 id="what-are-mesh-networks">What are mesh networks?</h3>

<!-- Courtesy of embedresponsively.com //-->
<div class="responsive-video-container">

  <iframe src="https://www.youtube-nocookie.com/embed/tYLU755T6_I" frameborder="0" allowfullscreen=""></iframe>

</div>

<h3 id="where-can-i-learn-more-about-mesh-networking">Where can I learn more about mesh networking?</h3>
<ul>
  <li>Wikipedia articles about <a href="https://en.wikipedia.org/wiki/Mesh_networking">mesh networking</a> and <a href="https://en.wikipedia.org/wiki/Wireless_mesh_network">wireless mesh networks</a></li>
  <li><a href="https://scholar.google.com/scholar?q=mesh+networking">Peer-reviewed papers or books</a></li>
</ul>

<h3 id="routing-protocols">Routing protocols</h3>
<p>There are <a href="https://en.wikipedia.org/wiki/Wireless_mesh_network#Protocols">dozens of algorithms</a> for routing packets in a mesh network.  A few notable ones are the Optimized Link State Routing (OLSR) and the Hybrid Wireless Mesh Protocol (HWMP).</p>

<p>In this tutorial, however, we will cover only one of them, called <a href="https://en.wikipedia.org/wiki/B.A.T.M.A.N."><em>Better Approach to Mobile Adhoc Networking</em></a> (<strong>B.A.T.M.A.N.</strong>), because <a href="https://www.kernel.org/doc/html/latest/networking/batman-adv.html">it has long been incorporated into the Linux Kernel</a> and is thus easily enabled on Linux devices.  It is also a <a href="https://www.open-mesh.org/projects/batman-adv/wiki">fairly well-documented</a> algorithm that <a href="https://www.open-mesh.org/projects/open-mesh/activity">has been continuously improved</a> over the years.  Another noteworthy feature of <code class="language-plaintext highlighter-rouge">batman-adv</code> is its lack of reliance on layer-3 protocols for managing mesh clients because it works at the layer-2 and its ability to create VLANs.  Think of it as if it were a big, smart, virtual switch, in which its VLANs are port-based segmentations.  If you want an interface to use a particular mesh VLAN, just “plug it” into the approriate port of the <code class="language-plaintext highlighter-rouge">batX</code> switch (e.g., bridge <code class="language-plaintext highlighter-rouge">guest</code> and <code class="language-plaintext highlighter-rouge">bat0.2</code> to give the guest network access to the <code class="language-plaintext highlighter-rouge">bat0</code> VLAN ID #2).</p>

<h4 id="batman-adv">batman-adv</h4>
<p>As mentioned before, B.A.T.M.A.N. has gone through multiple changes over the years, which means that there are actually <em>multiple versions of the algorithm</em>. I’ve had a good experience with <a href="https://www.open-mesh.org/projects/batman-adv/wiki/BATMAN_IV"><strong>B.A.T.M.A.N. IV</strong></a> and therefore, the examples here make use of it.  However, you are free to try whatever version you want and even run them in parallel to each other, by assigning a different <code class="language-plaintext highlighter-rouge">batX</code> interface to each version of the algorithm (versions are chosen with <code class="language-plaintext highlighter-rouge">option routing_algo</code> in the <code class="language-plaintext highlighter-rouge">/etc/config/network</code> config file for each enabled <code class="language-plaintext highlighter-rouge">batX</code> interface).</p>

<p>Config-wise, there’s very little to do because the default settings should work very well in most environments.  One exception is when you have multiple gateways in the network to provide high availability, for example, and you might want to let each mesh node know about them and their speeds to better route the mesh traffic.  This requires setting <code class="language-plaintext highlighter-rouge">option gw_mode</code> to <code class="language-plaintext highlighter-rouge">server</code> or <code class="language-plaintext highlighter-rouge">client</code>, for example.  Many other tweaks that are not covered here are <a href="https://www.open-mesh.org/projects/batman-adv/wiki/Doc-overview#Protocol-Documentation">described in their wiki</a>.</p>

<h4 id="batctl">batctl</h4>
<p>Another very cool feature of B.A.T.M.A.N. is the ability to test, debug, monitor, and set settings with the package <a href="https://downloads.open-mesh.org/batman/manpages/batctl.8.html"><code class="language-plaintext highlighter-rouge">batctl</code></a>.  A few noteworthy options:</p>

<ul>
  <li>Ping mesh node/client with its MAC address <code class="language-plaintext highlighter-rouge">f0:f0:00:00:00:00</code>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>batctl p f0:f0:00:00:00:00
</code></pre></div>    </div>
  </li>
  <li><a href="https://linux.die.net/man/8/tcpdump"><code class="language-plaintext highlighter-rouge">tcpdump</code></a> for all mesh traffic in the <code class="language-plaintext highlighter-rouge">bat0</code> interface
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>batctl td bat0
</code></pre></div>    </div>
  </li>
  <li>Prints useful stats for all mesh traffic, such as sent and received bytes
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>batctl s
</code></pre></div>    </div>
  </li>
  <li>Shows the neighboring mesh nodes
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>batctl n
</code></pre></div>    </div>
  </li>
  <li>Displays the gateway servers (<code class="language-plaintext highlighter-rouge">option gw_mode 'server'</code>) in the mesh network
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>batctl gwl
</code></pre></div>    </div>
  </li>
</ul>

<p>It goes without saying that if you want to dive deep into <code class="language-plaintext highlighter-rouge">batman-adv</code>, you should take a good look at <code class="language-plaintext highlighter-rouge">batctl</code>, too.</p>

<p><a href="#" class="btn btn--light-outline btn--small">top</a></p>

<h1 id="hardware">Hardware</h1>
<p>Unless otherwise specified, all mesh nodes used in the various implementations had the following hardware:</p>

<ul>
  <li><strong>Device</strong>: <a href="https://www.tp-link.com/us/home-networking/wifi-router/tl-wr1043nd/">TP-Link TL-WDR4300</a> v1.0 - v1.7
    <ul>
      <li><strong>SoC</strong>: Atheros AR9344</li>
      <li><strong>WLAN Hardware</strong>: Dual-band (Atheros AR9344, Atheros AR9580)</li>
      <li><strong>CPU</strong>: <code class="language-plaintext highlighter-rouge">560 Mhz</code></li>
      <li><strong>Flash memory</strong>: <code class="language-plaintext highlighter-rouge">8 MB</code></li>
      <li><strong>RAM</strong>: <code class="language-plaintext highlighter-rouge">128 MB</code></li>
    </ul>
  </li>
</ul>

<p><a href="/assets/posts/2020-11-24-mesh-networking-openwrt-batman/tplink-tl-wdr4300-front.jpg"><img src="/assets/posts/2020-11-24-mesh-networking-openwrt-batman/tplink-tl-wdr4300-front.jpg" alt="TL-WDR4300 front" class="PostImage" /></a></p>

<p><a href="/assets/posts/2020-11-24-mesh-networking-openwrt-batman/tplink-tl-wdr4300-back.jpg"><img src="/assets/posts/2020-11-24-mesh-networking-openwrt-batman/tplink-tl-wdr4300-back.jpg" alt="TL-WDR4300 back" class="PostImage" /></a></p>

<p>This is a low-end, Atheros-based <em>dual-band</em> router that satisfies the <a href="https://openwrt.org/releases/21.02/notes-21.02.0#increased_minimum_hardware_requirements8_mb_flash_64_mb_ram">minimum hardware requirements imposed by OpenWrt 21</a>–namely, at least <code class="language-plaintext highlighter-rouge">8MB</code> of flash memory and <code class="language-plaintext highlighter-rouge">64MB</code> of RAM.  However, the general ideas presented here should apply to <strong>any wireless device</strong> that meets the following criteria:</p>

<ol>
  <li>Compatible with the latest OpenWRT version. Refer to their <a href="https://openwrt.org/toh/start"><strong>Hardware List</strong></a>;</li>
  <li>
    <p>Has access to a radio that supports the <strong>mesh point</strong> (<strong>802.11s</strong>) mode of operation. If you already have OpenWrt installed on a wireless device, you can type <code class="language-plaintext highlighter-rouge">iw list</code> and search for <code class="language-plaintext highlighter-rouge">mesh point</code> under <strong>Supported interface modes</strong>, or simply check if the following command outputs <code class="language-plaintext highlighter-rouge">* mesh point</code> below the name of a detected radio (e.g., <code class="language-plaintext highlighter-rouge">phy0</code>, <code class="language-plaintext highlighter-rouge">phy1</code>):</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>iw list | grep -ix "^wiphy.*\|^.*mesh point$"
</code></pre></div>    </div>

    <p>If it does, then the associated radio can be configured as a mesh point.</p>
  </li>
</ol>

<p>Now, if you’re looking for devices to buy and experiment on, my suggestion is to look for high-end dual-band wireless routers to allow a better segmentation of the wireless networks.  If you can afford spending more for a mesh node, look for tri-band devices.  Netgear and Linksys have solid options that are compatible with OpenWrt. For example, the Linksys WRT1900AC (v1/v2) dual-band wireless router would make for a good mesh node:</p>

<p><a href="/assets/posts/2020-11-24-mesh-networking-openwrt-batman/linksys-wrt1900ac.jpg"><img src="/assets/posts/2020-11-24-mesh-networking-openwrt-batman/linksys-wrt1900ac.jpg" alt="Linksys WRT1900AC" class="PostImage PostImage--large" /></a></p>

<p>For single-board computer (SBC) fans like me, you can run OpenWrt with most of them and then use a combination of on-board wireless and USB adapter to create a powerful mesh node. <a href="https://shop.solid-run.com/product-category/embedded-computers/marvell-family/clearfog-base-pro/">ClearFog boards</a> with one or two mini PCIe wireless cards would make very good candidates for such a project, for example:</p>

<p><a href="/assets/posts/2020-11-24-mesh-networking-openwrt-batman/clearfog-pro.jpg"><img src="/assets/posts/2020-11-24-mesh-networking-openwrt-batman/clearfog-pro.jpg" alt="ClearFog Pro" class="PostImage PostImage--large" /></a></p>

<p>Of course, you can install OpenWrt on bare metal x86-64 machines (e.g., standard PC or server running Intel/AMD), which will give you lots of options to put together an impressive mesh device. However, if you just want your work/home laptops/PCs to <em>be part of the mesh</em> (i.e., become a mesh node), there are better alternatives than installing OpenWrt as its OS.  For example, you can run OpenWrt with a <a href="https://openwrt.org/docs/guide-user/virtualization/start">virtual machine</a> or as a <a href="https://github.com/openwrt/docker">docker container</a>.  Naturally, it’s also possible to configure <code class="language-plaintext highlighter-rouge">batman-adv</code> on Linux distributions other than OpenWrt, such as Arch, Debian, and Ubuntu.  See <a href="#getting-started-with-batman-adv-on-any-linux-device">Getting started with <code class="language-plaintext highlighter-rouge">batman-adv</code> on any Linux device</a>.</p>

<p>As mentioned before, even if the existing/on-board radio of your SBC/laptop/PC/server does not support the mesh point mode of operation, you can always buy a compatible PCIe card or USB adapter to turn your device into a mesh node and then use the other radio for another purpose.  For example, many <a href="https://www.alfa.com.tw/">Alfa Network</a> adapters can operate in mesh point mode, like the cheap AWUS036NH:</p>

<p><a href="/assets/posts/2020-11-24-mesh-networking-openwrt-batman/AWUS036NH.jpg"><img src="/assets/posts/2020-11-24-mesh-networking-openwrt-batman/AWUS036NH.jpg" alt="Alfa AWUS036NH" class="PostImage" /></a></p>

<p>All that said, most home users will be just fine with a cheapo, used, old, and single-band router.  For a brand reference, TP-Link has good and affordable devices that can be used in a mesh networking project without issues.  If you’re new to this, start from here (small, simple) and think about efficiency over power.  You don’t need to drive a Lamborghini to get a snack at the grocery store. For additional resources, skip to the section called <a href="#useful-hardware-resources">Useful hardware resources</a> down below.</p>

<h2 id="hardware-specific-configurations">Hardware-specific configurations</h2>
<p>Every once in a while, I run into hardware that is capable of operating in <code class="language-plaintext highlighter-rouge">mesh point</code> mode but the default OpenWrt firmware uses a module for the wireless adapter that is loaded with incompatible parameters.  Here is a list of a few of the known ones and their solution.</p>

<h3 id="ath9k-modules">ath9k modules</h3>
<p>If your device uses the <code class="language-plaintext highlighter-rouge">ath9k</code> module, there’s a chance that you’ll need to enable the <code class="language-plaintext highlighter-rouge">nohwcrypt</code> parameter of the module to use the mesh <em>with encryption</em>.  First, however, try without changing the default module parameters.  After rulling out possible typos in the network and wireless configuration files, try the following:</p>
<ol>
  <li>Edit the <code class="language-plaintext highlighter-rouge">/etc/modules.d/ath9k</code> file and add <code class="language-plaintext highlighter-rouge">nohwcrypt=1</code> to it.  If there’s something in the file, use a whitespace to separate parameters.</li>
  <li>Save the file, and <strong>reboot</strong> your device.</li>
  <li>Once the device comes back, check if <code class="language-plaintext highlighter-rouge">nohwcrypt</code> is now enabled by typing
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat /sys/module/ath9k/parameters/nohwcrypt
</code></pre></div>    </div>
    <p>If <code class="language-plaintext highlighter-rouge">nohwcrypt</code> is enabled, the output will be <code class="language-plaintext highlighter-rouge">1</code>; otherwise, it will be <code class="language-plaintext highlighter-rouge">0</code>.</p>
  </li>
  <li>Check your mesh configuration once again and add encryption to your wireless mesh stanza.</li>
</ol>

<ul>
  <li>
    <p>Known affected devices:</p>

    <table>
      <thead>
        <tr>
          <th style="text-align: center">brand</th>
          <th style="text-align: center">model</th>
          <th style="text-align: center">version</th>
          <th style="text-align: center">OpenWrt release</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td style="text-align: center">TP-Link</td>
          <td style="text-align: center">WR-1043-ND</td>
          <td style="text-align: center">1.8</td>
          <td style="text-align: center">19.07</td>
        </tr>
      </tbody>
    </table>
  </li>
</ul>

<h3 id="ath10k-modules">ath10k modules</h3>
<p>I’ve noticed that radio devices that use the <code class="language-plaintext highlighter-rouge">ath10k</code> module and more specifically, the ones using <code class="language-plaintext highlighter-rouge">ath10k-firmware-qca988x-ct</code>, are not able to operate in <code class="language-plaintext highlighter-rouge">mesh point</code> mode by default.  If you check the syslog, you’ll notice that there will be a few messages stating that the <code class="language-plaintext highlighter-rouge">ath10k</code> module must be loaded with <code class="language-plaintext highlighter-rouge">rawmode=1</code> to allow mesh.  However, I’ve tried that before without much success.  Instead, my current recommendation to get <code class="language-plaintext highlighter-rouge">mesh point</code> working with the <strong>QCA988x</strong> is the following (<strong>Internet connection required</strong> to download packages via <code class="language-plaintext highlighter-rouge">opkg</code>):</p>
<ol>
  <li>Remove the <strong>Candela Tech</strong> (<code class="language-plaintext highlighter-rouge">*-ct</code>) modules as follows:
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>opkg remove ath10k-firmware-qca988x-ct kmod-ath10k-ct
</code></pre></div>    </div>
  </li>
  <li>Install the non-ct modules:
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>opkg update &amp;&amp; opkg install ath10k-firmware-qca988x kmod-ath10k
</code></pre></div>    </div>
  </li>
  <li>Reboot your device and then check the status of your mesh network.</li>
</ol>

<ul>
  <li>
    <p>Known affected devices:</p>

    <table>
      <thead>
        <tr>
          <th style="text-align: center">brand</th>
          <th style="text-align: center">model</th>
          <th style="text-align: center">version</th>
          <th style="text-align: center">OpenWrt release</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td style="text-align: center">TP-Link</td>
          <td style="text-align: center">Archer C7</td>
          <td style="text-align: center">2.0</td>
          <td style="text-align: center">19.07</td>
        </tr>
        <tr>
          <td style="text-align: center">TP-Link</td>
          <td style="text-align: center">Archer C7 US</td>
          <td style="text-align: center">2.0</td>
          <td style="text-align: center">19.07</td>
        </tr>
        <tr>
          <td style="text-align: center">TP-Link</td>
          <td style="text-align: center">Archer C7</td>
          <td style="text-align: center">4.0</td>
          <td style="text-align: center">19.07</td>
        </tr>
        <tr>
          <td style="text-align: center">TP-Link</td>
          <td style="text-align: center">Archer C7</td>
          <td style="text-align: center">5.0</td>
          <td style="text-align: center">19.07</td>
        </tr>
      </tbody>
    </table>
  </li>
</ul>

<h2 id="useful-hardware-resources">Useful hardware resources</h2>
<p>These are a few resources that I’ve used in the past that you might find useful when looking for mesh compatible devices:</p>

<ul>
  <li><strong>OpenWrt</strong>:
    <ul>
      <li><a href="https://openwrt.org/toh/buyerguide">Buyers’ Guide</a></li>
      <li><a href="https://openwrt.org/toh/views/toh_extended_all">Extended Table of Hardware</a></li>
    </ul>
  </li>
  <li><strong>Linux Wireless wiki</strong>:
    <ul>
      <li>The wiki has a list of <a href="https://wireless.wiki.kernel.org/en/users/drivers">existing Linux wireless <em>drivers</em></a> that mention whether it supports <code class="language-plaintext highlighter-rouge">mesh point</code> or not.  To search for specific <em>devices</em>, my recommendation is to (a) open the page of a driver that supports mesh (e.g., <a href="https://wireless.wiki.kernel.org/en/users/drivers/ath10k">ath10k</a>), then (b) look for <a href="https://wireless.wiki.kernel.org/en/users/drivers/ath10k#supported_devices">supported devices</a> under it, and finally, (c) go to OpenWrt’s <a href="https://openwrt.org/toh/views/toh_extended_all">Extended Table of Hardware</a> and in <strong>WLAN Hardware</strong>, enter a supported device found on the Linux Wireless wiki (e.g., <code class="language-plaintext highlighter-rouge">QCA9880</code>). This will <a href="https://openwrt.org/toh/views/toh_extended_all?dataflt%5BWLAN+Hardware*%7E%5D=QCA9880">create a filter</a> to show only devices that contain the given hardware and should provide you a starting point for further research.</li>
    </ul>
  </li>
</ul>

<p><a href="#" class="btn btn--light-outline btn--small">top</a></p>

<h1 id="software">Software</h1>
<p>Unless otherwise specified, all mesh nodes were running the following software:</p>

<p><a href="/assets/posts/2020-11-24-mesh-networking-openwrt-batman/openwrt-ssh-welcome.jpg"><img src="/assets/posts/2020-11-24-mesh-networking-openwrt-batman/openwrt-ssh-welcome.jpg" alt="OpenWrt default SSH welcome" class="PostImage PostImage--large" /></a></p>

<ul>
  <li><strong>Operating System</strong>:
    <ul>
      <li><strong>Firmware</strong>: OpenWrt <code class="language-plaintext highlighter-rouge">21.02.0</code>, <code class="language-plaintext highlighter-rouge">r16279-5cc0535800</code></li>
      <li><strong>Linux kernel</strong>: <code class="language-plaintext highlighter-rouge">5.4.143</code></li>
    </ul>
  </li>
  <li><strong>Packages mentioned in the tutorial</strong>:
    <ul>
      <li><a href="https://openwrt.org/packages/pkgdata/batctl-default"><code class="language-plaintext highlighter-rouge">batctl-full</code></a>: 2021.1-1</li>
      <li><a href="https://openwrt.org/packages/pkgdata/kmod-batman-adv"><code class="language-plaintext highlighter-rouge">kmod-batman-adv</code></a>: 5.4.143+2021.1-4</li>
      <li><a href="https://openwrt.org/packages/pkgdata/wpad-mesh-wolfssl"><code class="language-plaintext highlighter-rouge">wpad-mesh-wolfssl</code></a>: 2020-06-08-5a8b3662-35</li>
    </ul>
  </li>
</ul>

<p>To find out the version of all installed packages, type</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>opkg list-installed
</code></pre></div></div>

<p>or if you prefer to filter the output, use grep.  For example, the following will show the version of all installed packages containing <code class="language-plaintext highlighter-rouge">bat</code> (e.g., <code class="language-plaintext highlighter-rouge">batctl</code>, <code class="language-plaintext highlighter-rouge">kmod-batman-adv</code>):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>opkg list-installed | grep bat
</code></pre></div></div>

<p>Huge differences in firmware, kernel, or package versions <em>might</em> make the implementation of a mesh network a little bit different than the way it was explained here.  Of note, devices running the <code class="language-plaintext highlighter-rouge">batman-adv</code> <strong>version 2019.0-2 and older</strong> are certainly incompatible with the instructions found in this tutorial, the reason being that the module was modified after then to better integrate with the <a href="https://openwrt.org/docs/techref/netifd">network interface daemon</a>.  Fortunately, the implementation using old modules is just a simple as with the latest one. <a href="https://www.open-mesh.org/projects/batman-adv/wiki/Batman-adv-openwrt-config#Batman-adv-20190-2-and-older">Check what the B.A.T.M.A.N. wiki has to say about it</a>.  However, it’s worth mentioning that with old batman modules, changes to <code class="language-plaintext highlighter-rouge">/etc/config/network</code> will likely require a reboot instead of simply reloading <code class="language-plaintext highlighter-rouge">/etc/init.d/network</code>.</p>

<p>Also, I’ve noticed that when installing <code class="language-plaintext highlighter-rouge">kmod-batman-adv</code>, the package manager will install a minimal version of <code class="language-plaintext highlighter-rouge">batctl</code>, called <code class="language-plaintext highlighter-rouge">batctl-tiny</code>, that lacks some of the options mentioned here (e.g., <code class="language-plaintext highlighter-rouge">batctl n</code> and <code class="language-plaintext highlighter-rouge">batnctl o</code>).  However, if you install <code class="language-plaintext highlighter-rouge">batctl</code> first and then <code class="language-plaintext highlighter-rouge">kmod-batman-adv</code>, the package manager will preserve <code class="language-plaintext highlighter-rouge">batctl-default</code>, which has most of the <code class="language-plaintext highlighter-rouge">batctl</code> features.  In this tutorial, however, we will use the <code class="language-plaintext highlighter-rouge">batctl-full</code> package that contains all features referred to in the <a href="https://downloads.open-mesh.org/batman/manpages/batctl.8.html"><code class="language-plaintext highlighter-rouge">batctl</code> manual</a>.</p>

<p>Finally, the installation of <code class="language-plaintext highlighter-rouge">wpad-mesh-wolfssl</code> will conflict with the already installed <code class="language-plaintext highlighter-rouge">wpad-basic-wolfssl</code> package (or any other <code class="language-plaintext highlighter-rouge">wpad-basic*</code> package, for that matter).  This means <strong>you have to remove the latter before installing the former</strong>.  To remove the <code class="language-plaintext highlighter-rouge">wpad-basic-wolfssl</code> or any other conflicting <code class="language-plaintext highlighter-rouge">wpad-basic</code> package, simply type</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>opkg remove wpad-basic*
</code></pre></div></div>

<h2 id="vi-text-editor">VI text editor</h2>
<p>The default text editor in a standard OpenWrt image is <a href="https://en.wikipedia.org/wiki/Vi"><strong>vi</strong></a>, which is an old, screen oriented editor that most modern users will find counterintuitive to use.  Fortunately, once you get the hang of it, <code class="language-plaintext highlighter-rouge">vi</code> becomes very easy to use and it becomes a very convenient way of editing config files.  Here’s all that you need to know about using <code class="language-plaintext highlighter-rouge">vi</code> in a terminal:</p>

<p>You can open a file by adding the filename as an argument to <code class="language-plaintext highlighter-rouge">vi</code>, as follows</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi /etc/config/network
</code></pre></div></div>

<p>and if the file does not exist, <code class="language-plaintext highlighter-rouge">vi</code> will create one with that name.</p>

<p>By default, <code class="language-plaintext highlighter-rouge">vi</code> will start in <strong>command mode</strong>.  Such a mode let’s you navigate the file with the arrow keys and use the <em>delete button</em> to delete characters.  (Also, in command mode, you can type <code class="language-plaintext highlighter-rouge">dd</code> to delete entire lines, which is very useful if you need to delete lots of things quickly.)</p>

<p>However, if you need to type characters and have more flexibility to edit the file, you need to tell <code class="language-plaintext highlighter-rouge">vi</code> to enter <strong>insert mode</strong>.  To enter insert mode, type (no need to hit return/enter afterwards)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>i
</code></pre></div></div>

<p>and at the bottom of the screen, you will see that it now shows a <code class="language-plaintext highlighter-rouge">I</code> to indicate that <code class="language-plaintext highlighter-rouge">vi</code> is in insert mode.  You can now type freely and even paste multiple things at once in insert mode.</p>

<p>When you’re done, press the button <strong>Esc</strong> to go back into command mode.  Notice that at the bottom of the screen, now there’s a <code class="language-plaintext highlighter-rouge">-</code> where the <code class="language-plaintext highlighter-rouge">I</code> was, which tells you you’re in command mode once again.</p>

<p>In command mode, you can then <strong>write changes to the file</strong> by typing (followed by return/enter)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>:w
</code></pre></div></div>

<p>Now you’ve saved the file. To quit, type</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>:q
</code></pre></div></div>

<p>Alternatively, you can <em>write and quit</em> by simply typing <code class="language-plaintext highlighter-rouge">:wq</code>.</p>

<p><code class="language-plaintext highlighter-rouge">vi</code> has other commands as well but honestly, that’s pretty much all that you need to know about <code class="language-plaintext highlighter-rouge">vi</code> in order to use in the examples covered here.  Give it a try!</p>

<h3 id="vi-cheat-table">VI cheat table</h3>

<table>
  <thead>
    <tr>
      <th style="text-align: center">mode</th>
      <th style="text-align: center">key/command</th>
      <th style="text-align: center">action</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">command</td>
      <td style="text-align: center"><code class="language-plaintext highlighter-rouge">i</code> key</td>
      <td style="text-align: center">Enter <em>insert</em> mode</td>
    </tr>
    <tr>
      <td style="text-align: center">insert</td>
      <td style="text-align: center"><code class="language-plaintext highlighter-rouge">Esc</code> key</td>
      <td style="text-align: center">Return to <em>command</em> mode</td>
    </tr>
    <tr>
      <td style="text-align: center">command</td>
      <td style="text-align: center"><code class="language-plaintext highlighter-rouge">dd</code> (or hold <code class="language-plaintext highlighter-rouge">d</code> key)</td>
      <td style="text-align: center">Erase entire row</td>
    </tr>
    <tr>
      <td style="text-align: center">command</td>
      <td style="text-align: center"><code class="language-plaintext highlighter-rouge">:w</code> + Enter/Return</td>
      <td style="text-align: center">Write to file</td>
    </tr>
    <tr>
      <td style="text-align: center">command</td>
      <td style="text-align: center"><code class="language-plaintext highlighter-rouge">:q</code> + Enter/Return</td>
      <td style="text-align: center">Quit to terminal</td>
    </tr>
    <tr>
      <td style="text-align: center">command</td>
      <td style="text-align: center"><code class="language-plaintext highlighter-rouge">:q!</code> + Enter/Return</td>
      <td style="text-align: center">Quit without saving changes</td>
    </tr>
    <tr>
      <td style="text-align: center">command</td>
      <td style="text-align: center"><code class="language-plaintext highlighter-rouge">:wq</code> + Enter/Return</td>
      <td style="text-align: center">Write to file and quit</td>
    </tr>
  </tbody>
</table>

<h3 id="alternatives-to-vi">Alternatives to VI</h3>
<p>Now, if you still don’t like to use <code class="language-plaintext highlighter-rouge">vi</code>, you can always transfer files from your laptop/PC to OpenWrt via sftp, for example, or utilities like <a href="https://en.wikipedia.org/wiki/Secure_copy_protocol"><code class="language-plaintext highlighter-rouge">scp</code></a>.</p>

<p><a href="#" class="btn btn--light-outline btn--small">top</a></p>

<h1 id="implementation">Implementation</h1>
<p>In this section, we will see how to configure <strong>four mesh nodes</strong> in <strong>three different network topologies</strong>. More specifically:</p>

<ul>
  <li><strong>Gateway-Bridge</strong>: A mesh network in which one node plays the role of a mesh gateway and another, of a bridge, while the remaining are just mesh nodes.  This is a very typical scenario for a home or small office, for example.</li>
</ul>

<p><a href="/assets/posts/2020-11-24-mesh-networking-openwrt-batman/topo-gateway-bridge.jpg"><img src="/assets/posts/2020-11-24-mesh-networking-openwrt-batman/topo-gateway-bridge.jpg" alt="Topology - Gateway-Bridge" class="PostImage PostImage--large" /></a></p>

<ul>
  <li><strong>Bridge-Bridge</strong>: Two nodes play the role of a bridge, therefore making the mesh network transparent to the external (non-mesh) networks.</li>
</ul>

<p><a href="/assets/posts/2020-11-24-mesh-networking-openwrt-batman/topo-bridge-bridge.jpg"><img src="/assets/posts/2020-11-24-mesh-networking-openwrt-batman/topo-bridge-bridge.jpg" alt="Topology - Bridge-Bridge" class="PostImage PostImage--large" /></a></p>

<ul>
  <li><strong>Gateway-Gateway</strong>: Two nodes play the role of a gateway to provide high-availability to mesh clients/nodes.</li>
</ul>

<p><a href="/assets/posts/2020-11-24-mesh-networking-openwrt-batman/topo-gateway-gateway.jpg"><img src="/assets/posts/2020-11-24-mesh-networking-openwrt-batman/topo-gateway-gateway.jpg" alt="Topology - Gateway-Gateway" class="PostImage PostImage--large" /></a></p>

<p>In all such cases, we will use the <strong>5Ghz</strong> radio exclusively for <em>mesh</em> wireless traffic, while the more widely compatible <strong>2.4Ghz</strong> radio, as well as Ethernet connections, will be left available for <em>non-mesh</em> wireless traffic:</p>

<p><a href="/assets/posts/2020-11-24-mesh-networking-openwrt-batman/segmentation.jpg"><img src="/assets/posts/2020-11-24-mesh-networking-openwrt-batman/segmentation.jpg" alt="Segmentation" class="PostImage PostImage--large" /></a></p>

<p class="notice--info">Segmentation of mesh vs. non-mesh traffic <strong>is not a requirement</strong> but an option that greatly improves performance. If your mesh devices do not support dual-band, simply assign the same radio for both mesh and non-mesh wireless interfaces.</p>

<p>First, however, we will start with the aspects that are common to all topologies, such as planning the mesh network, and the installation and basic configuration of OpenWrt mesh nodes.  Then, we will move to the specifics of each of the aforementioned mesh network topologies.  Finally, we end the section with a slightly more complex scenario to illustrate how to create <strong>mesh VLANs</strong> with <code class="language-plaintext highlighter-rouge">batman-adv</code> and a very brief introduction to using <code class="language-plaintext highlighter-rouge">batman-adv</code> on other Linux distros.</p>

<p><a href="/assets/posts/2020-11-24-mesh-networking-openwrt-batman/topo-mesh-vlans.jpg"><img src="/assets/posts/2020-11-24-mesh-networking-openwrt-batman/topo-mesh-vlans.jpg" alt="Topology - Mesh VLANs" class="PostImage PostImage--large" /></a></p>

<p>Even though the examples show static nodes, <strong>none of the mesh nodes need to be static</strong>. The mesh network and its components can be partially or totally mobile. For example, if some of your nodes are mobile units (e.g., vehicles, drones, robots, cellphones, laptops), they can leave and join the mesh, recreate the mesh elsewhere, join a completely different mesh, and so on.  The routing algorithm (<code class="language-plaintext highlighter-rouge">batman-adv</code>) will automatically (and  seamlessly) take care of changes to the network topology. (But of course, if there’s a single gateway and it does not reach any node, the network is bound to stop working as intended without proper configuration to handle such scenarios.)</p>

<p><a href="/assets/posts/2020-11-24-mesh-networking-openwrt-batman/topo-moving-nodes.gif"><img src="/assets/posts/2020-11-24-mesh-networking-openwrt-batman/topo-moving-nodes.gif" alt="Topology - Moving nodes" class="PostImage PostImage--large" /></a></p>

<h2 id="planning">Planning</h2>
<p>Just like any other type of network, deploying a mesh network–especially over large areas, with dozens of nodes–requires a fair deal of planning; Otherwise, you are bound to experience, for instance, bottlenecks, uneven access point signal quality, and unstable WAN connectivity across the mesh.  Also, features like <strong>high availability</strong> go well beyond the configuration and topology of a mesh network (e.g., power source, whre your WAN connections are coming from, and the hardware you are using all play important roles when it comes to high availability).  Mesh networks are very, very easy to scale but planning is key.</p>

<p><em>Eli the Computer Guy</em> has an old video about mesh networks that goes into things like high availability and bottlenecks.  If that matters to you, take a look. The relevant content <strong>starts at <code class="language-plaintext highlighter-rouge">03:30</code></strong> and <strong>ends at <code class="language-plaintext highlighter-rouge">17:30</code></strong>, approximately.</p>

<!-- Courtesy of embedresponsively.com //-->
<div class="responsive-video-container">

  <iframe src="https://www.youtube-nocookie.com/embed/T7fJwAyALss" frameborder="0" allowfullscreen=""></iframe>

</div>

<p>The examples in this tutorial are simple <em>by design</em>–they were created to illustrate different scenarios in a way that makes it easy to understand what is going on. The idea is to use the examples as templates for more complex implementations.</p>

<h2 id="openwrt-installation-and-initial-configuration">OpenWrt installation and initial configuration</h2>
<p>Now that you have the hardware, the first thing to do is to install OpenWrt.  Flashing a default OpenWrt image onto a <strong>compatible device</strong> is a very <strong>easy and safe procedure</strong> because it’s been tested multiple times.  (For extra safety precautions, you might want to search the web for <code class="language-plaintext highlighter-rouge">your-device</code> + <code class="language-plaintext highlighter-rouge">openwrt</code> to see if there’s any indexed forum post or comment regarding installation issues and bugs, for example.)</p>

<p>If you’re <strong>new to all this</strong>, the folks at OpenWrt were kind enough to provide a plethora of instructions on <a href="https://openwrt.org/docs/guide-user/installation/start">how to install and uninstall OpenWrt</a> and even put together an <a href="https://openwrt.org/docs/guide-user/installation/generic.flashing#installation_checklist"><strong>installation checklist</strong></a>.  At the very least, do the following:</p>

<ol>
  <li>Look for your device’s <strong>model and version</strong> in the <a href="https://openwrt.org/toh/start"><strong>Table of Hardware</strong></a> and open its <strong>Device Page</strong> (e.g., <a href="https://openwrt.org/toh/tp-link/tl-wdr4300_v1">TP-Link TL-WDR4300</a>);</li>
  <li>Double check that the <strong>model and version</strong> match your device’s <strong>model and version</strong> in the <strong>Supported Versions</strong> table;</li>
  <li>In the <strong>Installation</strong> table, you will find a column called <em>Firmware OpenWrt Install URL</em> and another one called <em>Firmware OpenWrt Upgrade URL</em>. If your device is <strong>still running the original firmware</strong>, then download the binary from the <em>Firmware OpenWrt <strong>Install</strong> URL</em> column; otherwise, download the binary from the <em>Firmware OpenWrt <strong>Upgrade</strong> URL</em> column.  Both files should have a <code class="language-plaintext highlighter-rouge">.bin</code> extension;</li>
  <li>Regardless of the binary file downloaded, <a href="https://openwrt.org/docs/guide-quick-start/verify_firmware_checksum"><strong>verify its checksum</strong></a> afterwards;</li>
  <li>Disconnect your laptop/PC from any access point or switch, and connect your laptop/PC directly to the device’s Ethernet port.</li>
  <li>Open your device’s web UI, go to its Settings and/or find the <strong>Firmware Upgrade</strong> option. Then, select the downloaded OpenWrt binary, and let it do its thing. Once it’s done, the device will reboot with OpenWrt installed.</li>
  <li>You should now be able to reach your new OpenWrt device at <code class="language-plaintext highlighter-rouge">192.168.1.1</code> if connected to a LAN port. (Remember that all wireless interfaces are disabled by default, so you can only reach it via cable.)</li>
</ol>

<p class="notice--success">If you followed these steps and successfully flashed the default OpenWrt firmware onto your device, then go ahead and skip to the <a href="#initial-configuration">Initial configuration</a> section.  The remaining part of this section is meant for advanced users who want to customize their image files.</p>

<p>If you’re an <strong>experienced user</strong>, you can use <a href="https://openwrt.org/docs/guide-user/additional-software/imagebuilder">OpenWrt’s Image Builder</a> to create a customized image that contains all the necessary packages and configuration files by default.  This can save you a lot of time by letting you skip either partially or completely the remaining configuration instructions, depending on the level of specification of the <code class="language-plaintext highlighter-rouge">make image</code> build command.</p>

<p>To build a custom image file, first <a href="https://openwrt.org/docs/guide-user/additional-software/imagebuilder#prerequisites">install the dependencies</a> for your Linux distribution.  Afterwards, follow these steps:</p>

<ol>
  <li>Find the target for your device in the device’s OpenWrt page.  For instance, for the <a href="https://openwrt.org/toh/tp-link/tl-wdr4300_v1">TP-Link TL-WDR4300 v1</a>, the target is <em>ath79/generic</em>;</li>
  <li>Navigate to the root of the available targets for the latest version of the OpenWrt 21.02 release (e.g., <a href="https://downloads.openwrt.org/releases/21.02.0/targets/"><code class="language-plaintext highlighter-rouge">21.02.0</code></a>);</li>
  <li>Navigate to the root of your device’s target (e.g., for the TL-WDR4300, that would be <a href="https://downloads.openwrt.org/releases/21.02.0/targets/ath79/"><em>ath79</em></a> &gt; <a href="https://downloads.openwrt.org/releases/21.02.0/targets/ath79/generic/"><em>generic</em></a>);</li>
  <li>Go to the <strong>Supplementary Files</strong> table at the bottom;</li>
  <li>
    <p>Download the image builder <code class="language-plaintext highlighter-rouge">.tar.xz</code> file (e.g., <a href="https://downloads.openwrt.org/releases/21.02.0/targets/ath79/generic/openwrt-imagebuilder-21.02.0-ath79-generic.Linux-x86_64.tar.xz">openwrt-imagebuilder-21.02.0-ath79-generic.Linux-x86_64.tar.xz</a>) and check its hash afterwards:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> sha256sum openwrt-imagebuilder-*.tar.xz
</code></pre></div>    </div>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> 6354c0380a8cdb2c6a7f43449a7f6b3d04c4148478752a90f2af575ee182d2bb  openwrt-imagebuilder-21.02.0-ath79-generic.Linux-x86_64.tar.xz
</code></pre></div>    </div>
  </li>
  <li>
    <p>If everything looks good, extract the image builder:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> tar -xvf openwrt-imagebuilder-*.tar.xz
</code></pre></div>    </div>
  </li>
  <li>
    <p>Enter the image builder directory to start using <code class="language-plaintext highlighter-rouge">make</code> and then search for your device’s <code class="language-plaintext highlighter-rouge">PROFILE</code> name (e.g., <code class="language-plaintext highlighter-rouge">tplink_tl-wdr4300-v1</code>), as follows:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> cd openwrt-imagebuilder-*
 make info
</code></pre></div>    </div>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> tplink_tl-wdr4300-v1:
   TP-Link TL-WDR4300 v1
   Packages: kmod-usb2 kmod-usb-ledtrig-usbport
   hasImageMetadata: 1
   SupportedDevices: tplink,tl-wdr4300-v1 tl-wdr4300
</code></pre></div>    </div>

    <p class="notice--info">For long lists, you might want to filter the output via <code class="language-plaintext highlighter-rouge">grep</code>.  For example, to show only entries that contain <code class="language-plaintext highlighter-rouge">wdr4300</code>, run <code class="language-plaintext highlighter-rouge">make info | grep -i wdr4300</code>.</p>
  </li>
  <li>
    <p>Build customized images for your device’s profile. (See below for a table with a list of specific packages to add and to remove if you want to enable batman mesh support by default.)  For example, to build images for the <strong>TL-WDR4300 (v1)</strong> <em>without</em> pppoe and IPv6 support and <em>with</em> a minimal LuCI and <code class="language-plaintext highlighter-rouge">batman-adv</code> mesh support, run the following <code class="language-plaintext highlighter-rouge">make image</code> command:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> make image PROFILE=tplink_tl-wdr4300-v1 \
   PACKAGES="uhttpd uhttpd-mod-ubus libiwinfo-lua luci-base luci-app-firewall luci-mod-admin-full luci-theme-bootstrap \
   -ppp -ppp-mod-pppoe \
   -ip6tables -odhcp6c -kmod-ipv6 -kmod-ip6tables -odhcpd-ipv6only \
   -wpad-basic-wolfssl wpad-mesh-wolfssl \
   batctl-full kmod-batman-adv" \
   CONFIG_IPV6=n
</code></pre></div>    </div>

    <p class="notice--info">Notice that the prefix <code class="language-plaintext highlighter-rouge">-</code> is meant to inform that the package should be <em>removed</em> from the default image of the chosen <code class="language-plaintext highlighter-rouge">PROFILE</code>. In addition, the inclusion of <code class="language-plaintext highlighter-rouge">CONFIG_IPV6=n</code> is optional and only used here to completely disable the IPv6 configuration in the example.  Other <a href="https://openwrt.org/docs/guide-user/additional-software/saving_space#modifying_build_configuration_variables">build configuration variables</a> are also optional and can be modified by adding them to the <code class="language-plaintext highlighter-rouge">make image</code> command.  For more detailed information, run <code class="language-plaintext highlighter-rouge">make help</code>.</p>

    <p>This will prompt your system to start downloading the required packages and then start building the firmware.  <strong>Be patient</strong> because this operation can take several minutes.</p>
  </li>
  <li>
    <p>Once the builder is done <strong>without any errors</strong>, navigate to the subdirectory <code class="language-plaintext highlighter-rouge">./bin/targets/&lt;target&gt;</code> that contains the built image files, in which <code class="language-plaintext highlighter-rouge">&lt;target&gt;</code> is the device’s target.  For the TL-WDR4300, for instance, the target is <code class="language-plaintext highlighter-rouge">ath79/generic</code>, which means the built files are at <code class="language-plaintext highlighter-rouge">./bin/targets/ath79/generic</code> and you can navigate to it from the image builder root directory as follows:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> cd ./bin/targets/ath79/generic
</code></pre></div>    </div>

    <p class="notice--info">Of note, the <code class="language-plaintext highlighter-rouge">*.manifest</code> file contains a list of installed packages, which is useful if you need to double check which packages a given image contains by default.  The <code class="language-plaintext highlighter-rouge">profiles.json</code> file contains even more detailed information about the built image but it is in json format.  If you have <code class="language-plaintext highlighter-rouge">jq</code> installed, however, you can parse it via <code class="language-plaintext highlighter-rouge">cat profiles.json | jq .</code> to get a more readable version.</p>
  </li>
  <li>
    <p>Personally, I like to copy all generated files to a location outside the image builder.  To create a new location for the built images in your user’s Downloads directory, do as follows (suggested structure is <code class="language-plaintext highlighter-rouge">openwrt-custom-images/&lt;release&gt;/&lt;device&gt;</code>):</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir ~/Downloads/openwrt-custom-images \
  ~/Downloads/openwrt-custom-images/21.02 \
  ~/Downloads/openwrt-custom-images/21.02/tl-wdr4300_v1
</code></pre></div>    </div>

    <p>Then copy all generated files to the new directory outside the image builder:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cp ./* ~/Downloads/openwrt-custom-images/21.02/tl-wdr4300_v1/
</code></pre></div>    </div>

    <p>Now you can safely go back to the root of the image builder directory and run <code class="language-plaintext highlighter-rouge">make clean</code> to delete all generated files.  This is good practice if building multiple images with different features.</p>
  </li>
  <li>From this part forward, the procedure is the same as outlined before for the <strong>default installation</strong>.</li>
</ol>

<p>Lastly, to save additional firmware space and RAM, <a href="https://openwrt.org/docs/guide-user/additional-software/saving_space">follow the OpenWrt recommendation</a> and at the end of the package list, add the following to enable <code class="language-plaintext highlighter-rouge">batman-adv</code> and include support for mesh encryption (e.g., use <code class="language-plaintext highlighter-rouge">sae</code> to authenticate mesh nodes):</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">action</th>
      <th style="text-align: center">package</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">remove mesh encryption conflict</td>
      <td style="text-align: center"><code class="language-plaintext highlighter-rouge">-wpad-basic-wolfssl</code></td>
    </tr>
    <tr>
      <td style="text-align: center">add mesh encryption</td>
      <td style="text-align: center"><code class="language-plaintext highlighter-rouge">wpad-mesh-wolfssl</code></td>
    </tr>
    <tr>
      <td style="text-align: center">add the full batctl</td>
      <td style="text-align: center"><code class="language-plaintext highlighter-rouge">batctl-full</code></td>
    </tr>
    <tr>
      <td style="text-align: center">add batman-adv</td>
      <td style="text-align: center"><code class="language-plaintext highlighter-rouge">kmod-batman-adv</code></td>
    </tr>
  </tbody>
</table>

<h3 id="initial-configuration">Initial configuration</h3>
<p>As mentioned before, we <strong>will not use the web UI</strong> in this tutorial, even if the OpenWrt image you’re using has LuCI installed by default.  Instead, we will access our device and configure it using only <strong>SSH</strong>.  So, open a terminal and <code class="language-plaintext highlighter-rouge">ssh</code> into your OpenWrt device, as follows</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh root@192.168.1.1
</code></pre></div></div>

<p>in which <code class="language-plaintext highlighter-rouge">192.168.1.1</code> is your OpenWrt device’s IP address (that’s usually the case after a fresh install but if it’s different, use the proper IP then). Because this is the first time using the system, you’ll need to set a password for the <code class="language-plaintext highlighter-rouge">root</code> user.  You can do that by typing</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>passwd
</code></pre></div></div>

<p>and following the instructions.  At this point, it’s good practice to label this device (e.g., <code class="language-plaintext highlighter-rouge">node01</code>) and take note of its <strong>MAC address</strong>.  To find out the latter, type</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ip link
</code></pre></div></div>

<p>and keep a record of the device’s name and its MAC address–if there are multiple different addresses, take note of all of them and their interface.</p>

<p>(<em>Optional</em>. <a href="https://openwrt.org/docs/guide-user/security/dropbear.public-key.auth">Configure key-based authentication</a> and <a href="https://openwrt.org/docs/guide-user/base-system/dropbear">disable password login</a>. Reboot and check that <code class="language-plaintext highlighter-rouge">ssh</code> access methods are correctly configured.)</p>

<p class="notice--warning">From this point forward, we will start editing files using <code class="language-plaintext highlighter-rouge">vi</code>.  If you’ve not read the <a href="#vi-text-editor">section about how to use <code class="language-plaintext highlighter-rouge">vi</code></a> yet, this is a good time to do so.</p>

<h3 id="default-config-for-the-hardware">Default config for the hardware</h3>
<p>Regardless of the hardware, <strong>before doing anything related to the mesh network</strong>, always take your time and <strong>study the default configuration</strong> found in <code class="language-plaintext highlighter-rouge">/etc/config/</code>.  For reference, I usually go over the following:</p>

<ul>
  <li>How many Ethernet ports?</li>
  <li>Are they labeled either LAN or WAN or there’s both?</li>
  <li>In <code class="language-plaintext highlighter-rouge">/etc/config/network</code>, how is the router handling multiple Ethernet ports? If there’s both LAN and WAN, how is the router separating LAN from WAN?</li>
  <li>If there is both LAN and WAN, how is the firewall handling them in <code class="language-plaintext highlighter-rouge">/etc/config/firewall</code>? (Probably two zones, LAN and WAN, with LAN-&gt;WAN accept all but WAN-&gt;LAN deny all?)</li>
  <li>In <code class="language-plaintext highlighter-rouge">/etc/config/dhcp</code>, how is the device handling IP addresses?  (Is there a DHCP server for LAN?)</li>
</ul>

<p>And finally, look at the wireless settings (<code class="language-plaintext highlighter-rouge">/etc/config/wireless</code>):</p>

<ul>
  <li>How many radio devices and their names? (e.g., <code class="language-plaintext highlighter-rouge">radio0</code>)</li>
  <li>Configuration-wise, what is the device using by default vs. what is it capable of? (<code class="language-plaintext highlighter-rouge">iw list</code>)</li>
  <li>Is the radio enabled or disabled? (Keep/add <code class="language-plaintext highlighter-rouge">option disabled 1</code> to disable it before configuration; to re-enable, simply comment this line out or set the value to <code class="language-plaintext highlighter-rouge">0</code>.)</li>
  <li>Are there pre-configured wireless access points being broadcast?  If yes, which <code class="language-plaintext highlighter-rouge">option network</code> is it using by default? (Likely <code class="language-plaintext highlighter-rouge">lan</code> or whatever the LAN interface is being called in <code class="language-plaintext highlighter-rouge">/etc/config/network</code>.)</li>
</ul>

<p>For example, many wireless routers have LAN and WAN ports which are handled by a <code class="language-plaintext highlighter-rouge">switch</code> configuration with VLANs enabled to separate LAN from WAN.  Take note of it;  understand what is going on in the config files;  play with them;  then, continue.  Also, take this opportunity to go over the <strong>Device Page</strong> to check if there’s any warnings or special configuration notes.</p>

<p>This understanding is instrumental to the way the device will be configured to play different roles in the mesh network and a good grasp of the device’s default settings will greatly reward you later on.</p>

<h3 id="updating-and-installing-packages">Updating and installing packages</h3>
<p>(<em>Only experienced users</em>: If you used a default image, this is a good opportunity to remove unnecessary packages. See the OpenWrt FAQ for a reference of <a href="https://openwrt.org/faq/which_packages_can_i_safely_remove_to_save_space">safe to remove packages</a>, for example. If this is your first time playing with mesh, leave any unmentioned pkg alone until you get everything working as intended.)</p>

<p>In order to update and install packages, you need to give your device <strong>temporary access to the Internet</strong>.  More often than not, if you have an existing network with access to the Internet on-site, then just connect the device to a router/switch via cable.  If that doesn’t work, go ahead and configure your device to act like a <a href="https://openwrt.org/docs/guide-user/network/wifi/dumbap"><strong>dumb access point</strong></a> first.  You can check that the device has access to the Internet by <code class="language-plaintext highlighter-rouge">ping</code>ing <code class="language-plaintext highlighter-rouge">google.com</code> or <code class="language-plaintext highlighter-rouge">8.8.8.8</code>, as follows</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ping google.com
</code></pre></div></div>

<p>If it all looks good, it’s time to <strong>update the package list</strong>, as follows</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>opkg update
</code></pre></div></div>

<p><em>Optional</em>. Upgrade all installed packages. Type <code class="language-plaintext highlighter-rouge">opkg list-upgradable</code> to find which packages can be upgraded and then <code class="language-plaintext highlighter-rouge">opkg upgrade PKG</code>, in which <code class="language-plaintext highlighter-rouge">PKG</code> is the package name.  If <code class="language-plaintext highlighter-rouge">opkg list-upgradable</code> run into memory issues, try commenting out a few lines in <code class="language-plaintext highlighter-rouge">/etc/opkg/distfeeds.conf</code> and try again. Alternatively, it’s possible to use the following command to automatically upgrade all packages at once, per the <a href="https://openwrt.org/docs/guide-user/additional-software/opkg#examples">opkg openwrt wiki examples</a>:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>opkg list-upgradable | cut -f 1 -d ' ' | xargs opkg upgrade
</code></pre></div></div>
<p><strong>Be careful with mass upgrades though</strong>, especially if you’re running a device with limited memory.  You might end up even bricking your device.</p>

<p>Now, let’s install the mesh-related packages and remove conflicting packages.  First, remove <code class="language-plaintext highlighter-rouge">wpad-basic-wolfssl</code> with</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>opkg remove wpad-basic-wolfssl
</code></pre></div></div>

<p>then install <code class="language-plaintext highlighter-rouge">batctl-full</code>, <code class="language-plaintext highlighter-rouge">batman-adv</code>, and <code class="language-plaintext highlighter-rouge">wpad-mesh-wolfssl</code> with</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>opkg install batctl kmod-batman-adv wpad-mesh-wolfssl
</code></pre></div></div>

<p class="notice--info">It is up to you whether to install <code class="language-plaintext highlighter-rouge">wpad-mesh-wolfssl</code> or <code class="language-plaintext highlighter-rouge">wpad-mesh-openssl</code>. For a detailed description of the main differences, take a look at the <a href="https://www.wolfssl.com/docs/wolfssl-openssl/">wolfSSL documentation</a>.  In brief, wolfSSL was built for embedded systems–such as most consumer routers–and it is lighter and more frequently patched than OpenSSL. OpenSSL is much older and more general purpose.</p>

<p>Make sure there are no error messages and if there are, troubleshoot them before proceeding.</p>

<p>Remove the connection that gave your device temporary access to the Internet.  Then, <strong>reboot</strong> (type <code class="language-plaintext highlighter-rouge">reboot</code> in the terminal) and restart the SSH session with your laptop/PC still connected to the device via cable.</p>

<p class="notice--warning">Depending on your hardware, you might run into issues while trying to make one or multiple radios operate in <code class="language-plaintext highlighter-rouge">mesh point</code> mode, owing to loaded modules and their default parameter values.  Keep a close look at your device’s syslog file (run <code class="language-plaintext highlighter-rouge">logread</code> to output it to the terminal) for kernel related errors.  In addition, take a look at the section <a href="#hardware-specific-configurations">Hardware-specific configurations</a> for any comments related to the module used by your OpenWrt device.</p>

<h2 id="mesh-node-basic-config">Mesh node basic config</h2>
<p>It is time to configure the basics of our mesh network and nodes.  To do so, we will edit multiple files in <code class="language-plaintext highlighter-rouge">/etc/config/</code> but first, let’s find out the capabilities of the detected radios in our wireless device, as follows</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>iw list
</code></pre></div></div>

<p>which will output something like this</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Wiphy phy1
        wiphy index: 1
        max # scan SSIDs: 4
        max scan IEs length: 2261 bytes
        max # sched scan SSIDs: 0
        max # match sets: 0
        Retry short limit: 7
        Retry long limit: 4
        Coverage class: 0 (up to 0m)
        Device supports AP-side u-APSD.
        Device supports T-DLS.
        Available Antennas: TX 0x7 RX 0x7
        Configured Antennas: TX 0x7 RX 0x7
        Supported interface modes:
                 * IBSS
                 * managed
                 * AP
                 * AP/VLAN
                 * monitor
                 * mesh point
                 * P2P-client
                 * P2P-GO
                 * outside context of a BSS
        Band 2:
                Capabilities: 0x11ef
                        RX LDPC
                        HT20/HT40
                        SM Power Save disabled
                        RX HT20 SGI
                        RX HT40 SGI
                        TX STBC
                        RX STBC 1-stream
                        Max AMSDU length: 3839 bytes
                        DSSS/CCK HT40
                Maximum RX AMPDU length 65535 bytes (exponent: 0x003)
                Minimum RX AMPDU time spacing: 8 usec (0x06)
                HT TX/RX MCS rate indexes supported: 0-23
                Frequencies:
                        * 5180 MHz [36] (17.0 dBm)
                        * 5200 MHz [40] (17.0 dBm)
                        * 5220 MHz [44] (17.0 dBm)
                        * 5240 MHz [48] (17.0 dBm)
                        * 5260 MHz [52] (21.0 dBm) (radar detection)
                        * 5280 MHz [56] (21.0 dBm) (radar detection)
                        * 5300 MHz [60] (21.0 dBm) (radar detection)
                        * 5320 MHz [64] (21.0 dBm) (radar detection)
                        * 5500 MHz [100] (21.0 dBm) (radar detection)
                        * 5520 MHz [104] (21.0 dBm) (radar detection)
                        * 5540 MHz [108] (21.0 dBm) (radar detection)
                        * 5560 MHz [112] (21.0 dBm) (radar detection)
                        * 5580 MHz [116] (21.0 dBm) (radar detection)
                        * 5600 MHz [120] (21.0 dBm) (radar detection)
                        * 5620 MHz [124] (21.0 dBm) (radar detection)
                        * 5640 MHz [128] (21.0 dBm) (radar detection)
                        * 5660 MHz [132] (21.0 dBm) (radar detection)
                        * 5680 MHz [136] (21.0 dBm) (radar detection)
                        * 5700 MHz [140] (21.0 dBm) (radar detection)
                        * 5745 MHz [149] (21.0 dBm)
                        * 5765 MHz [153] (21.0 dBm)
                        * 5785 MHz [157] (21.0 dBm)
                        * 5805 MHz [161] (21.0 dBm)
                        * 5825 MHz [165] (21.0 dBm)
        valid interface combinations:
                 * #{ managed } &lt;= 2048, #{ AP, mesh point } &lt;= 8, #{ P2P-client, P2P-GO } &lt;= 1, #{ IBSS } &lt;= 1,
                   total &lt;= 2048, #channels &lt;= 1, STA/AP BI must match, radar detect widths: { 20 MHz (no HT), 20 MHz, 40 MHz }

        HT Capability overrides:
                 * MCS: ff ff ff ff ff ff ff ff ff ff
                 * maximum A-MSDU length
                 * supported channel width
                 * short GI for 40 MHz
                 * max A-MPDU length exponent
                 * min MPDU start spacing
        max # scan plans: 1
        max scan plan interval: -1
        max scan plan iterations: 0
        Supported extended features:
                * [ RRM ]: RRM
                * [ CQM_RSSI_LIST ]: multiple CQM_RSSI_THOLD records
                * [ CONTROL_PORT_OVER_NL80211 ]: control port over nl80211
                * [ TXQS ]: FQ-CoDel-enabled intermediate TXQs
                * [ AIRTIME_FAIRNESS ]: airtime fairness scheduling
                * [ SCAN_RANDOM_SN ]: use random sequence numbers in scans
                * [ SCAN_MIN_PREQ_CONTENT ]: use probe request with only rate IEs in scans
                * [ CAN_REPLACE_PTK0 ]: can safely replace PTK 0 when rekeying
                * [ CONTROL_PORT_NO_PREAUTH ]: disable pre-auth over nl80211 control port support
                * [ DEL_IBSS_STA ]: deletion of IBSS station support
                * [ MULTICAST_REGISTRATIONS ]: mgmt frame registration for multicast
                * [ SCAN_FREQ_KHZ ]: scan on kHz frequency support
                * [ CONTROL_PORT_OVER_NL80211_TX_STATUS ]: tx status for nl80211 control port support
Wiphy phy0
        wiphy index: 0
        max # scan SSIDs: 4
        max scan IEs length: 2257 bytes
        max # sched scan SSIDs: 0
        max # match sets: 0
        Retry short limit: 7
        Retry long limit: 4
        Coverage class: 0 (up to 0m)
        Device supports AP-side u-APSD.
        Device supports T-DLS.
        Available Antennas: TX 0x3 RX 0x3
        Configured Antennas: TX 0x3 RX 0x3
        Supported interface modes:
                 * IBSS
                 * managed
                 * AP
                 * AP/VLAN
                 * monitor
                 * mesh point
                 * P2P-client
                 * P2P-GO
                 * outside context of a BSS
        Band 1:
                Capabilities: 0x11ef
                        RX LDPC
                        HT20/HT40
                        SM Power Save disabled
                        RX HT20 SGI
                        RX HT40 SGI
                        TX STBC
                        RX STBC 1-stream
                        Max AMSDU length: 3839 bytes
                        DSSS/CCK HT40
                Maximum RX AMPDU length 65535 bytes (exponent: 0x003)
                Minimum RX AMPDU time spacing: 8 usec (0x06)
                HT TX/RX MCS rate indexes supported: 0-15
                Frequencies:
                        * 2412 MHz [1] (20.0 dBm)
                        * 2417 MHz [2] (20.0 dBm)
                        * 2422 MHz [3] (20.0 dBm)
                        * 2427 MHz [4] (20.0 dBm)
                        * 2432 MHz [5] (20.0 dBm)
                        * 2437 MHz [6] (20.0 dBm)
                        * 2442 MHz [7] (20.0 dBm)
                        * 2447 MHz [8] (20.0 dBm)
                        * 2452 MHz [9] (20.0 dBm)
                        * 2457 MHz [10] (20.0 dBm)
                        * 2462 MHz [11] (20.0 dBm)
                        * 2467 MHz [12] (20.0 dBm)
                        * 2472 MHz [13] (20.0 dBm)
                        * 2484 MHz [14] (disabled)
        valid interface combinations:
                 * #{ managed } &lt;= 2048, #{ AP, mesh point } &lt;= 8, #{ P2P-client, P2P-GO } &lt;= 1, #{ IBSS } &lt;= 1,
                   total &lt;= 2048, #channels &lt;= 1, STA/AP BI must match, radar detect widths: { 20 MHz (no HT), 20 MHz, 40 MHz }

        HT Capability overrides:
                 * MCS: ff ff ff ff ff ff ff ff ff ff
                 * maximum A-MSDU length
                 * supported channel width
                 * short GI for 40 MHz
                 * max A-MPDU length exponent
                 * min MPDU start spacing
        max # scan plans: 1
        max scan plan interval: -1
        max scan plan iterations: 0
        Supported extended features:
                * [ RRM ]: RRM
                * [ CQM_RSSI_LIST ]: multiple CQM_RSSI_THOLD records
                * [ CONTROL_PORT_OVER_NL80211 ]: control port over nl80211
                * [ TXQS ]: FQ-CoDel-enabled intermediate TXQs
                * [ AIRTIME_FAIRNESS ]: airtime fairness scheduling
                * [ SCAN_RANDOM_SN ]: use random sequence numbers in scans
                * [ SCAN_MIN_PREQ_CONTENT ]: use probe request with only rate IEs in scans
                * [ CAN_REPLACE_PTK0 ]: can safely replace PTK 0 when rekeying
                * [ CONTROL_PORT_NO_PREAUTH ]: disable pre-auth over nl80211 control port support
                * [ DEL_IBSS_STA ]: deletion of IBSS station support
                * [ MULTICAST_REGISTRATIONS ]: mgmt frame registration for multicast
                * [ SCAN_FREQ_KHZ ]: scan on kHz frequency support
                * [ CONTROL_PORT_OVER_NL80211_TX_STATUS ]: tx status for nl80211 control port support
</code></pre></div></div>

<p>Here, we are particularly interested in learning the following:</p>

<ul>
  <li>How many radios there are (<code class="language-plaintext highlighter-rouge">phy0</code>, <code class="language-plaintext highlighter-rouge">phy1</code>);</li>
  <li>The supported <strong>modes of operation</strong> of each radio, and more specifically, that the device is indeed able to operate in <code class="language-plaintext highlighter-rouge">mesh point</code> mode, as shown under <code class="language-plaintext highlighter-rouge">Supported interface modes:</code>;</li>
  <li>The <strong>total number of bands</strong>. In this example, each radio can use only one band but one uses <code class="language-plaintext highlighter-rouge">2.4GHz</code> frequencies (<code class="language-plaintext highlighter-rouge">phy0</code>, <code class="language-plaintext highlighter-rouge">Band 1</code>), while the other uses <code class="language-plaintext highlighter-rouge">5GHz</code> frequencies (<code class="language-plaintext highlighter-rouge">phy1</code>, <code class="language-plaintext highlighter-rouge">Band 2</code>);</li>
  <li>For each band, the <strong>acceptable channels</strong>, as shown under <code class="language-plaintext highlighter-rouge">Frequencies:</code>.</li>
</ul>

<p>With such information, we can now configure our radio devices in <a href="https://openwrt.org/docs/guide-user/network/wifi/basic"><code class="language-plaintext highlighter-rouge">/etc/config/wireless</code></a>, as follows</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi /etc/config/wireless
</code></pre></div></div>

<p>and then edit each <code class="language-plaintext highlighter-rouge">config wifi-device</code> stanza accordingly.  In the TL-WDR4300, there’s two default <code class="language-plaintext highlighter-rouge">config wifi-device</code> stanzas–namely, one for the 2.4GHz radio (called <code class="language-plaintext highlighter-rouge">radio0</code>) and another for the 5GHz radio (<code class="language-plaintext highlighter-rouge">radio1</code>).  After <a href="https://openwrt.org/docs/guide-user/network/wifi/basic">changing and adding a few additional options</a>, mine usually look like the following:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>config wifi-device 'radio0'
        option type 'mac80211'
        option channel '1'
        #option txpower '20'  ##uncomment and edit to override default transmission power in dBm
        option hwmode '11g'
        option path 'platform/ahb/18100000.wmac'
        #option htmode 'HT20'  ##uncomment and edit to override default high throughput mode
        option country 'BR'  ##must match your country code
        option disabled '1'  ##change to 0 to enable it

config wifi-device 'radio1'
        option type 'mac80211'
        option channel '153'  ##all nodes must use the same channel
        #option txpower '21'  ##uncomment and edit to override default transmission power in dBm
        option hwmode '11a'
        option path 'pci0000:00/0000:00:00.0'
        #option htmode 'HT20'  ##uncomment and edit to override default high throughput mode
        option country 'BR'  ##must match your country code
        option disabled '0'  ##change to 1 to disable it
</code></pre></div></div>

<p class="notice--info">The comments in this and other config files are just for educational purpose. Feel free to remove them in your device’s config files.</p>

<p>In this guide, <code class="language-plaintext highlighter-rouge">radio1</code> (5GHz) will be used for the <em>mesh</em> traffic under the channel <code class="language-plaintext highlighter-rouge">153</code>, which means all other mesh nodes must use the <strong>same channel</strong>.  However, <code class="language-plaintext highlighter-rouge">radio0</code> (2.4GHz) will at times be used to create standard wireless access points (WAPs; 802.11b/g/n) for <em>non-mesh</em> clients, which means that none of the other nodes need to use the same channel with this radio.  In fact, it is strongly advised that 2.4GHz WAPs in close proximity should use <strong>different channels</strong>–namely, channels <code class="language-plaintext highlighter-rouge">1</code> (<code class="language-plaintext highlighter-rouge">2401–2423MHz</code> frequency range), <code class="language-plaintext highlighter-rouge">6</code> (<code class="language-plaintext highlighter-rouge">2426–2448MHz</code>), or <code class="language-plaintext highlighter-rouge">11</code> (<code class="language-plaintext highlighter-rouge">2451–2473MHz</code>) because those are non-overlapping channels and therefore, do not interfere with each other.  Because only mesh <em>bridges</em> will make use of <code class="language-plaintext highlighter-rouge">radio0</code>, the configuration indicates that it should be <em>disabled</em> by default.</p>

<p>The segmentation between mesh and non-mesh wireless communication adopted in this guide is best summarized by the following illustration:</p>

<p><a href="/assets/posts/2020-11-24-mesh-networking-openwrt-batman/segmentation.jpg"><img src="/assets/posts/2020-11-24-mesh-networking-openwrt-batman/segmentation.jpg" alt="Segmentation" class="PostImage PostImage--large" /></a></p>

<p>In addition, for <code class="language-plaintext highlighter-rouge">HT20/HT40</code> devices, stick to <code class="language-plaintext highlighter-rouge">HT20</code> if you are deploying the mesh in a crowded area, such as an apartment building; otherwise, the interference might make higher high-throughput (HT) actually less performant.  Finally, remember to edit the <strong>country code</strong> before enabling the radio and <a href="https://en.wikipedia.org/wiki/List_of_WLAN_channels#5_GHz_(802.11a/h/j/n/ac/ax)">follow country regulations</a> when overriding the default transmission power (<code class="language-plaintext highlighter-rouge">option txpower</code>).  More often than not, you should actually <em>decrease</em> the <code class="language-plaintext highlighter-rouge">txpower</code> rather than increase it.  (For related material, see OpenWrt’s articles on <a href="https://openwrt.org/docs/guide-user/network/wifi/transmit.power.limits">Exceeding transmit power limits</a> and <a href="https://openwrt.org/faq/other_transmit_power_issues">Other transmit power issues</a>.)</p>

<p>Comment out or delete any <code class="language-plaintext highlighter-rouge">config wifi-iface</code> automatically generated after a fresh install by adding a <code class="language-plaintext highlighter-rouge">#</code> at the beginning of each line or typing <code class="language-plaintext highlighter-rouge">dd</code>, as follows</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#config wifi-iface 'default_radio0'
#        option device 'radio0'
#        option network 'lan'
#        option mode 'ap'
#        option ssid 'OpenWrt'
#        option encryption 'none'
</code></pre></div></div>

<p>Then, at the end of the file, let’s add a <code class="language-plaintext highlighter-rouge">wifi-iface</code> for the wireless mesh, called <code class="language-plaintext highlighter-rouge">wmesh</code>, as follows</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>config wifi-iface 'wmesh'
        option device 'radio1'  ##must match the name of a wifi-device
        option network 'mesh'  ##mesh stanza in /etc/config/network
        option mode 'mesh'  ##use 802.11s mode
        option mesh_id 'MeshCloud'  ##mesh "ssid"
        option encryption 'sae'  ##https://openwrt.org/docs/guide-user/network/wifi/basic#encryption_modes
        option key 'MeshPassword123'  ##password in plain text
        option mesh_fwding '0'  ##let batman-adv handle routing
        option mesh_ttl '1'  ##time to live in the mesh
        option mcast_rate '24000'  ##routes with a lower throughput rate won't be visible
        option disabled '0'  ##change to 1 to disable it
</code></pre></div></div>

<p>Because all mesh nodes must operate on the same channel, use the same authentication, etc., multiple config options are often dictated by the <strong>“lowest common denominator”</strong> across all mesh nodes–that is, the best possible configuration that will work with <strong>all nodes</strong>, not just the ones with the best hardware and software available.  For example, not all devices will necessarily be able to use SAE because it’s very new and therefore, won’t be able to connect to mesh networks that use it. Instead, you might want to set encryption to something like <code class="language-plaintext highlighter-rouge">psk2+aes</code>, which should be good enough for most devices out there. So, keep that in mind when configuring your mesh nodes.</p>

<p><strong>Save the file</strong> and exit it.</p>

<p>Now we need to configure <a href="https://openwrt.org/docs/guide-user/base-system/basic-networking"><code class="language-plaintext highlighter-rouge">/etc/config/network</code></a> to allow <code class="language-plaintext highlighter-rouge">wmesh</code> to use <code class="language-plaintext highlighter-rouge">batman-adv</code>.  To do so, edit the <code class="language-plaintext highlighter-rouge">network</code> file, as follows</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi /etc/config/network
</code></pre></div></div>

<p>and let’s add an <code class="language-plaintext highlighter-rouge">interface</code> called <code class="language-plaintext highlighter-rouge">bat0</code> at the bottom of the file, as follows:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>config interface 'bat0'
        option proto 'batadv'
        option routing_algo 'BATMAN_IV'
        option aggregated_ogms '1'
        option ap_isolation '0'
        option bonding '0'
        option bridge_loop_avoidance '1'
        option distributed_arp_table '1'
        option fragmentation '1'
        option gw_mode 'off'
        #option gw_sel_class '20'
        #option gw_bandwidth '10000/2000'
        option hop_penalty '30'
        option isolation_mark '0x00000000/0x00000000'
        option log_level '0'
        option multicast_mode '1'
        option multicast_fanout '16'
        option network_coding '0'
        option orig_interval '1000'
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">bat0</code> stanza has options with default values to facilitate fine-tuning later on.  The specifics about each option is derived from the <a href="https://downloads.open-mesh.org/batman/manpages/batctl.8.html">official <code class="language-plaintext highlighter-rouge">batctl</code> manual</a>.  For more details, refer to the <a href="https://www.open-mesh.org/projects/batman-adv/wiki#Protocol-Documentation">Protocol Documentation</a> and more specifically, the <a href="https://www.open-mesh.org/projects/batman-adv/wiki/Tweaking">Tweaking</a> section.</p>

<p class="notice--info">In very nichey cases of highly mobile nodes, it is recommended to disable <code class="language-plaintext highlighter-rouge">aggregated_ogms</code> and lower <code class="language-plaintext highlighter-rouge">orig_interval</code>.</p>

<p>Then, at the bottom of the <code class="language-plaintext highlighter-rouge">/etc/config/network</code> file, let’s add an actual network interface to transport <code class="language-plaintext highlighter-rouge">batman-adv</code> packets, which in our case will be the network used by <code class="language-plaintext highlighter-rouge">wmesh</code> in the <code class="language-plaintext highlighter-rouge">/etc/config/wireless</code> config file, namely <code class="language-plaintext highlighter-rouge">mesh</code>, as follows:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>config interface 'mesh'
        option proto 'batadv_hardif'
        option master 'bat0'
        option mtu '1536'
</code></pre></div></div>

<p>The <a href="https://en.wikipedia.org/wiki/Maximum_transmission_unit">maximum transmission unit (MTU) size</a> should be anything between <code class="language-plaintext highlighter-rouge">1500</code> (usual size for Ethernet connections) and <code class="language-plaintext highlighter-rouge">2304</code> (usual size for WLAN connections).  However, because <code class="language-plaintext highlighter-rouge">batman-adv</code> adds its own header to packets traveling through the wireless mesh network, it is suggested to set a minimum of <code class="language-plaintext highlighter-rouge">1528</code> instead.  For a more detailed discussion, see <a href="https://www.open-mesh.org/projects/batman-adv/wiki/Fragmentation-technical">Fragmentation</a> in the official batman-adv wiki.</p>

<p><strong>Save the file</strong> and exit.</p>

<p>Next, let’s <strong>reboot</strong> the device (type <code class="language-plaintext highlighter-rouge">reboot</code> in the terminal) and once it comes back online, <code class="language-plaintext highlighter-rouge">ssh</code> into it once again because we want to check that our <code class="language-plaintext highlighter-rouge">batman-adv</code> interfaces are up.  To do so, type</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ip link | grep bat0
</code></pre></div></div>
<p>and if the config is right, you should now see <code class="language-plaintext highlighter-rouge">bat0</code> and <code class="language-plaintext highlighter-rouge">wlan1</code> in the output. Similarly, we can use <code class="language-plaintext highlighter-rouge">batctl</code> to show us all active mesh interfaces, as follows</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>batctl if
</code></pre></div></div>

<p>If it all looks good, exit the <code class="language-plaintext highlighter-rouge">ssh</code> session, disconnect your laptop/PC from the wireless device (but keep it running nearby), and <strong>go ahead and configure at least one other node</strong>.  This can be done manually just like you’ve just configured the current node.  However, if your other mesh nodes are identical to the one you have already configured–that is, it is the same brand, model, and it is running the same OpenWrt version–then you can simply <strong>copy the modified files</strong> and then paste them on the <code class="language-plaintext highlighter-rouge">/etc/config/</code> directory of the new device.  To copy all such files from the configured device to your laptop/PC current directory, you can use <code class="language-plaintext highlighter-rouge">scp</code>, as follows:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>scp -r root@192.168.1.1:/etc/config ./
</code></pre></div></div>

<p>which should create a <code class="language-plaintext highlighter-rouge">config</code> dir on your laptop/PC that has all the config files from the already configured device.  Then, once connected to another default OpenWrt device, it’s just a matter of doing the reverse operation, as follows:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
  -r ./config/* root@192.168.1.1:/etc/config/
</code></pre></div></div>

<p class="notice--warning">Because we are starting SSH sessions with different machines that have the same IP address (<code class="language-plaintext highlighter-rouge">192.168.1.1</code>), we can include <code class="language-plaintext highlighter-rouge">-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null</code> to disable checking the <code class="language-plaintext highlighter-rouge">known_hosts</code> file and redirect discovery of the new key to <code class="language-plaintext highlighter-rouge">/dev/null</code> instead of your user’s <code class="language-plaintext highlighter-rouge">known_hosts</code>.  Alternatively, you can manually edit or delete your user’s <code class="language-plaintext highlighter-rouge">known_hosts</code> file, which is usually found at <code class="language-plaintext highlighter-rouge">~/.ssh/known_hosts</code>.</p>

<p>Afterwards, <code class="language-plaintext highlighter-rouge">ssh</code> into one of the configured mesh nodes and type</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>batctl n
</code></pre></div></div>

<p>which will show a table with the interfaces (<code class="language-plaintext highlighter-rouge">wlan1</code>), MAC address of the neighboring mesh nodes, and when each of them was last seen.  Copy the MAC address (e.g., <code class="language-plaintext highlighter-rouge">f0:f0:00:00:00:01</code>) from each neighboring mesh node and ping them through the mesh (using <code class="language-plaintext highlighter-rouge">batctl p</code>) to see if they are all replying, as follows (press Ctrl+C to stop)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>batctl p f0:f0:00:00:00:01
</code></pre></div></div>

<p>which should output something like the following if everything is working fine</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PING f0:f0:00:00:00:01 (f0:f0:00:00:00:01) 20(48) bytes of data
20 bytes from f0:f0:00:00:00:01 icmp_seq=1 ttl=50 time=3.01 ms
20 bytes from f0:f0:00:00:00:01 icmp_seq=2 ttl=50 time=1.71 ms
20 bytes from f0:f0:00:00:00:01 icmp_seq=3 ttl=50 time=1.10 ms
--- f0:f0:00:00:00:01 ping statistics ---
3 packets transmitted, 3 received, 0% packet loss
rtt min/avg/max/mdev = 1.103/1.942/3.008/0.794 ms
</code></pre></div></div>

<p>Pat yourself on the back because you have successfully configured multiple mesh nodes!</p>

<p><strong>Go ahead and configure all your mesh nodes the same way as before</strong> and only then move on to bridges, gateways, and VLAN configs, as described next.</p>

<h2 id="troubleshooting-mesh-issues">Troubleshooting mesh issues</h2>
<p>These are a few tips in case you run into issues when configuring gateways and bridges.</p>

<p>To test node to node connectivity, connect to a mesh node and use</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>batctl p MAC
</code></pre></div></div>

<p>in which <code class="language-plaintext highlighter-rouge">MAC</code> is another node’s MAC address.  If the node does not reply, there’s an issue with <code class="language-plaintext highlighter-rouge">batman-adv</code> or its configuration.  Try rebooting both nodes before doing anything else.</p>

<p>A more powerful tool to see what is going on in the mesh network is the <code class="language-plaintext highlighter-rouge">tcpdump</code> utility for <code class="language-plaintext highlighter-rouge">batman-adv</code>.  To use it, connect to a mesh node and type</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>batctl td batX
</code></pre></div></div>

<p>in which <code class="language-plaintext highlighter-rouge">batX</code> is a <code class="language-plaintext highlighter-rouge">batman-adv</code> interface (usually <code class="language-plaintext highlighter-rouge">bat0</code> but if you have more than one, then <code class="language-plaintext highlighter-rouge">bat1</code>, etc.).  This is quite useful when configuring VLANs because it will show the VLAN ID of each client as well.  In addition, it is possible to specify the VLAN ID in the <code class="language-plaintext highlighter-rouge">td</code> argument to constraint the output to one particular VLAN (e.g., <code class="language-plaintext highlighter-rouge">batctl td bat0.1</code>).  Depending on the scale of your mesh network, you might need to filter the output because things can get wild with <code class="language-plaintext highlighter-rouge">tcpdump</code> really fast.</p>

<p>For more details, see the <a href="https://downloads.open-mesh.org/batman/manpages/batctl.8.html"><code class="language-plaintext highlighter-rouge">batctl</code> manual</a> or type <code class="language-plaintext highlighter-rouge">batctl -h</code> for cli usage information.  Keep in mind that while many options can be set via <code class="language-plaintext highlighter-rouge">batctl</code>, those changes are ephemeral–that is, they won’t survive a reboot.  To make permanent changes, you need to add/edit the respective option in the <code class="language-plaintext highlighter-rouge">/etc/config/network</code> file and <code class="language-plaintext highlighter-rouge">batX</code> stanza.</p>

<p>It is worth mentioning that if you’ve been following my suggestion to name and take note of each device’s MAC address, you can now create a file called <code class="language-plaintext highlighter-rouge">bat-hosts</code> in <code class="language-plaintext highlighter-rouge">/etc/</code> that contains pairs of <code class="language-plaintext highlighter-rouge">MAC address</code> and <code class="language-plaintext highlighter-rouge">name</code>, as follows:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>f0:f0:00:00:00:00 node01
f0:f1:00:00:00:00 node02
f0:f2:00:00:00:00 node03
f0:f3:00:00:00:00 node04
</code></pre></div></div>

<p>This makes it much easier to identify the mesh nodes when issuing a command like <code class="language-plaintext highlighter-rouge">batctl n</code> and other debug tables.  As far as I’m aware, however, you have to create and update such file in each node because such information will just be available to nodes that have a <code class="language-plaintext highlighter-rouge">bat-hosts</code> file.</p>

<p>Finally, as mentioned before, keep an eye on your device’s syslog for errors.  Module related issues are often associated with logged kernel errors (see the section <a href="#hardware-specific-configurations">Hardware-specific configurations</a>) and wpa_supplicant has <a href="https://www.toomanyatoms.com/computer/disconnection_codes.html">multiple mesh-specific error codes</a> to help you debug connectivity issues. The syslog can be inspected via <code class="language-plaintext highlighter-rouge">logread</code>, as follows:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>logread
</code></pre></div></div>

<p>For usage information, type <code class="language-plaintext highlighter-rouge">logread -h</code>.</p>

<h2 id="configuring-common-mesh-networks">Configuring common mesh networks</h2>
<p>Here, we will see how to turn one or two of our configured mesh nodes into either a mesh <strong>bridge</strong> or a mesh <strong>gateway</strong>.  To avoid repetition, the configuration of bridges and gateways is described in more detail in the <a href="#gateway-bridge">first example</a>, and only a few small differences and observations are highlighted afterwards.  In addition, only IPv4 addresses and configurations were used but nothing prohibits the use of IPv6 in a mesh network.</p>

<h3 id="gateway-bridge">Gateway-Bridge</h3>
<p>This first example applies to the following topology:</p>

<p><a href="/assets/posts/2020-11-24-mesh-networking-openwrt-batman/topo-gateway-bridge.jpg"><img src="/assets/posts/2020-11-24-mesh-networking-openwrt-batman/topo-gateway-bridge.jpg" alt="Topology - Gateway-Bridge" class="PostImage PostImage--large" /></a></p>

<p>More specifically, the mesh has access to the WAN (<strong>Network A</strong>) via a <em>gateway device</em> and has a single, private network defined in the <code class="language-plaintext highlighter-rouge">192.168.10.0/24</code> IP range, which is used by both the <strong>mesh network</strong> devices and the <strong>Network B</strong>, non-mesh devices. The latter is enabled by a <em>bridge device</em> that works as an access point for non-mesh clients.</p>

<p>First, let’s configure our <strong>mesh gateway</strong>.</p>

<h4 id="mesh-gateway-configuration">Mesh gateway configuration</h4>
<p>Get one of the <a href="#mesh-node-basic-config">pre-configured mesh nodes</a> that has at the very least two Ethernet ports, a LAN port and a WAN port.  (This, of course, is not required for a gateway device because <a href="https://openwrt.org/docs/guide-user/network/wan/internet.connection">there are multiple ways to connect to WAN</a> but having separate physical ports makes the explanation much simpler to follow.  If that is not your case, just adapt the default configuration for your device accordingly.)</p>

<p class="notice--warning">If you’ve configured this node as a <a href="https://openwrt.org/docs/guide-user/network/wifi/dumbap">dumb access point</a> to temporarily give it access to the Internet while updating and installing packages, undo the configuration before proceeding because we will use both the <code class="language-plaintext highlighter-rouge">firewall</code> and <code class="language-plaintext highlighter-rouge">dhcp</code> config files in the gateway configuration.</p>

<p>Connect your laptop/PC to the mesh node via cable using the LAN port–this way, the mesh node’s IP address should still be <code class="language-plaintext highlighter-rouge">192.168.1.1</code>.  Then, <code class="language-plaintext highlighter-rouge">ssh</code> into the mesh node and let’s take a look at the <code class="language-plaintext highlighter-rouge">/etc/config/network</code>, as follows</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi /etc/config/network
</code></pre></div></div>

<p>At the beginning of the file, there should a bunch of <code class="language-plaintext highlighter-rouge">config interface</code> for <code class="language-plaintext highlighter-rouge">loopback</code>, <code class="language-plaintext highlighter-rouge">lan</code>, and <code class="language-plaintext highlighter-rouge">wan</code>, for example, as well as a default <code class="language-plaintext highlighter-rouge">config device</code> for the <code class="language-plaintext highlighter-rouge">lan</code> bridge, called <code class="language-plaintext highlighter-rouge">br-lan</code>, and.  At the end, of course, there should be the mesh interfaces we previously created for the mesh node, namely <code class="language-plaintext highlighter-rouge">bat0</code> and <code class="language-plaintext highlighter-rouge">mesh</code>.  There are at least two options at this point:</p>

<ol>
  <li>Create an entirely new local network for <code class="language-plaintext highlighter-rouge">bat0</code>, called <code class="language-plaintext highlighter-rouge">default</code>, at the expense of additional <code class="language-plaintext highlighter-rouge">dhcp</code> and <code class="language-plaintext highlighter-rouge">firewall</code> configuration;</li>
  <li>Or use the original <code class="language-plaintext highlighter-rouge">lan</code> network by simply bridging <code class="language-plaintext highlighter-rouge">bat0</code> at the <code class="language-plaintext highlighter-rouge">config device</code> <code class="language-plaintext highlighter-rouge">br-lan</code> stanza, as follows:
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> config device                             
         option name 'br-lan'
         option type 'bridge'
         list ports 'eth0.1'  ##edit according to your device
         list ports 'bat0'
</code></pre></div>    </div>
  </li>
</ol>

<p>While the latter option is much easier than the former, we will choose the first here (i.e., create a new local network from the ground up) because it makes this tutorial compatible with multiple devices (switched or switchless) and it allows us to keep the original <code class="language-plaintext highlighter-rouge">lan</code> (<code class="language-plaintext highlighter-rouge">192.168.1.0/24</code>) as a management/debugging network.  (Later on, we will see how to bridge the original <code class="language-plaintext highlighter-rouge">lan</code> with any <code class="language-plaintext highlighter-rouge">bat0</code> VLAN, for example, so the original <code class="language-plaintext highlighter-rouge">lan</code> becomes accessible to the mesh as well.  For now, keep it simple.)</p>

<p>At the bottom of the <code class="language-plaintext highlighter-rouge">/etc/config/network</code> file, let’s add the following two stanzas:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>config device                             
        option name 'br-default'
        option type 'bridge'
        list ports 'bat0'
                                      
config interface 'default'
        option device 'br-default'
        option proto 'static'
        option ipaddr '192.168.10.1'  ##static address on the new 192.168.10.0/24 network pool
        option netmask '255.255.255.0'
        list dns '1.1.1.1'  ##comment out to enable cloudflare dns
        list dns '8.8.8.8'  ##comment out to disable google dns
</code></pre></div></div>

<p>The first stanza (<code class="language-plaintext highlighter-rouge">config device</code>) creates a <strong>bridge</strong> (layer 2) for the <code class="language-plaintext highlighter-rouge">default</code> network, while the second stanza (<code class="language-plaintext highlighter-rouge">config interface 'default'</code>) creates the proper <code class="language-plaintext highlighter-rouge">default</code> <strong>network</strong> (layer 3) at the <code class="language-plaintext highlighter-rouge">192.168.10.0/24</code> pool, then sets a static IP address for this device at <code class="language-plaintext highlighter-rouge">192.168.10.1</code> and broadcasts to any client that they should use the external DNS servers <code class="language-plaintext highlighter-rouge">1.1.1.1</code> or <code class="language-plaintext highlighter-rouge">8.8.8.8</code>.</p>

<p><strong>Save the file</strong> and exit it.</p>

<p>Next, let’s edit the <a href="https://openwrt.org/docs/guide-user/base-system/dhcp"><code class="language-plaintext highlighter-rouge">/etc/config/dhcp</code></a> config to run a DHCP server on the new interface, as follows</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi /etc/config/dhcp
</code></pre></div></div>

<p>and at the end of the file, add the following</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>config dhcp 'default'
        option interface 'default'
        option start '50'  ##start leasing at addr 192.168.10.50
        option limit '100'  ##max leases, so for 100, leased addr goes from .50 to .149
        option leasetime '6h'
        option ra 'server'
</code></pre></div></div>

<p><strong>Save the file</strong> and exit it.</p>

<p>Finally, let’s edit the <a href="https://openwrt.org/docs/guide-user/firewall/firewall_configuration"><code class="language-plaintext highlighter-rouge">/etc/config/firewall</code></a> config.  Many things that can be done at the firewall level and for this reason, it’s often the most overwhelming part of the configuration.  Fortunately, in our case, all that we need to do here is simply <strong>copy</strong> the original <code class="language-plaintext highlighter-rouge">lan</code> config for the new <code class="language-plaintext highlighter-rouge">default</code>.  That is, anything that has <code class="language-plaintext highlighter-rouge">lan</code> we will</p>

<ol>
  <li>copy the related config;</li>
  <li>paste it immediately below the equivalent <code class="language-plaintext highlighter-rouge">lan</code> config;</li>
  <li>and then change <code class="language-plaintext highlighter-rouge">lan</code> for <code class="language-plaintext highlighter-rouge">default</code> in the new config.</li>
</ol>

<p>Start by editing the <code class="language-plaintext highlighter-rouge">firewall</code> config file with <code class="language-plaintext highlighter-rouge">vi</code>, as follows</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi /etc/config/firewall
</code></pre></div></div>

<p>then the first set of configs we will add (immediately below the equivalent <code class="language-plaintext highlighter-rouge">lan</code> config) is the <strong>zone</strong> settings, namely</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>config zone
        option name     default
        list network    'default'
        option input    ACCEPT
        option output   ACCEPT
        option forward  ACCEPT
</code></pre></div></div>

<p>the second set of configs will be for the <strong>forwarding</strong> settings, namely</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>config forwarding
        option src   default
        option dest  wan
</code></pre></div></div>

<p>and <strong>that is it!</strong></p>

<p><em>Optional</em>. At the end of the <code class="language-plaintext highlighter-rouge">firewall</code> config file, there’s a bunch of examples that you could use as template for more avdanced usage of this device’s firewall.  Feel free to play around with them <strong>once you get everything up and running</strong>.</p>

<p><strong>Save the file</strong> and exit it.</p>

<p><em>Optional</em>. Because we’re not going to use IPv6, I suggest (a) disabling <code class="language-plaintext highlighter-rouge">odhcpd</code> altogether (run <code class="language-plaintext highlighter-rouge">/etc/init.d/odhcpd stop &amp;&amp; /etc/init.d/odhcpd disable</code>) and (b) comment out any related IPv6 configuration in the files we just edited as well (e.g., remove configuration and references to <code class="language-plaintext highlighter-rouge">wan6</code>).</p>

<p><strong>Reboot</strong> the device and connect the <strong>WAN</strong> cable to the device’s <strong>WAN Ethernet port</strong>.</p>

<p>Once the device comes back online, <code class="language-plaintext highlighter-rouge">ssh</code> into it. Then, let’s check the new configuration.  First, type</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ip a
</code></pre></div></div>

<p>and as before, there should be <code class="language-plaintext highlighter-rouge">bat0</code> and <code class="language-plaintext highlighter-rouge">wlan1</code> interfaces, but now, your gateway device should have the static IP <code class="language-plaintext highlighter-rouge">192.168.10.1</code> in the new <code class="language-plaintext highlighter-rouge">192.168.10.0/24</code> network under <code class="language-plaintext highlighter-rouge">br-default</code>.</p>

<p>Similarly, because we preserved the original <code class="language-plaintext highlighter-rouge">lan</code> configuration, the device will continue to have the static IP <code class="language-plaintext highlighter-rouge">192.168.1.1</code> in the <code class="language-plaintext highlighter-rouge">192.168.1.0/24</code> network under <code class="language-plaintext highlighter-rouge">br-lan</code>.  This means it should always be reachable at its original IP address with an Ethernet cable directly connected to one of its LAN Ethernet ports.</p>

<p>If you <strong>don’t see the static IP on the new network</strong>, then review the files we have just configured because there’s likely a misconfiguration.  Don’t expect to get things working until you fix this issue.</p>

<h4 id="mesh-bridge-configuration">Mesh bridge configuration</h4>
<p>The configuration of a mesh bridge is much simpler than of a mesh gateway because contrary to the gateway config, our mesh bridge doesn’t require the use of a DHCP server and firewall.  In fact, both services will be disabled in a mesh bridge and instead, the ony thing we will do is join interfaces to make them look like a single one to any connected device.</p>

<p>As before, get one of the other <a href="#mesh-node-basic-config">pre-configured mesh nodes</a> and to start things off, we will configure it as a <a href="https://openwrt.org/docs/guide-user/network/wifi/dumbap">dumb access point</a>.  Follow the instructions in the OpenWrt documentation, except for the following when configuring the original <code class="language-plaintext highlighter-rouge">lan</code> interface:</p>

<ul>
  <li>Add <code class="language-plaintext highlighter-rouge">bat0</code> to a new <code class="language-plaintext highlighter-rouge">list ports</code> entry in the bridge stanza used by the <code class="language-plaintext highlighter-rouge">lan</code> interface, namely <code class="language-plaintext highlighter-rouge">br-lan</code>;</li>
  <li>Set a static IP for the device on the <code class="language-plaintext highlighter-rouge">192.168.10.0/24</code> network, such as <code class="language-plaintext highlighter-rouge">192.168.10.10</code>, pointing to our configured gateway at <code class="language-plaintext highlighter-rouge">192.168.10.1</code>;</li>
  <li>After all is done, rename every <code class="language-plaintext highlighter-rouge">lan</code> entry for <code class="language-plaintext highlighter-rouge">default</code> to make it consistent with the gateway configuration.  This, of course, is optional.</li>
</ul>

<p>Once done, the configuration of the original <code class="language-plaintext highlighter-rouge">lan</code> interface and its <code class="language-plaintext highlighter-rouge">br-lan</code> bridge, which are now called <code class="language-plaintext highlighter-rouge">default</code> and <code class="language-plaintext highlighter-rouge">br-default</code>, respectively, should look something like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>config device
        option name 'br-default'
        option type 'bridge'
        list ports 'eth0.1'
        list ports 'bat0'

config interface 'default'
        option device 'br-default'
        option proto 'static'
        option ipaddr '192.168.10.10'
        option netmask '255.255.255.0'
        option gateway '192.168.10.1'
        option dns '192.168.10.1'
</code></pre></div></div>

<p>After applying this configuration, it will let any <strong><em>non-mesh</em> clients</strong> to join the mesh <strong>via Ethernet cable</strong>–that is, by connecting a cable to one of the <strong>LAN ports</strong> of the mesh bridge device.  As long as the gateway is reachable, everything should work like a standard network, you could use the device’s own switch or connect the device to a switch and manage things there, and so on.</p>

<p><strong>Save the file</strong> and exit it.</p>

<p>Similarly, you can create a <strong>wireless access point</strong> (WAP) for <em>non-mesh</em> clients, and the instructions in the <a href="https://openwrt.org/docs/guide-user/network/wifi/dumbap"><strong>dumb access point</strong> documentation</a> will work just fine because it uses a network that is bridged with our mesh–namely, the original <code class="language-plaintext highlighter-rouge">lan</code>.  To avoid confusion, make sure to use <strong>a different SSID</strong> for the WAP(s) than the <code class="language-plaintext highlighter-rouge">mesh_id</code> used for the mesh.  In addition, use <strong>a different radio</strong> for the WAP(s) and set them to operate on <strong>different channels</strong>.  If that is not possible, that is probably okay for most home users but keep in mind that node hoping will start affecting performance quite noticeably.</p>

<p>(<em>Optional</em>.) To illustrate, let’s create a simple 2.4GHz WAP for your home devices that will make use of the <code class="language-plaintext highlighter-rouge">default</code> network.  This can be done by editing the <code class="language-plaintext highlighter-rouge">/etc/config/wireless</code> file as follows:</p>

<ul>
  <li>
    <p>In the 2.4GHz radio stanza (<code class="language-plaintext highlighter-rouge">radio0</code>), set <code class="language-plaintext highlighter-rouge">option disabled</code> to <code class="language-plaintext highlighter-rouge">'0'</code> to <strong>enable</strong> it:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> config wifi-device 'radio0'
         option type 'mac80211'
         option channel '1'
         #option txpower '20'
         option hwmode '11g'
         option path 'platform/ahb/18100000.wmac'
         #option htmode 'HT20'
         option country 'BR'
         option disabled '0'
</code></pre></div>    </div>
  </li>
  <li>
    <p>At the bottom of the file, create a new <code class="language-plaintext highlighter-rouge">config wifi-interface 'whome'</code> stanza that configures an access point (<code class="language-plaintext highlighter-rouge">option mode 'ap'</code>) that will make use of the <code class="language-plaintext highlighter-rouge">default</code> network. It should look similar to the following one when done:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> config wifi-iface 'whome'
         option device 'radio0'
         option network 'default'
         option mode 'ap'
         option ssid 'HomeWAP'  ##edit it
         option encryption 'psk2+aes'  ##https://openwrt.org/docs/guide-user/network/wifi/basic#encryption_modes
         option key 'MyStrongPassword123'  ##edit it
         option disabled '0'
</code></pre></div>    </div>
  </li>
  <li>
    <p><strong>Save the file</strong> and exit.</p>
  </li>
</ul>

<p>Finally, in the terminal, make sure to disable <code class="language-plaintext highlighter-rouge">dnsmasq</code>, <code class="language-plaintext highlighter-rouge">odhcpd</code>, and the <code class="language-plaintext highlighter-rouge">firewall</code>, as follows</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/etc/init.d/dnsmasq stop &amp;&amp; /etc/init.d/dnsmasq disable 
/etc/init.d/odhcpd stop &amp;&amp; /etc/init.d/odhcpd disable
/etc/init.d/firewall stop &amp;&amp; /etc/init.d/firewall disable
</code></pre></div></div>

<p><strong>Reboot</strong> your device and on your laptop/PC, <strong>disable networking</strong> altogether to force it to get a new IP from the bridge when it comes back online–alternatively, just disconnect the Ethernet cable.</p>

<p>Once the bridge is back online–wait at least a minute or two to give it enough time to connect to the mesh first–<strong>re-enable networking</strong> on your laptop/PC (or reconnect the Ethernet cable) and it should receive an IP addr from our mesh gateway in the <code class="language-plaintext highlighter-rouge">192.168.10.0/24</code> network (on a Linux distro, type <code class="language-plaintext highlighter-rouge">ip a</code> or <code class="language-plaintext highlighter-rouge">ip addr</code> or <code class="language-plaintext highlighter-rouge">ifconfig</code>), the bridge node should now be reachable at <code class="language-plaintext highlighter-rouge">192.168.10.10</code>, and you should be able to access the Internet from your laptop/PC through the mesh (try <code class="language-plaintext highlighter-rouge">ping google.com</code>, for example).</p>

<p>If something doesn’t work, review the config files mentioned here and then go over the ones for the gateway, reboot all mesh nodes (gateway first, then nodes, then bridge) and test again.</p>

<h3 id="bridge-bridge">Bridge-Bridge</h3>
<p>This second example applies to the following topology:</p>

<p><a href="/assets/posts/2020-11-24-mesh-networking-openwrt-batman/topo-bridge-bridge.jpg"><img src="/assets/posts/2020-11-24-mesh-networking-openwrt-batman/topo-bridge-bridge.jpg" alt="Topology - Bridge-Bridge" class="PostImage PostImage--large" /></a></p>

<p>Contrary to the first example, there’s no mesh gateway device and as such, this topology could be used to extend an already existing private network (Networks A and B) over the wireless mesh (all defined in the <code class="language-plaintext highlighter-rouge">192.168.10.0/24</code> IP range).  However, to make matters simple, we will assume that <strong>the existing network has a gateway/firewall</strong> in either Network A or B that can be found at the IP addr <code class="language-plaintext highlighter-rouge">192.168.10.1</code>, and <strong>there’s a DHCP server being advertised on the network</strong>.  (If your existing Networks A and B are not defined in the <code class="language-plaintext highlighter-rouge">192.168.10.0/24</code> IP range, just edit your previous config files accordingly and the mesh network will follow your existing network instead.)</p>

<p>Config-wise, the mesh bridges in this topology are configured exactly <a href="#mesh-bridge-configuration">as in the first example</a>, except for the following differences in the configuration of the <code class="language-plaintext highlighter-rouge">/etc/config/network</code> config file:</p>

<ul>
  <li>
    <p><strong>Each mesh bridge</strong> should have a different static IP address in the <code class="language-plaintext highlighter-rouge">default</code> interface, as indicated by <code class="language-plaintext highlighter-rouge">option ipaddr</code>.  For example, the first mesh bridge will have <code class="language-plaintext highlighter-rouge">option ipaddr '192.168.10.10'</code>, while the second mesh bridge will have <code class="language-plaintext highlighter-rouge">option ipaddr '192.168.10.11'</code>;</p>
  </li>
  <li>
    <p>The <code class="language-plaintext highlighter-rouge">option gateway '192.168.10.1'</code> in the <code class="language-plaintext highlighter-rouge">default</code> stanza must match an existing gateway on either Network A or B, and similarly, <code class="language-plaintext highlighter-rouge">option dns '192.168.10.1'</code> must point to a valid DNS resolver or forwarder;</p>
  </li>
  <li>
    <p>As mentioned before, if your existing Networks A and B are not defined in the <code class="language-plaintext highlighter-rouge">192.168.10.0/24</code> IP range, then just edit the config file accordingly.</p>
  </li>
</ul>

<h3 id="gateway-gateway">Gateway-Gateway</h3>
<p>The third and final example applies to the following topology:</p>

<p><a href="/assets/posts/2020-11-24-mesh-networking-openwrt-batman/topo-gateway-gateway.jpg"><img src="/assets/posts/2020-11-24-mesh-networking-openwrt-batman/topo-gateway-gateway.jpg" alt="Topology - Gateway-Gateway" class="PostImage PostImage--large" /></a></p>

<p>Specifically, there’s only one private network (mesh, defined in the <code class="language-plaintext highlighter-rouge">192.168.10.0/24</code> IP range) and notably, <strong>two</strong> mesh gateways.  This provides “high availability” of the Internet connection to mesh nodes and surprisingly enough, the configuration of each mesh gateway is <a href="#mesh-gateway-configuration">just like in the first example</a>, with the following exceptions</p>

<ul>
  <li>
    <p>Like in the <a href="#bridge-bridge">bridge-bridge example</a>, we must assign different static IP addresses to <strong>each</strong> mesh gateway.  This is done by editing the <code class="language-plaintext highlighter-rouge">/etc/config/network</code> config file, and in the <code class="language-plaintext highlighter-rouge">default</code> interface configuration, add a different IP addr next to the <code class="language-plaintext highlighter-rouge">option ipaddr</code> option.  For example, the first mesh gateway will have <code class="language-plaintext highlighter-rouge">option ipaddr '192.168.10.1'</code>, while the second mesh gateway will have <code class="language-plaintext highlighter-rouge">option ipaddr '192.168.10.2'</code>.</p>
  </li>
  <li>
    <p>Because we will now run <strong>two</strong> DHCP servers on <strong>the same network</strong>, we need to find a way of avoiding conflicts when assigning an IP address to new clients.  The easiest way of doing that is by assigning <strong>different intervals</strong> to each DHCP server running on the same network.  In OpenWrt, this is done by editing the <code class="language-plaintext highlighter-rouge">/etc/config/dhcp</code> config file, and in the <code class="language-plaintext highlighter-rouge">default</code> DHCP configuration, we add a different starting point next to the <code class="language-plaintext highlighter-rouge">option start</code> option.  For example, while the DHCP server running on the first gateway will have <code class="language-plaintext highlighter-rouge">option start '50'</code>, the DHCP server running on the second gateway will have <code class="language-plaintext highlighter-rouge">option start '150'</code> instead.  This way, the first DHCP server leases addresses from <code class="language-plaintext highlighter-rouge">192.168.10.50</code> to <code class="language-plaintext highlighter-rouge">.149</code>, whereas the second leases addresses from <code class="language-plaintext highlighter-rouge">192.168.10.150</code> to <code class="language-plaintext highlighter-rouge">.249</code>.</p>
  </li>
  <li>
    <p>In the <code class="language-plaintext highlighter-rouge">bat0</code> interface config of the <code class="language-plaintext highlighter-rouge">/etc/config/network</code> config file, we can now enable the <code class="language-plaintext highlighter-rouge">option gw_mode 'server'</code> and specify the WAN connection speed with <code class="language-plaintext highlighter-rouge">option gw_bandwidth '10000/2000'</code>, as follows:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> config interface 'bat0'
         option proto 'batadv'
         option routing_algo 'BATMAN_IV'
         option aggregated_ogms '1'
         option ap_isolation '0'
         option bonding '0'
         option bridge_loop_avoidance '1'
         option distributed_arp_table '1'
         option fragmentation '1'
         option gw_mode 'server'
         #option gw_sel_class '20'
         option gw_bandwidth '10000/2000'  ##download/upload in kbps
         option hop_penalty '30'
         option isolation_mark '0x00000000/0x00000000'
         option log_level '0'
         option multicast_mode '1'
         option multicast_fanout '16'
         option network_coding '0'
         option orig_interval '1000'
</code></pre></div>    </div>

    <p>Similarly, now in each other <strong>mesh node</strong> (non-gateway devices), we set the <code class="language-plaintext highlighter-rouge">option gw_mode</code> to <code class="language-plaintext highlighter-rouge">'client'</code> instead of <code class="language-plaintext highlighter-rouge">'off'</code> and enable selection options, as follows:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    config interface 'bat0'
         option proto 'batadv'
         option routing_algo 'BATMAN_IV'
         option aggregated_ogms '1'
         option ap_isolation '0'
         option bonding '0'
         option bridge_loop_avoidance '1'
         option distributed_arp_table '1'
         option fragmentation '1'
         option gw_mode 'client'
         option gw_sel_class '20'  ##set to 1 for fast connection policy (BATMAN_IV)
         #option gw_bandwidth '10000/2000'
         option hop_penalty '30'
         option isolation_mark '0x00000000/0x00000000'
         option log_level '0'
         option multicast_mode '1'
         option multicast_fanout '16'
         option network_coding '0'
         option orig_interval '1000'
</code></pre></div>    </div>

    <p>This way, we can make each mesh node aware of the two gateways on the network (and their speeds) to better route mesh traffic.</p>
  </li>
</ul>

<p>To learn more about how <code class="language-plaintext highlighter-rouge">batman-adv</code> handles multiple gateways, read the official <a href="https://www.open-mesh.org/projects/batman-adv/wiki/Gateways">Gateway documentation</a>.</p>

<h2 id="mesh-vlans">Mesh VLANs</h2>
<p>You don’t need to configure VLANs in order to use <code class="language-plaintext highlighter-rouge">batman-adv</code> but it is one of its best features.  In brief, this is a way of using <strong>our already configured</strong> wireless mesh network to route traffic <strong>to/from multiple and all networks</strong> in a secure, isolated way (as far as VLANs go).  No need for additional hardware–the combination of OpenWrt and <code class="language-plaintext highlighter-rouge">batman-adv</code> turns even cheap wireless hardware into powerful virtual switches.  It’s just a matter of tagging the additional (and virtual) networks instead of using the untagged <code class="language-plaintext highlighter-rouge">bat0</code> (or similarly, in a port-based analogy, “plugging” standard interfaces into different ports of our <code class="language-plaintext highlighter-rouge">bat0</code> switch).  This is a fairly advanced topic but surprisingly easy to incorporate to our existing <code class="language-plaintext highlighter-rouge">batman-adv</code> configuration.</p>

<p>Consider, for example, the following network</p>

<p><a href="/assets/posts/2020-11-24-mesh-networking-openwrt-batman/topo-mesh-vlans.jpg"><img src="/assets/posts/2020-11-24-mesh-networking-openwrt-batman/topo-mesh-vlans.jpg" alt="Topology - Mesh VLANs" class="PostImage PostImage--large" /></a></p>

<p>There’s a single gateway device that provides WAN access to the mesh and Networks B, C, and D, which are all private networks defined in different IP ranges. In addition, all the Networks B, C, and D traffic should go via <strong>any</strong> mesh node in the mesh network while keeping them <strong>isolated from each other</strong>.  To make it easier to remember and distinguish each private network, let’s call</p>

<ul>
  <li>Network <strong>B</strong> by <code class="language-plaintext highlighter-rouge">iot</code> network (<code class="language-plaintext highlighter-rouge">192.168.20.0/24</code>);</li>
  <li>Network <strong>C</strong> by <code class="language-plaintext highlighter-rouge">guest</code> network (<code class="language-plaintext highlighter-rouge">192.168.50.0/24</code>);</li>
  <li>and Network <strong>D</strong> by <code class="language-plaintext highlighter-rouge">default</code> network (<code class="language-plaintext highlighter-rouge">192.168.10.0/24</code>).</li>
</ul>

<p>To implement such a mesh network with VLANs, we’re going to follow very similar steps to <a href="#gateway-bridge">the first example of a gateway-bridge mesh network</a>, except for the following:</p>

<ul>
  <li>We will have two additional bridges in the network–that is, one for each mesh VLAN, for a total of three bridges. This is not a necessity but a matter of convenience to keep the example simple. The same bridge device can definitely bridge more than one mesh VLAN;</li>
  <li>In the gateway device, we will create VLAN IDs for the <code class="language-plaintext highlighter-rouge">iot</code> (<strong>2</strong>), <code class="language-plaintext highlighter-rouge">guest</code> (<strong>5</strong>), and <code class="language-plaintext highlighter-rouge">default</code> (<strong>1</strong>) networks, each with a separate set of DHCP server and firewall rules;</li>
  <li>In each bridge device, we will join the original <code class="language-plaintext highlighter-rouge">lan</code> with the <strong>VLAN ID</strong> of the mesh VLAN (<code class="language-plaintext highlighter-rouge">bat0.1</code>, <code class="language-plaintext highlighter-rouge">bat0.2</code>, <code class="language-plaintext highlighter-rouge">bat0.5</code>), instead of <code class="language-plaintext highlighter-rouge">bat0</code>.</li>
</ul>

<p>Surprisingly enough, we don’t need to do a thing about the <strong>mesh nodes</strong> that are not <strong>gateways</strong> or <strong>bridges</strong>–that is, the <a href="#mesh-node-basic-config">mesh node basic config</a> is both necessary and sufficient for simple mesh nodes, even when using VLANs.  The only exception is if one of your mesh nodes is, for example, a laptop and you want it to use a particular mesh VLAN instead of the untagged <code class="language-plaintext highlighter-rouge">bat0</code>.  In our case, however, the pre-configured mesh nodes are ready to route traffic of any VLAN that belongs to <code class="language-plaintext highlighter-rouge">bat0</code>.</p>

<p>As before, let’s start with the <strong>gateway</strong> configuration.</p>

<h3 id="mesh-gateway-with-vlan-configuration">Mesh gateway with VLAN configuration</h3>
<p>First, configure the gateway <strong>the same way</strong> <a href="#mesh-gateway-configuration">as in the gateway-bridge example</a>.</p>

<p>Second, instead of listing <code class="language-plaintext highlighter-rouge">bat0</code> in the <code class="language-plaintext highlighter-rouge">br-default</code> bridge, we will change it to <code class="language-plaintext highlighter-rouge">bat0.1</code> to indicate that this is the <strong>VLAN ID #1</strong> of our <code class="language-plaintext highlighter-rouge">bat0</code> interface.  So, let’s start by editing the <code class="language-plaintext highlighter-rouge">/etc/config/network</code> configuration file, as follows:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi /etc/config/network
</code></pre></div></div>

<p>Then edit the <code class="language-plaintext highlighter-rouge">br-default</code> stanza to look like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>config device
        option name 'br-default'
        option type 'bridge'
        list ports 'bat0.1'
</code></pre></div></div>

<p class="notice--info">At this point, if you want to enable access to the <code class="language-plaintext highlighter-rouge">default</code> network via the Ethernet port of your gateway device, you can then add another <code class="language-plaintext highlighter-rouge">list ports 'eth0.1'</code> (or whatever your device uses) to the <code class="language-plaintext highlighter-rouge">br-default</code> bridge configuration.  Afterwards, remove any configuration related to the original <code class="language-plaintext highlighter-rouge">lan</code> network.</p>

<p><strong>Save the file</strong>.</p>

<p>Now, we are going to apply the same procedure we used to create the <code class="language-plaintext highlighter-rouge">default</code> network (and its bridge, firewall rules, and dhcp service) to the remaining two networks, namely <code class="language-plaintext highlighter-rouge">iot</code> and <code class="language-plaintext highlighter-rouge">guest</code>.</p>

<p>At the end of the <code class="language-plaintext highlighter-rouge">/etc/config/network</code> file, add a new <code class="language-plaintext highlighter-rouge">config device</code> and <code class="language-plaintext highlighter-rouge">config interface</code> for the <code class="language-plaintext highlighter-rouge">iot</code> network, as follows:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>config device                             
        option name 'br-iot'
        option type 'bridge'
        list ports 'bat0.2'
                                      
config interface 'iot'
        option device 'br-iot'
        option proto 'static'
        option ipaddr '192.168.20.1'
        option netmask '255.255.255.0'
        list dns '1.1.1.1'
        list dns '8.8.8.8'
</code></pre></div></div>

<p>Then add another set of stanzas immediately below for the <code class="language-plaintext highlighter-rouge">guest</code> network:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>config device                             
        option name 'br-guest'
        option type 'bridge'
        list ports 'bat0.5'
                                      
config interface 'guest'
        option device 'br-guest'
        option proto 'static'
        option ipaddr '192.168.50.1'
        option netmask '255.255.255.0'
        list dns '1.1.1.1'
        list dns '8.8.8.8'
</code></pre></div></div>

<p><strong>Save the file</strong> and exit it.</p>

<p>Now, let’s edit the <code class="language-plaintext highlighter-rouge">/etc/config/dhcp</code> config file, as follows:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi /etc/config/dhcp
</code></pre></div></div>

<p>and once again, add a DHCP server config for the <code class="language-plaintext highlighter-rouge">iot</code> network:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>config dhcp 'iot'
        option interface 'iot'
        option start 50
        option limit 100
        option leasetime '6h'
        option ra 'server'
</code></pre></div></div>

<p>and another one for the <code class="language-plaintext highlighter-rouge">guest</code> network:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>config dhcp 'guest'
        option interface 'guest'
        option start 50
        option limit 100
        option leasetime '1h'
        option ra 'server'
</code></pre></div></div>

<p><strong>Save the file</strong> and exit it.</p>

<p>Finally, let’s edit the <code class="language-plaintext highlighter-rouge">/etc/config/firewall</code> config file, as follows</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi /etc/config/firewall
</code></pre></div></div>

<p>and below each stanza for the <code class="language-plaintext highlighter-rouge">default</code> network, add one for the <code class="language-plaintext highlighter-rouge">iot</code> network:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>config zone
        option name     iot
        list network    'iot'
        option input    ACCEPT  ##recommended REJECT
        option output   ACCEPT
        option forward  ACCEPT  ##recommended REJECT
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>config forwarding
        option src   iot
        option dest  wan  ##allows access to cloud services
</code></pre></div></div>

<p>and another for the <code class="language-plaintext highlighter-rouge">guest</code> network:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>config zone
        option name     guest
        list network    'guest'
        option input    ACCEPT  ##recommended REJECT
        option output   ACCEPT
        option forward  ACCEPT  ##recommended REJECT
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>config forwarding
        option src   guest
        option dest  wan
</code></pre></div></div>

<p class="notice--warning">Of note, it is good practice to be more restrictive with the firewall rules for the <code class="language-plaintext highlighter-rouge">guest</code> and <code class="language-plaintext highlighter-rouge">iot</code> networks.  I added comments with recommendations in the configurations above but additional rules might be necessary to enable basic functionality within each of those networks.  For a reference, check the OpenWrt’s guide on <a href="https://openwrt.org/docs/guide-user/network/wifi/guestwifi/guest-wlan#firewall">Guest Wi-Fi basics</a>.</p>

<p>Now <strong>save the file</strong> and exit.  Then, <strong>reboot</strong> the device.  This will implement the changes and offer an opportunity to check if everything will work as intended after a power loss.</p>

<p>Once the gateway device is back online, <code class="language-plaintext highlighter-rouge">ssh</code> into it once again and list its IP addresses:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ip a
</code></pre></div></div>

<p>This should show the various new interfaces we created and the static IP address of your device in each one of them.  If everything looks good, we’re done with the gateway configuration!  We’re now ready to tell our bridges which VLAN ID to join with their standard interfaces.</p>

<p class="notice--danger">You don’t need to use <strong>names</strong> such as <code class="language-plaintext highlighter-rouge">default</code>, <code class="language-plaintext highlighter-rouge">iot</code>, or <code class="language-plaintext highlighter-rouge">guest</code>. They can be whatever you find intuitive.  However, whatever you choose, <strong>keep them short</strong>.  Specifically, they should use less than 15 characters, owing to kernel limitations and various operations that append prefixes/suffixes to such names.</p>

<h3 id="mesh-bridge-with-vlan-configuration">Mesh bridge with VLAN configuration</h3>
<p>Here, we’ll also configure the bridges <strong>the same way</strong> as in the gateway-bridge example. However, each bridge device will bridge <strong>a different VLAN ID</strong>–namely, either <code class="language-plaintext highlighter-rouge">bat0.1</code> or <code class="language-plaintext highlighter-rouge">bat0.2</code> or <code class="language-plaintext highlighter-rouge">bat0.5</code>.</p>

<p>The configuration of the Network D (<strong>Default</strong>) bridge is by far the easiest one because it follows the exact same procedure <a href="#mesh-bridge-configuration">as in the <strong>gateway-bridge example</strong></a>, with the following exception in the <code class="language-plaintext highlighter-rouge">/etc/config/network</code> file:</p>

<ul>
  <li>
    <p>Instead of <code class="language-plaintext highlighter-rouge">bat0</code> in the <code class="language-plaintext highlighter-rouge">br-default</code> stanza, use <code class="language-plaintext highlighter-rouge">bat0.1</code>:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> config device
         option name 'br-default'
         option type 'bridge'
         list ports 'eth0.1'
         list ports 'bat0.1'
</code></pre></div>    </div>
  </li>
</ul>

<p>After making such a change, <strong>save the file</strong> and <strong>reboot</strong> your device.</p>

<p>Now, let’s configure the Network B (<strong>IoT</strong>) bridge. First, configure one of the mesh nodes <a href="#mesh-bridge-configuration">as in the gateway-bridge example</a>.  Then, in the <code class="language-plaintext highlighter-rouge">/etc/config/network</code> file, do the following:</p>

<ul>
  <li>Replace all instances of <code class="language-plaintext highlighter-rouge">default</code> for <code class="language-plaintext highlighter-rouge">iot</code>;</li>
  <li>In the now <code class="language-plaintext highlighter-rouge">br-iot</code> bridge stanza, replace <code class="language-plaintext highlighter-rouge">bat0</code> for <code class="language-plaintext highlighter-rouge">bat0.2</code>;</li>
  <li>In the now <code class="language-plaintext highlighter-rouge">config interface 'iot'</code> stanza:
    <ul>
      <li>Replace <code class="language-plaintext highlighter-rouge">option ipaddr '192.168.10.10'</code> for <code class="language-plaintext highlighter-rouge">option ipaddr '192.168.20.10'</code>;</li>
      <li>Replace <code class="language-plaintext highlighter-rouge">option gateway '192.168.10.1'</code> for <code class="language-plaintext highlighter-rouge">option gateway '192.168.20.1'</code>;</li>
      <li>Replace <code class="language-plaintext highlighter-rouge">option dns '192.168.10.1'</code> for <code class="language-plaintext highlighter-rouge">option dns '192.168.20.1'</code>.</li>
    </ul>
  </li>
</ul>

<p>After all is done, the updated configuration should look something like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>config device
        option name 'br-iot'
        option type 'bridge'
        list ports 'eth0.1'
        list ports 'bat0.2'

config interface 'iot'
        option device 'br-iot'
        option proto 'static'
        option ipaddr '192.168.20.10'
        option netmask '255.255.255.0'
        option gateway '192.168.20.1'
        option dns '192.168.20.1'
</code></pre></div></div>

<p><strong>Save the file</strong> and exit it.</p>

<p>If you created a 2.4GHz WAP that made use of your <code class="language-plaintext highlighter-rouge">default</code> network (e.g., <code class="language-plaintext highlighter-rouge">whome</code>), you can now <strong>edit it</strong> (<code class="language-plaintext highlighter-rouge">vi /etc/config/wireless</code>) to make use of your <code class="language-plaintext highlighter-rouge">iot</code> network instead (<code class="language-plaintext highlighter-rouge">wiot</code>).  Otherwise, ignore this message.</p>

<p><strong>Reboot</strong> your device.</p>

<p>Once it comes back on, your laptop/PC will receive an IP address from our mesh gateway in the <code class="language-plaintext highlighter-rouge">192.168.20.0/24</code> network, the bridge node should be reachable at <code class="language-plaintext highlighter-rouge">192.168.20.10</code>, and you should be able to access the Internet via the <strong>IoT</strong> network (try <code class="language-plaintext highlighter-rouge">ping google.com</code>, for example).</p>

<p><strong>If something does not work</strong>, review the config files from your gateway and then from the bridge, then reboot the gateway and the bridge, and test again.</p>

<p>If this configuration is working, <strong>repeat the same steps</strong> as before for the Network C bridge (<strong>Guest</strong>), with the following exceptions:</p>

<ul>
  <li>Instead of <code class="language-plaintext highlighter-rouge">iot</code>, use <code class="language-plaintext highlighter-rouge">guest</code>;</li>
  <li>Instead of <code class="language-plaintext highlighter-rouge">bat0.2</code>, use <code class="language-plaintext highlighter-rouge">bat0.5</code>;</li>
  <li>Instead of <code class="language-plaintext highlighter-rouge">192.168.20.0/24</code> IP addresses, user <code class="language-plaintext highlighter-rouge">192.168.50.0/24</code> addresses when assigning static IP and pointing to the gateway.</li>
</ul>

<p><em>Optional</em>. When configuring a <strong>Guest</strong> WAP, for example, you can add <code class="language-plaintext highlighter-rouge">option isolate 1</code> to the relevant stanza in the <code class="language-plaintext highlighter-rouge">/etc/config/wireless</code> config file to deny client-to-client connectivity without the need of re-enabling the firewall in the bridge device.  If that’s not enough, re-enable the firewall and configure it according to your needs–at the bottom of the <code class="language-plaintext highlighter-rouge">/etc/config/firewall</code> file, there are examples you can use as template.</p>

<h2 id="getting-started-with-batman-adv-on-any-linux-device">Getting started with batman-adv on any Linux device</h2>
<p>OpenWrt makes using <code class="language-plaintext highlighter-rouge">batman-adv</code> a nearly trivial thing but you certainly don’t need OpenWrt to implement a mesh network or even to use <code class="language-plaintext highlighter-rouge">batman-adv</code> in your mesh.  As mentioned before, <code class="language-plaintext highlighter-rouge">batman-adv</code> has long been added to the Linux Kernel and therefore, you should be able to configure it on pretty much <em>any</em> device running Linux.</p>

<p>Even though the specifics of configuring network interfaces and managing connections might be different across Linux distributions, the initial steps always consist of the following:</p>

<ol>
  <li>Installing (in popular distros, this is <em>not needed</em>) and loading (<em>always</em> needed) the <code class="language-plaintext highlighter-rouge">batman-adv</code> Kernel module.
  <code class="language-plaintext highlighter-rouge">lsmod</code> will show a list of active modules, so we can <code class="language-plaintext highlighter-rouge">grep</code> it to check if the <code class="language-plaintext highlighter-rouge">batman-adv</code> module has already been loaded, as follows
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>lsmod | grep batman
</code></pre></div>    </div>
    <p>then if it isn’t loaded, we add the <code class="language-plaintext highlighter-rouge">batman-adv</code> kmod to <code class="language-plaintext highlighter-rouge">/etc/modules</code> and load it with <code class="language-plaintext highlighter-rouge">modprobe</code>, as follows</p>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># append batman-adv to /etc/modules
echo 'batman-adv' | sudo tee -a /etc/modules &gt; /dev/null
# load the batman-adv module
sudo modprobe batman-adv
# check that the batman-adv module is now loaded
lsmod | grep batman
</code></pre></div>    </div>
    <p>Afterwards, you can check the <a href="https://en.wikipedia.org/wiki/Sysfs"><strong>sysfs</strong></a> of each network device in <code class="language-plaintext highlighter-rouge">/sys/class/net/</code> and there should be a <code class="language-plaintext highlighter-rouge">batman_adv</code> folder.  When the <code class="language-plaintext highlighter-rouge">batman-adv</code> module gets configured to use a particular network device, the files <code class="language-plaintext highlighter-rouge">batman_adv/iface_status</code> and <code class="language-plaintext highlighter-rouge">batman_adv/mesh_iface</code> will change their contents to reflect that. In addition, once enabled, <code class="language-plaintext highlighter-rouge">bat0</code> will show up as a new network device in <code class="language-plaintext highlighter-rouge">/sys/class/net/</code> and its options (e.g., <code class="language-plaintext highlighter-rouge">gw_mode</code>) can be modified by <code class="language-plaintext highlighter-rouge">echo</code>ing new values to their corresponding file in <code class="language-plaintext highlighter-rouge">/sys/class/net/bat0/mesh/</code>  (<code class="language-plaintext highlighter-rouge">echo 'client' &gt; /sys/class/net/bat0/mesh/gw_mode</code>).</p>
  </li>
  <li>Installing the <code class="language-plaintext highlighter-rouge">batctl</code> package. On apt-based distros like Debian, you should be able to install it with the following
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo apt install batctl
</code></pre></div>    </div>
  </li>
  <li>Using a combination of <code class="language-plaintext highlighter-rouge">iw</code> and <code class="language-plaintext highlighter-rouge">ip</code> to configure the network interfaces, as illustrated in the <a href="https://www.open-mesh.org/projects/batman-adv/wiki/Quick-start-guide">B.A.T.M.A.N. quick start guide</a>.  In our case, however, the wireless mode of operation (as in the specification of <code class="language-plaintext highlighter-rouge">type</code> in the <code class="language-plaintext highlighter-rouge">iw</code> interface creation command) is <code class="language-plaintext highlighter-rouge">mesh</code> (or <code class="language-plaintext highlighter-rouge">mp</code>), instead of <code class="language-plaintext highlighter-rouge">adhoc</code> (or <code class="language-plaintext highlighter-rouge">ibss</code>).</li>
  <li>Using something like <a href="https://en.wikipedia.org/wiki/Wpa_supplicant">wpa_supplicant</a> to manage connections.</li>
</ol>

<p>If you know of a program that has a GUI and is able to handle such configurations on popular Linux distros, let me know about it. As far as I know, there’s currently nothing like that and it would be so very useful.</p>

<p><a href="#" class="btn btn--light-outline btn--small">top</a></p>

<h1 id="bonus-content-physical-computing">Bonus content: Physical computing</h1>
<p>If your device has unused <strong>general purpose I/O</strong> pins, it’s possible to do all sorts of things with them.  Check the <a href="https://openwrt.org/docs/techref/hardware/port.gpio">GPIO documentation</a> for examples of how to install new LEDs and buttons, for instance.  (<a href="https://openwrt.org/toh/tp-link/tl-wr1043nd#gpios">Your device’s OpenWrt page can be very useful as well</a>.)</p>

<p>Also, if you want to change the functionality of a few of the existing LEDs on your wireless device, check the <a href="https://openwrt.org/docs/guide-user/base-system/led_configuration">LED configuration documentation</a>.  Now that you have new mesh interfaces, you can use the LEDs to blink depending on the status of neighboring nodes, mesh gateways, or WAN connectivity through the mesh, to mention a few examples. (As mentioned before, <a href="https://openwrt.org/toh/tp-link/tl-wr1043nd#leds">your device’s OpenWrt page can be very useful here</a>.)</p>

<p><a href="#" class="btn btn--light-outline btn--small">top</a></p>

<h1 id="bonus-content-moving-from-openwrt-19-to-21">Bonus content: Moving from OpenWrt 19 to 21</h1>
<p class="notice--warning">If you just found this guide, you can safely ignore the content in this section because the entire article <strong>has been updated</strong> to make it compatible with OpenWrt 21.02, which is now the <strong>current stable release</strong>.  However, if you’re currently running OpenWrt 19.07 and want to upgrade to 21.02, then read on.</p>

<p>When this guide was first written, <a href="https://openwrt.org/releases/19.07/start">OpenWrt 19.07</a> was the current stable release version.  However, as of September 4th, OpenWrt 19.07 transitioned to old stable and <a href="https://openwrt.org/releases/21.02/start"><strong>OpenWrt 21.02</strong></a> is now the current stable release.  For one, this means that most device pages (e.g., <a href="https://openwrt.org/toh/tp-link/archer_c7">TP-Link Archer C7 AC1750</a>) have been updated to link to the OpenWrt 21.02 firmware binaries.</p>

<p>Of course, it is still possible to download and use the latest version of the OpenWrt 19.07 binaries (<code class="language-plaintext highlighter-rouge">19.07.8</code>) by looking for your device’s target at <a href="https://downloads.openwrt.org/releases/19.07.8/targets/">releases/19.07.8/targets</a>.  However, it is generally a good idea to run the latest release version for multiple reasons, <strong>security being the main one</strong>.  Nonetheless, OpenWrt 21.02 introduces <strong>new hardware requirements</strong> and <strong>changes to the network syntax</strong> that you should not overlook before making the transition.  More specifically:</p>

<ul>
  <li>
    <p>OpenWrt 21.02 introduces initial support for the <a href="https://www.kernel.org/doc/html/latest/networking/dsa/dsa.html"><strong>Distributed Switch Architecture</strong> (<strong>DSA</strong>)</a>.  Currently, however, this only applies to <a href="https://openwrt.org/releases/21.02/notes-21.02.0#initial_dsa_support">a very limited number of devices</a>.  If you have one of such devices, then make sure to read rmilecki’s <a href="https://forum.openwrt.org/t/mini-tutorial-for-dsa-network-config/96998">mini tutorial for DSA network configuration</a> because the syntax is a little bit different than the one used in this guide.</p>
  </li>
  <li>
    <p>The <a href="https://openwrt.org/releases/21.02/notes-21.02.0#increased_minimum_hardware_requirements8_mb_flash_64_mb_ram">hardware requirements to run OpenWrt 21.02</a> has increased to <code class="language-plaintext highlighter-rouge">8 MB</code> of flash memory and <code class="language-plaintext highlighter-rouge">64 MB</code> of RAM.  In the first version of this guide, I used the <strong>TP-Link TL-WR1043ND (v1.8)</strong> as an example of mesh node hardware, which has <code class="language-plaintext highlighter-rouge">8MB</code> of flash memory and <code class="language-plaintext highlighter-rouge">32MB</code> of RAM.  At first, I tried to use OpenWrt 21.02 with it but the system became <strong>too unstable</strong>, even after making several changes to multiple firmware images (e.g., removing LuCI altogether and adding <code class="language-plaintext highlighter-rouge">zram</code> support).  This is what prompted me to change the device in the examples to the <strong>TP-Link TL-WD4300</strong>, which is also a <em>low-end</em> router but it has <code class="language-plaintext highlighter-rouge">128MB</code> of RAM instead and importantly, it is a <em>dual-band</em> router that allows better segmentation of mesh vs non-mesh wireless traffic.</p>
  </li>
  <li>There is a small but important <a href="https://openwrt.org/releases/21.02/notes-21.02.0#new_network_configuration_syntax_and_boardjson_change">change in the configuration <strong>syntax</strong></a> in <code class="language-plaintext highlighter-rouge">/etc/config/network</code>, namely:
    <ol>
      <li>The option <code class="language-plaintext highlighter-rouge">ifname</code> is now called <code class="language-plaintext highlighter-rouge">device</code> in all <code class="language-plaintext highlighter-rouge">config interface</code> stanzas;</li>
      <li>The option <code class="language-plaintext highlighter-rouge">ifname</code> is now called <code class="language-plaintext highlighter-rouge">ports</code> in all <code class="language-plaintext highlighter-rouge">config device</code> stanzas of type <code class="language-plaintext highlighter-rouge">bridge</code>.</li>
    </ol>

    <p>Fortunately, it seems that the <strong>old syntax</strong> (as in the first version of this guide) <strong>is still supported</strong> but if you are using LuCI, you will run into compatibility issues and will be prompted to update.  To update it, take a closer look at the examples in the current version of the guide, which are now compatible with the network syntax introduced by OpenWrt 21.02.</p>
  </li>
  <li>There many other changes in OpenWrt 21.02 but from my experience so far, none of them are as relevant as the ones mentioned before.  For other highlights and additional information, please check the <a href="https://openwrt.org/releases/21.02/notes-21.02.0">official OpenWrt 21.02.0 release notes</a>.</li>
</ul>

<p>Upgrading the firmware is as easy as it has always been: (a) go to the device’s OpenWrt page, (b) download the new <code class="language-plaintext highlighter-rouge">*-sysupgrade.bin</code> binary, and then (c) flash it onto your device via LuCI.  If you’re only using the terminal, first SSH into your device and make sure it has enough free memory by typing:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>free
</code></pre></div></div>

<p>which should output something like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>              total        used        free      shared  buff/cache   available
Mem:          27064       16168        6004         304        4892        8368
Swap:         13308         768       12540
</code></pre></div></div>

<p>and if the amount of <code class="language-plaintext highlighter-rouge">free</code> in the <code class="language-plaintext highlighter-rouge">Mem:</code> row is higher than the size of the binary, then copy the new binary to the root of the <code class="language-plaintext highlighter-rouge">/tmp/</code> directory via <code class="language-plaintext highlighter-rouge">scp</code> (or any other method) and run <code class="language-plaintext highlighter-rouge">sysupgrade</code> to upgrade your firmware to the latest release, as follows:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sysupgrade -v -n /tmp/*-sysupgrade.bin
</code></pre></div></div>

<p>Importantly, owing to changes in the network syntax, I strongly recommend to <strong>discard all configuration files when making the transition</strong>.  When upgrading via LuCI, make sure to <em>de</em>select the option to preserve configuration, and similarly, when upgrading via <code class="language-plaintext highlighter-rouge">sysupgrade</code>, add the <code class="language-plaintext highlighter-rouge">-n</code> argument command, as mentioned before. This, of course, means you will lose connection to the device if you are running the upgrade via a wireless connection, so make sure to use a cable for this particular operation.</p>

<p class="notice--warning">If the configuration files in <code class="language-plaintext highlighter-rouge">/etc/config/</code> have been extensively edited, make sure to make a backup of them before running the upgrade.</p>

<p>In addition, remember that the various packages supporting the use of <code class="language-plaintext highlighter-rouge">batman-adv</code> do not come with pre-built (default) images, which means that you won’t be able to connect to your mesh node after an upgrade if you are relying on the mesh network to reach it.  If you do not want to reinstall all such packages (or cannot physically reach the nodes), check the updated section about <a href="#openwrt-installation-and-initial-configuration">OpenWrt installation and initial configuration</a>, which now features instructions on how to build customized images with pre-installed mesh packages.  Building your own images also means you can create default versions for all <code class="language-plaintext highlighter-rouge">/etc/config/</code> files (see <code class="language-plaintext highlighter-rouge">FILES=""</code> usage in the <code class="language-plaintext highlighter-rouge">make image</code> command) but <strong>use caution with such feature</strong> to avoid (soft) bricking your device.  At the very least, use only configurations you have already tested and that will work independently of any other node.</p>

<p>Overall, I like the clearer distinction between layers 2 and 3 introduced by the new network syntax in OpenWrt 21.02.  Once you get the hang of it, the configuration looks more organized and intuitive than before, and therefore, I think it is a step forward in the right direction.  Lastly, I would like to thank <a href="https://forum.openwrt.org/u/stevenewcomb">SteveNewcomb</a> for testing–and letting me know about–<code class="language-plaintext highlighter-rouge">batman-adv</code> under the OpenWrt 21.02 release candidates.</p>

<p><a href="#" class="btn btn--light-outline btn--small">top</a></p>

<h1 id="final-remarks">Final remarks</h1>

<p><img src="/assets/posts/2020-11-24-mesh-networking-openwrt-batman/futurama.jpg" alt="Futurama Hubert Farnsworth" class="PostImage" /></p>

<p>Good news, everyone! You’ve reached the end of this tutorial, which means it’s time to start planning your own mesh networking project.  I love to hear about different takes on the projects I post on my blog, so don’t hesitate to <a href="/contact/">contact me</a> if you just want to share or bounce a few ideas.  Different perspectives give an opportunity to learn, grow, and innovate.</p>

<h2 id="other-similar-mesh-solutions">Other similar mesh solutions</h2>
<p>If you find this guide overwhelming but you’re still curious about mesh networking, take a look at the following alternatives (in alphabetical order):</p>

<ul>
  <li><a href="https://www.commotionwireless.net">Commotion Wireless</a></li>
  <li><a href="https://libremesh.org">LibreMesh</a></li>
</ul>

<p>They have pre-configured images that will work “out of the box” with compatible devices.  You might find instructive to start playing around with their software first and once comfortable, build your own configuration from a default (or customized from the source) OpenWrt image.</p>

<p><a href="#" class="btn btn--light-outline btn--small">top</a></p>

        
      </section>

      <footer class="page__meta">
        
        


        
  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Posted on:</strong> <time datetime="2020-12-07T12:10:00-03:00">December 7, 2020</time></p>


      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">Share on</h4>
  

  <a href="mailto:?subject=[cgomesu.com] Mesh networking: A guide to using free and open-source software with common hardware&amp;body=%2Fblog%2FMesh-networking-openwrt-batman%2F " class="btn btn--inverse" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on E-mail"><i class="fas fa-envelope" aria-hidden="true"></i><span> E-mail</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=%2Fblog%2FMesh-networking-openwrt-batman%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.reddit.com/submit?title=Mesh networking: A guide to using free and open-source software with common hardware&url=%2Fblog%2FMesh-networking-openwrt-batman%2F" class="btn btn--reddit" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Reddit"><i class="fab fa-fw fa-reddit" aria-hidden="true"></i><span> Reddit</span></a>

  <a href="https://twitter.com/intent/tweet?text=Mesh+networking%3A+A+guide+to+using+free+and+open-source+software+with+common+hardware%20%2Fblog%2FMesh-networking-openwrt-batman%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/blog/Nanopi-m4-mini-nas/" class="pagination--pager" title="NanoPi M4 mini-NAS
">Previous</a>
    
    
      <a href="/blog/Rpi-button-box-ehdd-enclosure/" class="pagination--pager" title="Repurposing external HDD enclosures into button boxes for the Raspberry Pi
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search terms here...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search terms here..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
      
        
      
        
          <li><a href="https://github.com/cgomesu" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
        
      
        
      
        
      
        
          <li><a href="https://www.reddit.com/user/cgomesu/" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-reddit" aria-hidden="true"></i> Reddit</a></li>
        
      
    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> RSS feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2021 CGomesu - Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> and <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a></div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script src="https://kit.fontawesome.com/4eee35f757.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>







  </body>
</html>
