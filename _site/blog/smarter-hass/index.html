<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.19.3 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Towards a smarter Home Assistant: Getting started on the analytical tools - CGomesu</title>
<meta name="description" content="A blog and portfolio website built with Jekyll and hosted on Github Pages">


  <meta name="author" content="Carlos Gomes">


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="CGomesu">
<meta property="og:title" content="Towards a smarter Home Assistant: Getting started on the analytical tools">
<meta property="og:url" content="/blog/smarter-hass/">


  <meta property="og:description" content="A blog and portfolio website built with Jekyll and hosted on Github Pages">



  <meta property="og:image" content="/assets/posts/2021-06-04-smarter-hass/header.jpg">





  <meta property="article:published_time" content="2021-06-22T15:45:00-03:00">





  

  


<link rel="canonical" href="/blog/smarter-hass/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "",
      "url": "/"
    
  }
</script>


  <meta name="google-site-verification" content="FA-B3i_TqYeaLPYwZvxxOsx07Coy_drBKJ0M_4DD0Gw" />





<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="CGomesu Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->
<link rel="icon" href="/assets/img/site/favicon.ico" type="image/x-icon">

<!-- end custom head snippets -->

  </head>

  <body class="layout--single wide">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/assets/img/site/logo.png" alt=""></a>
        
        <a class="site-title" href="/">
           
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/">Home</a>
            </li><li class="masthead__menu-item">
              <a href="/blog/">Blog</a>
            </li><li class="masthead__menu-item">
              <a href="/contact/">Contact</a>
            </li><li class="masthead__menu-item">
              <a href="/mtg/">MtG</a>
            </li><li class="masthead__menu-item">
              <a href="/publications/">Publications</a>
            </li><li class="masthead__menu-item">
              <a href="/projects/">Projects</a>
            </li><li class="masthead__menu-item">
              <a href="/donations/">Donations</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      
  







<div class="page__hero--overlay"
  style="background-color: #000; background-image: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)), url('/assets/posts/2021-06-04-smarter-hass/header.jpg');"
>
  
    <div class="wrapper">
      <h1 id="page-title" class="page__title" itemprop="headline">
        
          Towards a smarter Home Assistant: Getting started on the analytical tools

        
      </h1>
      
        <p class="page__lead">
</p>
      
      
        <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  76 minute read

</p>
      
      
      
    </div>
  
  
</div>





<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="/assets/img/profile/profile-00.jpg" alt="Carlos Gomes" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Carlos Gomes</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>I’m a scientist, psychologist, math modeler, programmer, mtg player, free knowledge supporter, sbc fanatic, and electronics hobbyist.</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Learn more</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Brazil</span>
        </li>
      

      
        
          
            <li><a href="mailto:me@cgomesu.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Main e-mail</span></a></li>
          
        
          
            <li><a href="/donations" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-donate" aria-hidden="true"></i><span class="label">Donations</span></a></li>
          
        
          
            <li><a href="https://cgomesu.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-link" aria-hidden="true"></i><span class="label">https://cgomesu.com</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Towards a smarter Home Assistant: Getting started on the analytical tools">
    <meta itemprop="description" content="">
    <meta itemprop="datePublished" content="2021-06-22T15:45:00-03:00">
    

    <div class="page__inner-wrap">
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-list"></i> Table of Contents</h4></header>
              <ul class="toc__menu">
  <li><a href="#changelog">Changelog</a></li>
  <li><a href="#introduction">Introduction</a></li>
  <li><a href="#objectives">Objectives</a></li>
  <li><a href="#outline">Outline</a></li>
  <li><a href="#prerequisites">Prerequisites</a>
    <ul>
      <li><a href="#hass-core">HASS core</a></li>
      <li><a href="#hass-configuration-files">HASS configuration files</a></li>
      <li><a href="#hass-database">HASS database</a>
        <ul>
          <li><a href="#default-database">Default database</a></li>
          <li><a href="#resetting-entity-data-in-the-db">Resetting entity data in the DB</a></li>
          <li><a href="#long-term-statistics">Long-term statistics</a></li>
        </ul>
      </li>
      <li><a href="#statistics">Statistics</a></li>
    </ul>
  </li>
  <li><a href="#implementation">Implementation</a>
    <ul>
      <li><a href="#data">Data</a></li>
      <li><a href="#sampling">Sampling</a></li>
      <li><a href="#utilities">Utilities</a>
        <ul>
          <li><a href="#history-stats">History Stats</a>
            <ul>
              <li><a href="#usage-examples">Usage examples</a></li>
              <li><a href="#additional-references">Additional references</a></li>
            </ul>
          </li>
          <li><a href="#statistics-1">Statistics</a>
            <ul>
              <li><a href="#usage-examples-1">Usage examples</a></li>
              <li><a href="#additional-references-1">Additional references</a></li>
            </ul>
          </li>
          <li><a href="#trend">Trend</a>
            <ul>
              <li><a href="#usage-examples-2">Usage examples</a></li>
              <li><a href="#additional-references-2">Additional references</a></li>
            </ul>
          </li>
        </ul>
      </li>
      <li><a href="#visualizing-analytical-data">Visualizing analytical data</a>
        <ul>
          <li><a href="#how-to-temperature-with-dynamic-color-thresholds">How-to: Temperature with dynamic color thresholds</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#development">Development</a></li>
  <li><a href="#conclusion">Conclusion</a></li>
</ul>

            </nav>
          </aside>
        
        <h1 id="changelog">Changelog</h1>
<p class="notice--info"><strong>August 14th, 2021</strong>, Update #2: <a href="https://github.com/home-assistant/core/pull/52189">My pull request</a> to add <a href="https://en.wikipedia.org/wiki/Quantile">quantiles</a> to the attributes of the Statistics integration was approved and now we have access to an additional (and more informative) distribution metric. The <a href="#statistics-1">Statistics</a> section was updated to reflect such change.</p>

<p class="notice--success"><strong>August 14th, 2021</strong>, Update #1: <a href="https://www.home-assistant.io/blog/2021/08/04/release-20218/">Release 2021.8.0</a> has introduced a new feature for sensors called <a href="https://developers.home-assistant.io/docs/core/entity/sensor/#long-term-statistics"><strong>long-term statistics</strong></a>. A new sub-section called <a href="#long-term-statistics">Long-term statistics</a> was added to the <a href="#hass-database">HASS database</a> section that describes its relation to the <code class="language-plaintext highlighter-rouge">states</code> table and how to implement it.  The same release also introduced the <a href="https://www.home-assistant.io/lovelace/statistics-graph/">Statistics Graph Card</a>, which provide a nice way of visualizing long-term statistics.</p>

<p class="notice--info"><strong>June 22nd, 2021</strong>: Publication of the original article</p>

<p><a href="#" class="btn btn--light-outline btn--small">top</a></p>

<h1 id="introduction">Introduction</h1>
<p><a href="https://www.home-assistant.io/">Home Assistant</a> (HASS) is a free and open-source software (FOSS) that provides a feature-rich environment for managing, controlling, and automating smart home devices, such as light bulbs, blinders, and LED strips.  In addition, it provides a highly customizable system for collecting and organizing a multitude of data (e.g., on/off device states, local temperature, GPS tracking, exchange rates), as provided by <strong>more than a thousand <a href="https://www.home-assistant.io/integrations">integrations</a></strong> with <a href="https://en.wikipedia.org/wiki/Internet_of_things">Internet of things</a> (IoT) devices (e.g., <a href="https://sonoff.tech/">Sonoff</a>, <a href="https://wyze.com/">Wyze</a>, <a href="https://www.z-wave.com/">Z-Wave</a>), local sensors (e.g., micro-controllers or single-board computers connected to sensor modules), and cloud-based services (e.g., weather and financial web APIs).</p>

<p><a href="/assets/posts/2021-06-04-smarter-hass/hass-demo.jpg"><img src="/assets/posts/2021-06-04-smarter-hass/hass-demo.jpg" alt="HASS demo frontend" class="PostImage PostImage--large" /></a></p>

<p>More often than not, people use HASS to view or modify the <strong>current state and value</strong> of integrated devices and sensors via manual triggers (e.g., pressing a button to turn off the AC) or automations (e.g., if the temperature is lower than 14°C, then turn on the heat).  However, the <a href="https://www.home-assistant.io/integrations#utility">HASS utility integrations</a> offer users the possibility to go beyond with the help of built-in mathematical and statistical tools.  More specifically, such <strong>analytical tools</strong> allow users to summarize past states and measurements to answer questions such as:</p>

<ul>
  <li>How many times has the front door been opened over the last 24hrs and for how long?</li>
  <li>How much energy (kWh) has my uninterrupted power supply used over the last month?</li>
  <li>What was the average temperature in the living-room in the last 24hrs?  How does that compare to 48hrs before?</li>
  <li>What is the average level of volatile organic compounds (VOC) measured by the <a href="https://www.bosch-sensortec.com/products/environmental-sensors/gas-sensors/bme680/">BME680 sensor</a> in my bedroom in the last thirty minutes?  How much does it change over the day?</li>
</ul>

<p>Unfortunately, according to the HASS website, the <a href="https://www.home-assistant.io/integrations/statistics/">Statistics</a> and related utilities are currently used by less than 5% of the HASS userbase.  I feel there is much to be explored and gained from the application of <strong>dynamic statistical inferences</strong> in home automation systems.  To mention a few reasons, sensors are susceptible to measurement error and many user-defined events (e.g., Carlos is at home) are multidimensional and frequently determined by more factors than integrated within a home automation system (e.g., my cellphone connected to my home’s private network is not a sufficient condition to tell that I’m at home but it does inform about the likelihood that I am at home).  This creates uncertainty about the current and future states of things but fortunately, this uncertainty can be quantified and taken into account by various statistical tools that have long been developed.</p>

<p>Furthermore, the fact that HASS integrations are written in the <a href="https://www.python.org/">Python programming language</a> makes HASS a prime candidate for exploring the use of statistical inference in home automation systems because many mathematical and statistical packages are already available in Python and are widely used and well-maintained (e.g., <a href="https://pypi.org/project/numpy/"><code class="language-plaintext highlighter-rouge">numpy</code></a> and <a href="https://pypi.org/project/scipy/"><code class="language-plaintext highlighter-rouge">scipy</code></a>). Therefore, porting new and more sophisticated analytical tools to HASS should be fairly straightforward.  (More on this in the <a href="#development">Development</a> section).</p>

<p>At the very least, the current analytical tools can be used to improve the quality of the information in your HASS dashboard.  For example, instead of simply displaying the current temperature, the use of analytical tools allow us to set dynamic color thresholds based on the mean and deviations from it (± one standard deviation, then min-max) over the last 24hrs:</p>

<p><a href="/assets/posts/2021-06-04-smarter-hass/hass-graph-dynamic-temperature-01.gif"><img src="/assets/posts/2021-06-04-smarter-hass/hass-graph-dynamic-temperature-01.gif" alt="HASS graph dynamic temperature 01" class="PostImage PostImage--large" /></a></p>

<p>But there’s much more that can be done and accomplished moving forward.  If you find these ideas interesting and want to get started on their implementation in your own personal HASS, then read on.  As in my previous guides and tutorials, I tried to unpack and digest as much of the content as possible, the goal being to make it accessible to experts as well as novices.  Check the <a href="#changelog">Changelog</a> for updates and if you ever get stuck on something or just want to share a few ideas and opinions, feel free to <a href="/contact">get in touch with me</a>.</p>

<p><a href="#" class="btn btn--light-outline btn--small">top</a></p>

<h1 id="objectives">Objectives</h1>
<ul>
  <li>Get familiar with the following:
    <ul>
      <li>The HASS SQLite database (DB);</li>
      <li>YAML syntax;</li>
      <li>Templating.</li>
    </ul>
  </li>
  <li>Learn the specifics about how data are sampled and stored in the HASS DB and how they affect analysis, owing to inconsistent data points and misrepresentation of data over time;</li>
  <li>Familiarize yourself with the use of three utility integrations:
    <ul>
      <li>History Stats;</li>
      <li>Statistics;</li>
      <li>Trend.</li>
    </ul>
  </li>
  <li>Make use of analytical data to improve your current HASS dashboard using the following cards:
    <ul>
      <li>Mini graph card;</li>
      <li>Lovelace card templater.</li>
    </ul>
  </li>
</ul>

<p><a href="#" class="btn btn--light-outline btn--small">top</a></p>

<h1 id="outline">Outline</h1>
<p>From this point forward, the article was divided into two main parts:</p>

<ol>
  <li>
    <p>(<em>Optional.</em>) <a href="#prerequisites"><strong>Prerequisites</strong></a>: A brief overview of the HASS core installation, configuration files, and database. At the end of this section, there is a few statistics resources for users who want to refresh their stats knowledge.  Advanced users might want to skip this section altogether.  However, at the very least, I suggest to glance over each topic to make sure we are all on the same page.</p>
  </li>
  <li>
    <p><a href="#implementation"><strong>Implementation</strong></a>: This is the main part of the article. I started describing in detail the issues pertaining to how data are sampled and stored in the HASS DB. Afterwards, I reviewed three of the current Utility integrations that I find most useful and finally, at the end, I mentioned two JavaScript modules that are useful in visualizing analytical metrics within the HASS dashboard.  (If you came here just to learn how to build a dynamic threshold graph card, feel free to head straight to the section called <a href="#visualizing-analytical-data">Visualizing analytical data</a>.)</p>
  </li>
</ol>

<p><a href="#" class="btn btn--light-outline btn--small">top</a></p>

<h1 id="prerequisites">Prerequisites</h1>
<p>The implementation of analytical tools in HASS has the following basic requirements:</p>

<ol>
  <li>A <a href="#hass-core">HASS <strong>core</strong></a> instance;</li>
  <li>Understanding of <a href="#hass-configuration-files">the <strong>configuration</strong> files and the <strong>YAML</strong> syntax</a>;</li>
  <li>Understanding the <a href="#hass-database">HASS <strong>database</strong></a>;</li>
  <li>And of course, <a href="#statistics">basic <strong>statistics</strong></a> knowledge.</li>
</ol>

<p>Those four topics are described separately next.</p>

<h2 id="hass-core">HASS core</h2>
<p>Structurally, HASS can be divided into three main layers: (a) core; (b) supervisor; and (c) operating system (OS).  The folks at the HASS wiki were kind enough to put together a plethora of <a href="https://www.home-assistant.io/installation/">installation methods</a> for all sorts of OSes and environments (bare-metal vs. virtual).  For this guide, however, only the most basic layer of the HASS system is needed, namely the <strong>HASS core</strong>, which is available in <em>any</em> installation method.</p>

<p>Instead of using an existing HASS instance, I <strong>strongly</strong> recommend to <strong>create a containerized (Docker) HASS instance</strong> for testing purposes.  This will be much safer than playing with an existing HASS instance and its database.</p>

<p>To create a HASS Docker container, follow the instructions in the <strong>official documentation</strong>:</p>

<ol>
  <li><a href="https://docs.docker.com/engine/install/">Install <strong>Docker Engine - Community Edition</strong></a>;</li>
  <li>(<em>Optional</em>.) <a href="https://documentation.portainer.io/v2.0/deploy/ceinstalldocker/">Install <strong>Portainer - Community Edition</strong></a> to manage your Docker containers;</li>
  <li><a href="https://www.home-assistant.io/installation/linux#install-home-assistant-container">Install <strong>HASS Docker container</strong></a>.</li>
</ol>

<p>Of note, after deploying the HASS container, use a host’s text editor (e.g., <code class="language-plaintext highlighter-rouge">nano</code>, <code class="language-plaintext highlighter-rouge">vi</code>, <code class="language-plaintext highlighter-rouge">vim</code>, <code class="language-plaintext highlighter-rouge">pluma</code>) to edit the <code class="language-plaintext highlighter-rouge">configuration.yaml</code> file and related configuration files.  Whenever you create a new <code class="language-plaintext highlighter-rouge">.yaml</code> file, make sure that the HASS user will have permission to read it at the very least, or you will run into issues.  Finally, in the HASS webUI, your HASS user must be able to access the <a href="https://www.home-assistant.io/docs/tools/dev-tools/"><strong>Developer Tools</strong> &gt; Services</a> tab to check the state of each entity and their attributes.  The default admin user should have access to such a resource.</p>

<h2 id="hass-configuration-files">HASS configuration files</h2>
<p>The configuration files in HASS use a human-readable data serialization language called <a href="https://yaml.org/"><strong>YAML</strong></a> (YAML Ain’t Markup Language).  In this guide, we will use YAML to edit and create configuration files for HASS that will customize database settings and new entities to collect data and help with their visualization.</p>

<p>If you are new to YAML, take a few minutes right now to familiarize yourself with it.  The HASS wiki has a straight to the point explanation that I invite everyone to read:</p>

<ul>
  <li><a href="https://www.home-assistant.io/docs/configuration/yaml/">https://www.home-assistant.io/docs/configuration/yaml/</a></li>
</ul>

<p>To highlight a few important points about the configuration files and the YAML syntax:</p>

<ul>
  <li>Indentation and spacing in general are <strong>very</strong> important in YAML. Use only the spacebar and maintain consistency across all configuration files. If at all possible, use an editor that shows whitespaces when editing any YAML files;</li>
  <li>UPPER and lower cases matter;</li>
  <li>Use <code class="language-plaintext highlighter-rouge">#</code> to add comments;</li>
  <li>Use <code class="language-plaintext highlighter-rouge">""</code> (double quotation marks) for escaping special characters in sequences (e.g., <code class="language-plaintext highlighter-rouge">"Hey! What's up?"</code>) and <code class="language-plaintext highlighter-rouge">''</code> (single quotation marks) when escaping is not necessary (e.g., <code class="language-plaintext highlighter-rouge">'Nothing much.'</code>);</li>
  <li>Use the <code class="language-plaintext highlighter-rouge">!include</code> for splitting up your <code class="language-plaintext highlighter-rouge">configuration.yaml</code>. For instance, instead of adding all your <code class="language-plaintext highlighter-rouge">sensor:</code> and <code class="language-plaintext highlighter-rouge">binary_sensor:</code> to the <code class="language-plaintext highlighter-rouge">configuration.yaml</code> file itself, create <code class="language-plaintext highlighter-rouge">sensors.yaml</code> and <code class="language-plaintext highlighter-rouge">binary_sensors.yaml</code> files in the <code class="language-plaintext highlighter-rouge">config/</code> directory and then use <code class="language-plaintext highlighter-rouge">!include</code> to add them automatically to your <code class="language-plaintext highlighter-rouge">configuration.yaml</code>:
    <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Sensors</span>
<span class="na">sensor</span><span class="pi">:</span> <span class="kt">!include</span> <span class="s">sensors.yaml</span>
<span class="na">binary_sensor</span><span class="pi">:</span> <span class="kt">!include</span> <span class="s">binary_sensors.yaml</span>
</code></pre></div>    </div>
  </li>
  <li>Use <code class="language-plaintext highlighter-rouge">!secret</code> and a <code class="language-plaintext highlighter-rouge">secrets.yaml</code> for managing passwords.  (See more in the HASS wiki called <a href="https://www.home-assistant.io/docs/configuration/secrets/">Storing secrets</a>.)  This is particularly useful if you plan on sharing your configurations.</li>
</ul>

<p>Finally, after making any changes to any YAML file (and saving them), it is necessary to <a href="https://www.home-assistant.io/docs/configuration/#reloading-changes"><strong>reload</strong> the <code class="language-plaintext highlighter-rouge">configuration.yaml</code> file</a>.  If your installation method does not allow for selective reloading, then go ahead and reload the entire HASS.  However, <em>before reloading any configuration file</em>, use the <code class="language-plaintext highlighter-rouge">hass --script check_config</code> script to make sure your <code class="language-plaintext highlighter-rouge">configuration.yaml</code> file is okay, as follows:</p>

<ul>
  <li>
    <p>From within the HASS webUI, navigate to <strong>Configuration</strong> &gt; <strong>Server Controls</strong> &gt; Configuration validation.</p>

    <p><a href="/assets/posts/2021-06-04-smarter-hass/hass-config-validation.jpg"><img src="/assets/posts/2021-06-04-smarter-hass/hass-config-validation.jpg" alt="HASS config validation" class="PostImage PostImage--large" /></a></p>

    <p><a href="/assets/posts/2021-06-04-smarter-hass/hass-config-reload.jpg"><img src="/assets/posts/2021-06-04-smarter-hass/hass-config-reload.jpg" alt="HASS config reload" class="PostImage PostImage--large" /></a></p>

    <p class="notice">Alternatively, if running the HASS Docker container, use <code class="language-plaintext highlighter-rouge">docker exec homeassistant python -m homeassistant --script check_config --config /config</code> to run the <code class="language-plaintext highlighter-rouge">check_config</code> script from your host machine.  (This assumes that your HASS container is called <code class="language-plaintext highlighter-rouge">homeassistant</code>. If this is not the case, change it accordingly.)</p>
  </li>
</ul>

<p>Always keep an eye on the <code class="language-plaintext highlighter-rouge">home-assistant.log</code> file for errors.  This will greatly help you troubleshooting most issues on your own (e.g., incorrect references or operations in templates).</p>

<h2 id="hass-database">HASS database</h2>
<p>HASS uses a relational database (DB) management system (RDBMS) based on the <strong>SQL engine</strong> and by default, it creates a <a href="https://www.sqlite.org/index.html"><strong>SQLite DB</strong></a> in <code class="language-plaintext highlighter-rouge">config/home-assistant_v2.db</code> to track events and parameters over time.  If you want to learn more about and dive into the HASS DB, including how to create your own SQL backend, take a look at the two following resources:</p>

<ul>
  <li><a href="https://www.home-assistant.io/docs/backend/database/">https://www.home-assistant.io/docs/backend/database/</a></li>
  <li><a href="https://www.home-assistant.io/integrations/recorder/">https://www.home-assistant.io/integrations/recorder/</a></li>
</ul>

<p>Fortunately, most users won’t need to learn RDBMSes and SQL to take advantage of analytical tools in HASS because the default SQLite DB is usually enough.  However, there are a few aspects about the <strong>default settings</strong> that can affect the way the data are analyzed.  Those aspects are described in more detail next.</p>

<h3 id="default-database">Default database</h3>
<p>In the <code class="language-plaintext highlighter-rouge">configuration.yaml</code> file, the <strong>default SQLite DB</strong> is created along with many of the other default settings by the following configuration variable:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">default_config</span><span class="pi">:</span>
</code></pre></div></div>

<p>To change the default DB settings, it is necessary to add a <code class="language-plaintext highlighter-rouge">recorder:</code> configuration variable to the <code class="language-plaintext highlighter-rouge">configuration.yaml</code> file, as follows:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">default_config</span><span class="pi">:</span>
<span class="c1"># Customized DB settings</span>
<span class="na">recorder</span><span class="pi">:</span>
</code></pre></div></div>

<p>The documentation of the specific <code class="language-plaintext highlighter-rouge">recorder:</code> variables can be found at the HASS wiki:</p>

<ul>
  <li><a href="https://www.home-assistant.io/integrations/recorder/">https://www.home-assistant.io/integrations/recorder/</a></li>
</ul>

<p>In brief, by default, the HASS DB <strong>keeps historical data up to 10 days</strong> (<code class="language-plaintext highlighter-rouge">purge_keep_days: 10</code>), running an automatic purge of the database every night to prevent the DB from increasing in size indefinitely (<code class="language-plaintext highlighter-rouge">auto_purge: true</code>).  Therefore, <em>if you want to keep data from one or more entities for longer than 10 days</em>, then you must edit the DB default settings.  Personally, I prefer to keep data for <em>two weeks</em> instead (14 days), so I usually change my <code class="language-plaintext highlighter-rouge">recorder:</code> configuration to the following in the <code class="language-plaintext highlighter-rouge">configuration.yaml</code> file:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">default_config</span><span class="pi">:</span>
<span class="c1"># Customized DB settings</span>
<span class="na">recorder</span><span class="pi">:</span>
  <span class="na">purge_keep_days</span><span class="pi">:</span> <span class="m">14</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">include</code> and <code class="language-plaintext highlighter-rouge">exclude</code> filter parameters are particularly useful whenever working with non-default settings, as they help you specify which entities should be tracked.  <a href="https://www.home-assistant.io/integrations/recorder/#common-filtering-examples">Check the HASS wiki Configure Filter for examples</a>.</p>

<p>In addition, as mentioned before, the default DB is stored in your <code class="language-plaintext highlighter-rouge">config/</code> directory and also by default, <strong>changes are committed to the DB every 1 sec</strong> (<code class="language-plaintext highlighter-rouge">commit_interval: 1</code>). This matters because if you are collecting data over a time window lower than 1 sec, then you might want to change the commit interval to <code class="language-plaintext highlighter-rouge">0</code> (zero, or as soon as possible) instead. At this point, it is also important to consider where the DB is being physically stored (SD card, eMMC, HDD, or SSD), owing to <strong>disk I/O</strong> and <strong>wear and tear</strong> considerations.  (More advanced aspects come into play if HASS is not the only application committing to the DB but I trust that if this is your case, then you probably know how to customize the HASS DB accordingly.)</p>

<p>For advanced users who want to browse and manually add/edit entries from the default (SQLite) <code class="language-plaintext highlighter-rouge">home-assistant_v2.db</code>, it is possible to use the <a href="https://sqlitebrowser.org/">SQLite Database Browser</a>.  Just keep in mind that the default HASS DB might have permissions (ownership and group membership) that are incompatible with your current host user and therefore, you might be unable even to read the DB without first editing the permissions–in Linux, appending <code class="language-plaintext highlighter-rouge">sudo</code> to <code class="language-plaintext highlighter-rouge">sqlitebrowser</code> should give you access no matter what though.</p>

<h3 id="resetting-entity-data-in-the-db">Resetting entity data in the DB</h3>
<p>In addition to the SQL browser method of editing the HASS DB, HASS allow users to run a <a href="https://www.home-assistant.io/docs/scripts/service-calls/">service call</a> from within the webUI to manually run a <strong>purge task</strong>. This is particularly useful to run once you are done making changes to a newly created template entity and want to clean any previous (and possibly erroneous) records from the DB.  To remove all the data from a list of entities, do the following:</p>

<ol>
  <li>Navigate to <strong>Developer Tools</strong> &gt; Services;</li>
  <li>Select <strong>Go to YAML mode</strong> and paste the following:
    <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">service</span><span class="pi">:</span> <span class="s">recorder.purge_entities</span>
<span class="na">target</span><span class="pi">:</span>
  <span class="na">entity_id</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">sensor.my_template_entity_01</span>
    <span class="pi">-</span> <span class="s">sensor.my_template_entity_02</span>
</code></pre></div>    </div>
    <p>in which <code class="language-plaintext highlighter-rouge">sensor.my_template_entity*</code> are the target template entities you want to purge;</p>
  </li>
  <li>Press <strong>Call Service</strong> to purge their data from the DB. The new data will be collected as soon as an update is triggered (see the <a href="#sampling">Sampling</a> section).</li>
</ol>

<p>Of course, there are other <code class="language-plaintext highlighter-rouge">recorder</code> services available in the Developer Tools &gt; Services tab. Feel free to explore them.</p>

<h3 id="long-term-statistics">Long-term statistics</h3>
<p><a href="https://www.home-assistant.io/blog/2021/08/04/release-20218/">Release 2021.8.0</a> has introduced a new feature for sensors called <a href="https://developers.home-assistant.io/docs/core/entity/sensor/#long-term-statistics"><strong>long-term statistics</strong></a>. In brief, sensor data (e.g., the state value and the sensor attributes) are stored on the <code class="language-plaintext highlighter-rouge">states</code> table of the HASS DB.  Now, however, sensors that <strong>opt-in</strong> for long-term statistics have three summary statistics (<code class="language-plaintext highlighter-rouge">mean</code>, <code class="language-plaintext highlighter-rouge">min</code>, and <code class="language-plaintext highlighter-rouge">max</code>) stored on a new table of the HASS DB, called <code class="language-plaintext highlighter-rouge">statistics</code>. The <code class="language-plaintext highlighter-rouge">statistics</code> data are unaffected by the <code class="language-plaintext highlighter-rouge">recorder</code> configuration in the <code class="language-plaintext highlighter-rouge">configuration.yaml</code> file and therefore, it allows users to keep summary statistics for longer than the <code class="language-plaintext highlighter-rouge">recorder</code> configuration allows to keep data in the <code class="language-plaintext highlighter-rouge">states</code> table.</p>

<p>The summary statistics are stored on an <strong>hourly</strong> basis. That is, if a sensor has stored five data points between 2PM and 3PM, then for each summary statistic, there will be a single data point for the 2-3PM time window that summarize the five data points in the <code class="language-plaintext highlighter-rouge">states</code> table.  Therefore, making use of such a feature only makes sense if your sensor stores more than a single data point per hour.</p>

<p>Currently, there are two types of long-term statistics that are stored on the <code class="language-plaintext highlighter-rouge">statistics</code> table of the HASS DB, all of which <strong>must include</strong> the <code class="language-plaintext highlighter-rouge">state_class: measurement</code> property and thus must refer to <strong>present time</strong> measurement (e.g., current temperature, current humidity):</p>

<ol>
  <li>
    <p><strong>Metered</strong> entities: Apply to any sensor that has cumulative values <em>until a reset point</em>, such as energy consumption meters. All such sensors <strong>must include</strong> the <a href="https://developers.home-assistant.io/docs/core/entity/sensor/#properties"><code class="language-plaintext highlighter-rouge">last_reset</code></a> property, which specifies a <code class="language-plaintext highlighter-rouge">datetime</code> in which the values reset.</p>
  </li>
  <li>
    <p><strong>Value</strong> entities: Apply to any non-cumulative sensor that belongs to a supported <a href="https://developers.home-assistant.io/docs/core/entity/sensor/#available-device-classes">device class</a>.  Naturally, all such sensors <strong>must include</strong> the <a href="https://developers.home-assistant.io/docs/core/entity/sensor/#properties"><code class="language-plaintext highlighter-rouge">device_class</code></a> property.</p>
  </li>
</ol>

<p>Many integrations are currently configured to store summary statistics on the <code class="language-plaintext highlighter-rouge">statistics</code> table of the HASS DB, so you might not need to manually configure anything at all.  However, support for long-term statistics is still quite limited. As far as I can tell, the only other feature that makes use of the data in the <code class="language-plaintext highlighter-rouge">statistics</code> table is the new <a href="https://www.home-assistant.io/lovelace/statistics-graph/">Statistics Card Graph</a>, which is mentioned later on in the <a href="#visualizing-analytical-data">Visualizing analytical data</a> section.</p>

<h2 id="statistics">Statistics</h2>
<p>You don’t need to be a mathematician who specialized in statistics to make use of it.  In this guide, we will only make reference to very introductory statistical knowledge, such as measures of central tendency (e.g., mean, median), variability (e.g., variance, standard deviation) and simple (univariate) linear regression (e.g., gradient/slope).</p>

<p><a href="/assets/posts/2021-06-04-smarter-hass/humor-stats.png"><img src="/assets/posts/2021-06-04-smarter-hass/humor-stats.png" alt="Humor about stats" class="PostImage PostImage--large" /></a></p>

<p>The goal in this guide is to present a starting point for more advanced usage of analytical tools in home automation systems.  The possibilities are endless for knowledgeable users (e.g., application of Bayesian methods, dynamic mixed-effects modeling) and how far you will go along these paths is up to you.</p>

<p>If you want to refresh your stats knowledge or dig deeper into it, save some time and take a look at the following resources:</p>

<ul>
  <li>Reading material:
    <ul>
      <li><a href="https://www.amazon.com/Statistics-11th-Robert-S-Witte/dp/1119386055">Robert Witte &amp; John Witte’s textbook called <strong>Statistics</strong></a></li>
      <li><a href="https://www.amazon.com/All-Statistics-Statistical-Inference-Springer-ebook-dp-B00HWUVSJS/dp/B00HWUVSJS/">Larry Wasserman’s textbook called <strong>All of Statistics</strong></a></li>
    </ul>
  </li>
  <li>Basic stats refresher:</li>
</ul>

<!-- Courtesy of embedresponsively.com //-->
<div class="responsive-video-container">

  <iframe src="https://www.youtube-nocookie.com/embed/xxpc-HPKN28" frameborder="0" allowfullscreen=""></iframe>

</div>

<p><a href="#" class="btn btn--light-outline btn--small">top</a></p>

<h1 id="implementation">Implementation</h1>
<p>The main functionalities in HASS are extended by the configuration of new <strong>integrations</strong>.  According to the <a href="https://www.home-assistant.io/docs/glossary/">HASS Glossary</a>,</p>

<blockquote>
  <p><a href="https://www.home-assistant.io/integrations/">Integrations</a> provide the core logic for the functionality in Home Assistant.</p>
</blockquote>

<p>Therefore, the analytical tools covered in this guide are implemented by one or more of the <strong>1800</strong> integrations that are currently supported by a community of home automation enthusiasts.  More specifically, most of the analytical tools are grouped under <a href="https://www.home-assistant.io/integrations/#utility">Utility</a> integrations and in this guide, I will only cover the following three:</p>

<ol>
  <li><a href="#history-stats">History Stats</a></li>
  <li><a href="#statistics-1">Statistics</a></li>
  <li><a href="#trend">Trend</a></li>
</ol>

<p>The current set of analytical integrations is fairly limited in what it can do.  For the most part, the tools can be used to create summary statistics of the past states and measurements of integrated devices and sensors.  Inference-wise, a lot can be done via <a href="https://www.home-assistant.io/docs/configuration/templating/">templates</a> but moving forward, there is a need for more advanced analytical integrations.  For this reason, at the end of this guide, I added a section about <a href="#development">Development</a> for anyone interested in helping out.  First, however, we need to talk about <a href="#data">Data</a> and <a href="#sampling">Sampling</a>.</p>

<h2 id="data">Data</h2>
<p>Before delving into any analytical integration, there are at least three things that we need to do. First, we need to think about the nature of the data.  For example, consider the default <a href="https://www.home-assistant.io/integrations/sun/">Sun</a> (<code class="language-plaintext highlighter-rouge">sun.sun</code>) entity in HASS:</p>

<p><a href="/assets/posts/2021-06-04-smarter-hass/hass-entity-sun.jpg"><img src="/assets/posts/2021-06-04-smarter-hass/hass-entity-sun.jpg" alt="Sun entity" class="PostImage" /></a></p>

<p>While the <code class="language-plaintext highlighter-rouge">sun.sun</code> <em>state</em> is a <strong>discrete</strong> variable (it’s either <code class="language-plaintext highlighter-rouge">above_horizon</code> or <code class="language-plaintext highlighter-rouge">below_horizon</code>), its <code class="language-plaintext highlighter-rouge">elevation</code> <em>attribute</em> is actually <strong>continuous</strong> (e.g., <code class="language-plaintext highlighter-rouge">35.84</code>° between the sun and the horizon) and therefore, it doesn’t make sense to use the same tools to analyze both of them.  Nonetheless, discrete variables can be transformed into continuous ones (e.g., the sun was <code class="language-plaintext highlighter-rouge">above_horizon</code> for <code class="language-plaintext highlighter-rouge">34.1</code>% of the day), and similarly, continuous variables can be discretised (e.g., the elevation is either <code class="language-plaintext highlighter-rouge">negative</code> or <code class="language-plaintext highlighter-rouge">positive</code> or <code class="language-plaintext highlighter-rouge">zero</code>) in order to better answer our questions of interest.</p>

<p>Second, we need to check whether HASS is keeping track of the data we need. There are multiple ways of doing that but by far, the easiest method is to navigate to <strong>Developer Tools</strong> &gt; States and then make sure that the entities whose states and attributes we would like to keep track of are being listed there.  (Alternatively, you can open the HASS DB with a SQL browser and look for the entity in the <code class="language-plaintext highlighter-rouge">states</code> Table.)</p>

<p><a href="/assets/posts/2021-06-04-smarter-hass/hass-developer-tools-states.jpg"><img src="/assets/posts/2021-06-04-smarter-hass/hass-developer-tools-states.jpg" alt="HASS developer tools states" class="PostImage PostImage--large" /></a></p>

<p>Third, we need to check how the data are being represented in the DB.  As in the previous example, some variables might be an attribute of an existing entity in the HASS DB.  If the <code class="language-plaintext highlighter-rouge">recorder:</code> settings for such entity are fine for the type of analysis you want to automate (e.g., purge every 10 days), then you are all set.  However, notice that <em>attributes</em> cannot be displayed the same way as the <em>states</em> of an entity in the HASS webUI.  In addition, you might want to <strong>pre-process</strong> the attributes (e.g., <code class="language-plaintext highlighter-rouge">float</code> and then <code class="language-plaintext highlighter-rouge">round(2)</code>) or perform transformations before running the analysis.</p>

<p>For all such reasons, I always create <strong>new entities</strong> for the variables that will be analyzed. This is accomplished with the <a href="https://www.home-assistant.io/integrations/template/"><code class="language-plaintext highlighter-rouge">template</code> integration</a>.  Per the HASS wiki:</p>

<blockquote>
  <p>The template integration allows creating entities which derive their values from other data. This is done by specifying templates for properties of an entity, like the name or the state.</p>
</blockquote>

<p><a href="https://www.home-assistant.io/docs/configuration/templating/#building-templates">Building templates</a> is fairly easy once you get the hang of the syntax.  In short, templates follow the <a href="https://palletsprojects.com/p/jinja"><strong>Jinja2</strong> templating engine</a> and are mainly used to perform mathematical operations (<code class="language-plaintext highlighter-rouge">+</code>, <code class="language-plaintext highlighter-rouge">-</code>, <code class="language-plaintext highlighter-rouge">*</code>, <code class="language-plaintext highlighter-rouge">/</code>) and logic tests (if __ , then __ ) but can also do loops (for <code class="language-plaintext highlighter-rouge">i</code> in <code class="language-plaintext highlighter-rouge">states.sensor</code>, __ ), for example.  As a result, templates give users a scripting tool to go beyond the HASS built-in functionalities.  To test and preview a customized template, use the <strong>Developer Tools</strong> &gt; Template tab:</p>

<p><a href="/assets/posts/2021-06-04-smarter-hass/hass-developer-tools-template.jpg"><img src="/assets/posts/2021-06-04-smarter-hass/hass-developer-tools-template.jpg" alt="HASS developer tools template" class="PostImage PostImage--large" /></a></p>

<p>As an example, let’s create an entity to store and round to zero the <code class="language-plaintext highlighter-rouge">sun.sun</code> <code class="language-plaintext highlighter-rouge">elevation</code> attribute.  First, in the <code class="language-plaintext highlighter-rouge">configuration.yaml</code>, <strong>append</strong> (add to the bottom) a reference to the <code class="language-plaintext highlighter-rouge">templates.yaml</code> configuration file:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Templates</span>
<span class="na">template</span><span class="pi">:</span> <span class="kt">!include</span> <span class="s">templates.yaml</span>
</code></pre></div></div>

<p>Then, use a text editor to create an empty <code class="language-plaintext highlighter-rouge">templates.yaml</code> file and create a sensor template for the sun elevation, as follows:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Sensor templates</span>
<span class="pi">-</span> <span class="na">sensor</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">template</span><span class="nv"> </span><span class="s">sun</span><span class="nv"> </span><span class="s">elevation"</span>
      <span class="na">unit_of_measurement</span><span class="pi">:</span> <span class="s2">"</span><span class="s">°"</span>
      <span class="na">state</span><span class="pi">:</span> <span class="pi">&gt;</span>
        <span class="s">{{ state_attr('sun.sun', 'elevation') | float | round(0) }}</span>
</code></pre></div></div>

<p>Notice that in <code class="language-plaintext highlighter-rouge">state:</code>, we use <code class="language-plaintext highlighter-rouge">state_attr()</code> to retrieve the <code class="language-plaintext highlighter-rouge">elevation</code> attribute of the <code class="language-plaintext highlighter-rouge">sun.sun</code> entity. Then, we use <code class="language-plaintext highlighter-rouge">float</code> to force the output to a <a href="https://en.wikipedia.org/wiki/Floating-point_arithmetic">floating point number</a>, which ensures that the output is interpreted as a number, and run <code class="language-plaintext highlighter-rouge">round(0)</code> on the numeric output to round the decimals to zero cases.  The result should be an <a href="https://en.wikipedia.org/wiki/Integer">integer</a> of the Sun elevation.  (Alternatively, we could simply use <code class="language-plaintext highlighter-rouge">int</code> to convert the output to an integer, of course.)</p>

<p class="notice">I find the use of the folded style (<code class="language-plaintext highlighter-rouge">&gt;</code>) very helpful in keeping the templates organized. Refer to the <a href="https://yaml.org/spec/1.2/spec.html">YAML - Scalars</a> documentation for more information.</p>

<p>Check your <code class="language-plaintext highlighter-rouge">configuration.yaml</code> file for errors (Configuration &gt; Server Controls &gt; Configuration validation), and finally, <strong>restart your HASS</strong>.  Afterwards, navigate to Developers Tools &gt; States and if everything is correct, you should see a new <code class="language-plaintext highlighter-rouge">sensor.template_sun_elevation</code> entity:</p>

<p><a href="/assets/posts/2021-06-04-smarter-hass/hass-entity-template-sun-elevation.jpg"><img src="/assets/posts/2021-06-04-smarter-hass/hass-entity-template-sun-elevation.jpg" alt="HASS template sun elevation" class="PostImage PostImage--large" /></a></p>

<p>By default, the values of this newly created entity will update as soon as the Sun <code class="language-plaintext highlighter-rouge">elevation</code> attribute changes. However, it is also possible to configure different <strong>triggers</strong> for <strong>template entities</strong>.  This is particularly relevant for the next topic, namely data sampling.</p>

<h2 id="sampling">Sampling</h2>
<p>Devices, sensors, and services measure and transmit data with a certain frequency, which I refer by the term <strong>measurement resolution</strong>.  Such a resolution might be determined by a time-based rule (e.g., every 1 sec) or an event (HTTP request) or a combination of both.  Regardless of the nature of the trigger, the <em>higher</em> the measurement resolution, the more frequent the observations are.  For example, an <a href="https://www.espressif.com/en/products/devkits">ESP32 Development board</a> connected to a <a href="https://www.bosch-sensortec.com/products/environmental-sensors/humidity-sensors-bme280/">BME280 environmental sensor</a> might send a temperature measurement every 5 minutes to a MQTT broker.  Therefore, for all intended purposes, the measurement resolution of such a temperature sensor is at best 5 minutes.  Now, if a second ESP32 measures and send data <em>every 1 minute</em> instead, then the measurement resolution of the latter ESP32 is higher than the former (i.e., we can expect it to send temperature data more frequently).</p>

<p>As mentioned before, in HASS, <strong>template entities</strong> follow state-based updates by default–that is, they update as soon as the data of any of the referenced entities change.  Let’s say that over a 20-min window, none of the referenced data changed.  This means that the template entity also didn’t change and more importantly, in the DB, there will be a <em>single data point</em> over the 20-min window.  However, let’s say that over the same 20-min window, one of the referenced data changed twice. This means that the template entity now changed twice and more importantly, in the DB, there will be <em>three data points</em> over the 20-min window.  This a very efficient way of storing data but you can probably see how this might affect the usage of analytical tools, owing to an inconsistent number of data points over equal time-frames as well as the under-representation of data over time.</p>

<p>Fortunately, just like we specify triggers for automations, HASS offers the possibility to specify <a href="https://www.home-assistant.io/integrations/template/#trigger-based-template-sensors">triggers for template entities</a>.  There’s a large variety of triggers that can be used here (e.g, <code class="language-plaintext highlighter-rouge">webhook</code>, <code class="language-plaintext highlighter-rouge">mqtt</code>) but for <strong>longitudinal analysis</strong>, the most useful one is the <a href="https://www.home-assistant.io/docs/automation/trigger#time-pattern-trigger"><strong>time pattern</strong> trigger</a>, which is aptly called <code class="language-plaintext highlighter-rouge">time_pattern</code>.  Time pattern triggers can be specified for hours (<code class="language-plaintext highlighter-rouge">hours:</code>), minutes (<code class="language-plaintext highlighter-rouge">minutes:</code>), and seconds (<code class="language-plaintext highlighter-rouge">seconds:</code>), and for each one, it’s possible to prefix the value with a <code class="language-plaintext highlighter-rouge">/</code> to match whenever the current value is divisible by the specified value (e.g., <code class="language-plaintext highlighter-rouge">hours: "/2"</code> will match every 2 hours) or use <code class="language-plaintext highlighter-rouge">*</code> to match any value (e.g., <code class="language-plaintext highlighter-rouge">minutes: "*"</code> to match every minute).</p>

<p>To create a time pattern trigger for one or more template entity sensor, simply add a list of time-based <code class="language-plaintext highlighter-rouge">sensor:</code> and <code class="language-plaintext highlighter-rouge">binary_sensor:</code> under a <code class="language-plaintext highlighter-rouge">trigger:</code> configuration in the <code class="language-plaintext highlighter-rouge">templates.yaml</code> configuration file, as follows:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Time pattern trigger</span>
<span class="pi">-</span> <span class="na">trigger</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">time_pattern</span>
      <span class="c1"># Update every 5 minutes</span>
      <span class="na">minutes</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/5"</span>
  <span class="c1"># Sensor templates</span>
  <span class="na">sensor</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">template</span><span class="nv"> </span><span class="s">sun</span><span class="nv"> </span><span class="s">elevation</span><span class="nv"> </span><span class="s">-</span><span class="nv"> </span><span class="s">time-based"</span>
      <span class="na">unit_of_measurement</span><span class="pi">:</span> <span class="s2">"</span><span class="s">°"</span>
      <span class="na">state</span><span class="pi">:</span> <span class="pi">&gt;</span>
        <span class="s">{{ state_attr('sun.sun', 'elevation') | float | round(0) }}</span>
      <span class="na">attributes</span><span class="pi">:</span>
        <span class="na">timestamp</span><span class="pi">:</span> <span class="pi">&gt;</span>
          <span class="s">{{ as_timestamp(now()) }}</span>
</code></pre></div></div>

<p>Of note, the <code class="language-plaintext highlighter-rouge">timestamp:</code> under <code class="language-plaintext highlighter-rouge">attributes:</code> forces HASS to create a new entry on the DB (update) whenever the template is triggered.  This keeps the number of data points constant over time and each one of them will have a timestamp as attribute.  (In the DB, you will also see that if the state remained unchanged, it maintains the correct <code class="language-plaintext highlighter-rouge">last_changed</code> date and updates the <code class="language-plaintext highlighter-rouge">last_updated</code> variable.)</p>

<p>Also, notice that it does not make sense to use a <code class="language-plaintext highlighter-rouge">time_pattern</code> trigger rule that has higher resolution than the device’s <em>measurement</em> resolution because then, there’s no chance for a new value to occur and the DB would just repeat the last transmitted measurement.  Ideally, the time pattern should <strong>match the measurement resolution</strong> but to save space, you might want to set a lower time pattern resolution (as in 1:2, or 1:4, and so on).</p>

<p class="notice notice--warning">Beware that depending on how triggers are configured and how many template entities are created, the HASS DB might end up using <strong>a lot of space</strong> and computations are bound to use <strong>ever more CPU (and possibly RAM) resources</strong>, owing to the number of entries in the DB.  Be sure to monitor such resources after configuring your HASS instance; Otherwise, your HASS instance might experience serious problems.</p>

<p>Finally, there is the topic of statistical sampling (representativeness) when it comes to making generalizations from a couple of samples (e.g., environmental sensors in my bedroom and kitchen) to a population (temperature and humidity in my entire house).  In this guide, however, we will not delve too far into statistical inferences, owing to limitations of the current set of analytical tools.  Nonetheless, extended <strong>service outages</strong>, for example, might comprise summary statistics.  For proper representation, it is fundamental that your HASS has been running and collecting data for as long as the monitored time period of any statistic.  To put it in simple, a sensor that monitors weekly activity, for example, won’t make sense until your HASS instance has been running and collecting data over at least one week.</p>

<h2 id="utilities">Utilities</h2>
<p>The <a href="https://www.home-assistant.io/integrations/#utility"><strong>Utility integrations</strong></a> offer users tools to parse and analyze data from recorded entities.  There are more than 30 different such integrations and they sometimes have overlapping functionalities.  For example, the gradient (ratio of change) over the last two data points can be computed by both the <a href="https://www.home-assistant.io/integrations/trend/">Trend</a> integration and the <a href="https://www.home-assistant.io/integrations/derivative/">Derivative</a>.  In what follows, I covered only three of the utility integrations that I find most comprehensive and useful, namely:</p>

<ol>
  <li><a href="#history-stats">History Stats</a></li>
  <li><a href="#statistics-1">Statistics</a></li>
  <li><a href="#trend">Trend</a></li>
</ol>

<p>Trend is covered last because out of the set, it’s the only one that actually makes use of inferential tools via the Python package <code class="language-plaintext highlighter-rouge">numpy</code>. The others provide counting, other mathematical resources, and ways of summarize historical data.  For each utility, I provided a brief description, usage examples to follow along, and reference to the documentation and source code.</p>

<h3 id="history-stats">History Stats</h3>
<p>The <a href="https://www.home-assistant.io/integrations/history_stats/">History Stats</a> integration provides useful statistics for discrete variables over a user-specified time-range.  More specifically, this integration can do one of three things depending on the chosen type of sensor:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">type: time</code>: calculate the <em>amount of hours</em> that an entity has spent on a given state;</li>
  <li><code class="language-plaintext highlighter-rouge">type: ratio</code>: calculate the <em>percentage of time</em> that an entity has spent on a given state;</li>
  <li><code class="language-plaintext highlighter-rouge">type: count</code>: count how many times an entity has changed to a given state.</li>
</ul>

<p>The use of this integration requires specification of <strong>at least two</strong> of the following time period variables:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">start:</code>: It indicates when the time period starts.  Use <a href="https://www.home-assistant.io/docs/configuration/templating/#time">time templating</a> to specify the time;</li>
  <li><code class="language-plaintext highlighter-rouge">end:</code>: It indicates when the time period ends.  Use <a href="https://www.home-assistant.io/docs/configuration/templating/#time">time templating</a> to specify the time;</li>
  <li><code class="language-plaintext highlighter-rouge">duration:</code>: It indicates how long the time period lasts.  If <code class="language-plaintext highlighter-rouge">start:</code> is specified, then how long forwards;  if <code class="language-plaintext highlighter-rouge">end:</code> is specified, then how long backwards.  The syntax can be either the traditional <code class="language-plaintext highlighter-rouge">HH:MM:SS</code> format or as follows:
    <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">duration</span><span class="pi">:</span>
  <span class="na">days</span><span class="pi">:</span> <span class="m">2</span>
  <span class="na">hours</span><span class="pi">:</span> <span class="m">4</span>
  <span class="na">minutes</span><span class="pi">:</span> <span class="m">15</span>
  <span class="na">seconds</span><span class="pi">:</span> <span class="m">30</span>
</code></pre></div>    </div>
  </li>
</ul>

<h4 id="usage-examples">Usage examples</h4>
<p><code class="language-plaintext highlighter-rouge">history_stats</code> are defined as a platform (<code class="language-plaintext highlighter-rouge">- platform: history_stats</code>) under <code class="language-plaintext highlighter-rouge">sensor:</code> in your <code class="language-plaintext highlighter-rouge">configuration.yaml</code> file.  To keep things organized, go to the <code class="language-plaintext highlighter-rouge">configuration.yaml</code> and append a reference to <code class="language-plaintext highlighter-rouge">sensors.yaml</code>, as follows:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Sensors</span>
<span class="na">sensor</span><span class="pi">:</span> <span class="kt">!include</span> <span class="s">sensors.yaml</span>
</code></pre></div></div>

<p>Then using a text editor, create a <code class="language-plaintext highlighter-rouge">sensors.yaml</code> file where we will configure the following three <code class="language-plaintext highlighter-rouge">history_stats</code> sensors to consume the data from the default <a href="https://www.home-assistant.io/integrations/weather/"><code class="language-plaintext highlighter-rouge">weather.home</code></a> entity:</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">sunny yesterday hours</code>: Number of hours that the <code class="language-plaintext highlighter-rouge">weather.home</code> entity remained in the <code class="language-plaintext highlighter-rouge">sunny</code> state <em>yesterday</em>;</li>
  <li><code class="language-plaintext highlighter-rouge">cloudy today ratio</code>: Percentage of time that the <code class="language-plaintext highlighter-rouge">weather.home</code> entity remained in the <code class="language-plaintext highlighter-rouge">cloudy</code> state <em>today</em>;</li>
  <li><code class="language-plaintext highlighter-rouge">rainy week count</code>: Number of times that the <code class="language-plaintext highlighter-rouge">weather.home</code> entity changed to the <code class="language-plaintext highlighter-rouge">rainy</code> state over the <em>last seven days</em>.</li>
</ol>

<p class="notice">The <a href="https://www.home-assistant.io/integrations/met/">Meteorologisk institutt (Met.no)</a> is the current default meteorological information service used by HASS. This integration’s measurement resolution is 1 hour (via cloud polling) and it follows state-based updates (a new entry in the DB is only created if any of the values has changed).</p>

<p>To create those three <code class="language-plaintext highlighter-rouge">history_stats</code> sensor entities, append the following to <code class="language-plaintext highlighter-rouge">sensors.yaml</code>:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># History Stats</span>
<span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">history_stats</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">sunny</span><span class="nv"> </span><span class="s">yesterday</span><span class="nv"> </span><span class="s">hours"</span>
  <span class="na">entity_id</span><span class="pi">:</span> <span class="s">weather.home</span>
  <span class="na">state</span><span class="pi">:</span> <span class="s2">"</span><span class="s">sunny"</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">time</span>
  <span class="c1"># end today at 00:00:00</span>
  <span class="na">end</span><span class="pi">:</span> <span class="pi">&gt;</span>
    <span class="s">{{ now().replace(hour=0, minute=0, second=0) }}</span>
  <span class="c1"># start 24h before the end time</span>
  <span class="na">duration</span><span class="pi">:</span>
    <span class="na">hours</span><span class="pi">:</span> <span class="m">24</span>
<span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">history_stats</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">cloudy</span><span class="nv"> </span><span class="s">today</span><span class="nv"> </span><span class="s">ratio"</span>
  <span class="na">entity_id</span><span class="pi">:</span> <span class="s">weather.home</span>
  <span class="na">state</span><span class="pi">:</span> <span class="s2">"</span><span class="s">cloudy"</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">ratio</span>
  <span class="c1"># start today at 00:00:00</span>
  <span class="na">start</span><span class="pi">:</span> <span class="pi">&gt;</span>
    <span class="s">{{ now().replace(hour=0, minute=0, second=0) }}</span>
  <span class="c1"># end right now</span>
  <span class="na">end</span><span class="pi">:</span> <span class="pi">&gt;</span>
    <span class="s">{{ now() }}</span>
<span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">history_stats</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">rainy</span><span class="nv"> </span><span class="s">week</span><span class="nv"> </span><span class="s">count"</span>
  <span class="na">entity_id</span><span class="pi">:</span> <span class="s">weather.home</span>
  <span class="na">state</span><span class="pi">:</span> <span class="s2">"</span><span class="s">rainy"</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">count</span>
  <span class="c1"># end right now</span>
  <span class="na">end</span><span class="pi">:</span> <span class="pi">&gt;</span>
    <span class="s">{{ now() }}</span>
  <span class="c1"># start 7 days before the end time</span>
  <span class="na">duration</span><span class="pi">:</span>
    <span class="na">days</span><span class="pi">:</span> <span class="m">7</span>
</code></pre></div></div>

<p>Now <strong>check your configuration file</strong> and if everything looks good, <strong>restart HASS</strong>.  Afterwards, check your <strong>log</strong> file for related errors and if it all looks good, then head to <strong>Developer Tools</strong> &gt; States and you should now see the three new entities we just created:</p>

<p><a href="/assets/posts/2021-06-04-smarter-hass/hass-utility-historystats.jpg"><img src="/assets/posts/2021-06-04-smarter-hass/hass-utility-historystats.jpg" alt="HASS utility history stats" class="PostImage PostImage--large" /></a></p>

<p>In the example above, it’s been cloudy for 2.6% of the time today, we had roughly 10 hours of sunny weather yesterday, and the weather changed to rainy 5 times over the week.</p>

<p class="notice--warning">Because I have not been running HASS and collecting <code class="language-plaintext highlighter-rouge">weather.home</code> data over this week in a reliable way, <strong>the reported metrics can be quite misleading</strong>, as noted in the <a href="#sampling">Sampling</a> section.  For a proper representation of the statistics over the configured time-range, make sure to keep your HASS instance running (and in this case, check that the cloud polling has been working without extended service outages) for at least as long as the configured time-range.</p>

<h4 id="additional-references">Additional references</h4>
<ul>
  <li>History Stats <strong>documentation</strong>: <a href="https://www.home-assistant.io/integrations/history_stats/">https://www.home-assistant.io/integrations/history_stats/</a></li>
  <li>History Stats <strong>source</strong>: <a href="https://github.com/home-assistant/core/tree/dev/homeassistant/components/history_stats">https://github.com/home-assistant/core/tree/dev/homeassistant/components/history_stats</a></li>
</ul>

<p><a href="#utilities" class="btn btn--info btn--small">Utilities</a></p>

<h3 id="statistics-1">Statistics</h3>
<p>The <a href="https://www.home-assistant.io/integrations/statistics/">Statistics</a> integration is by far the most useful integration for describing the past values from other entities.  In brief, it consumes the data from another entity and returns the traditional descriptive measures of central tendency (<code class="language-plaintext highlighter-rouge">mean</code> and <code class="language-plaintext highlighter-rouge">median</code>) and variability (<code class="language-plaintext highlighter-rouge">quantiles</code>, <code class="language-plaintext highlighter-rouge">variance</code>, <code class="language-plaintext highlighter-rouge">standard_deviation</code>, <code class="language-plaintext highlighter-rouge">min_value</code>, <code class="language-plaintext highlighter-rouge">max_value</code>), as well as a few other descriptive measures.</p>

<p>Similarly to the <a href="#history-stats">History Stats</a> integration, the Statistics integration has <strong>two time period variables</strong>:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">sampling_size</code>: The maximum number of data points to be used within the <code class="language-plaintext highlighter-rouge">max_age</code> interval in <strong>descending order</strong> (oldest to newest). By default, it is <code class="language-plaintext highlighter-rouge">20</code>;</li>
  <li><code class="language-plaintext highlighter-rouge">max_age</code>: The maximum age of the oldest data point. This variable is equivalent to <code class="language-plaintext highlighter-rouge">duration:</code> in the <a href="#history-stats">History Stats</a> when <code class="language-plaintext highlighter-rouge">end: {{ now() }}</code> and similarly, its time syntax can be defined in the traditional <code class="language-plaintext highlighter-rouge">HH:MM:SS</code> format or the following:
    <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">max_age</span><span class="pi">:</span>
  <span class="na">days</span><span class="pi">:</span> <span class="m">3</span>
  <span class="na">hours</span><span class="pi">:</span> <span class="m">6</span>
  <span class="na">minutes</span><span class="pi">:</span> <span class="m">10</span>
  <span class="na">seconds</span><span class="pi">:</span> <span class="m">45</span>
</code></pre></div>    </div>
    <p>That is, <code class="language-plaintext highlighter-rouge">max_age</code> specifies an interval relative to <code class="language-plaintext highlighter-rouge">now()</code> in which the Statistics integration will collect a maximum number of data points equal to the <code class="language-plaintext highlighter-rouge">sampling_size</code> (e.g., <code class="language-plaintext highlighter-rouge">20</code>) in <strong>descending</strong> order. If <code class="language-plaintext highlighter-rouge">max_age</code> is not specified, then it spans until the last value in the HASS DB for the given <code class="language-plaintext highlighter-rouge">entity_id</code>.</p>
  </li>
</ul>

<p>To illustrate how the specification of time works in this integration, let’s suppose we create a template sensor that triggers every <strong>5 min</strong> and <strong>forces an update</strong> (DB entry), such as the <code class="language-plaintext highlighter-rouge">sensor.template_sun_elevation_time_based</code> from the <a href="#sampling">Sampling</a> section, and we leave it running for exactly 7 days from now.  Therefore, the HASS DB collects 12 data points <em>per hour</em> for this template sensor, 288 data points <em>per day</em>, and 2016 data points <em>per week</em>.  Now, because the <code class="language-plaintext highlighter-rouge">sampling_size</code> works in <strong>descending order</strong>, by default, it will compute statistics for the <code class="language-plaintext highlighter-rouge">20</code> oldest data points, which will range from exactly <code class="language-plaintext highlighter-rouge">7 days old</code> to <code class="language-plaintext highlighter-rouge">6 days, 22 hours, and 20 minutes old</code> (or simply from <code class="language-plaintext highlighter-rouge">oldest</code> until <code class="language-plaintext highlighter-rouge">100 minutes</code> afterwards).  However, if we also specified the <code class="language-plaintext highlighter-rouge">max_age</code> to 3 days ago, as follows:</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">max_age</span><span class="pi">:</span>
  <span class="na">days</span><span class="pi">:</span> <span class="m">3</span>
</code></pre></div></div>
<p>then the time-range would instead span from exactly <code class="language-plaintext highlighter-rouge">3 days old</code> to <code class="language-plaintext highlighter-rouge">2 days, 22 hours, 20 minutes old</code>.  Finally, because there will be 288 data points per day, if we set <code class="language-plaintext highlighter-rouge">sampling_size: 288</code> in the last example, then the time-range would instead span from exactly <code class="language-plaintext highlighter-rouge">3 days old</code> to <code class="language-plaintext highlighter-rouge">2 days old</code>.</p>

<p>While proper configuration of the <code class="language-plaintext highlighter-rouge">sampling_size</code> and <code class="language-plaintext highlighter-rouge">max_age</code> allow for the specification of a variety of different time-ranges, it does require clear understanding of the entity’s <strong>measurement resolution</strong> and how it is updated in the DB because otherwise, the computed statistics are bound to misrepresent the desired time-ranges.  I feel the <a href="#history-stats">History Stats</a> integration is more flexible and precise in its definition of the time-range by using the more intuitive <code class="language-plaintext highlighter-rouge">start:</code>, <code class="language-plaintext highlighter-rouge">end:</code>, and <code class="language-plaintext highlighter-rouge">duration:</code> time variables.  For example, the <a href="https://www.home-assistant.io/docs/configuration/templating/#time">time templating</a> used in the History Stats integration allows for the specification of any hour of any day (e.g., start yesterday at <code class="language-plaintext highlighter-rouge">00:00:00</code> and end today at <code class="language-plaintext highlighter-rouge">00:00:00</code>), whereas such level of precision is not possible with the Statistics integration alone.</p>

<h4 id="usage-examples-1">Usage examples</h4>
<p>As before, <code class="language-plaintext highlighter-rouge">statistics</code> are defined as a platform (<code class="language-plaintext highlighter-rouge">- platform: statistics</code>) under <code class="language-plaintext highlighter-rouge">sensor:</code> in your <code class="language-plaintext highlighter-rouge">configuration.yaml</code> file.  In this example, we will configure two <code class="language-plaintext highlighter-rouge">statistics</code> sensors to consume the data from the <code class="language-plaintext highlighter-rouge">sensor.template_sun_elevation_time_based</code> entity:</p>

<ol>
  <li>
    <p><code class="language-plaintext highlighter-rouge">sun elevation one hour ago</code>: Descriptive measures for the <code class="language-plaintext highlighter-rouge">sensor.template_sun_elevation_time_based</code> over the last one <em>hour</em>;</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">sun elevation one day ago</code>: Descriptive measures for the <code class="language-plaintext highlighter-rouge">sensor.template_sun_elevation_time_based</code> over the last one <em>day</em>.</p>
  </li>
</ol>

<p>To create those two <code class="language-plaintext highlighter-rouge">statistics</code> sensor entities, append the following to the <code class="language-plaintext highlighter-rouge">sensors.yaml</code>:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Statistics</span>
<span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">statistics</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">sun</span><span class="nv"> </span><span class="s">elevation</span><span class="nv"> </span><span class="s">one</span><span class="nv"> </span><span class="s">hour</span><span class="nv"> </span><span class="s">ago"</span>
  <span class="na">entity_id</span><span class="pi">:</span> <span class="s">sensor.template_sun_elevation_time_based</span>
  <span class="c1"># measurement resolution is 5/min</span>
  <span class="na">sampling_size</span><span class="pi">:</span> <span class="m">12</span>
  <span class="na">max_age</span><span class="pi">:</span>
    <span class="na">hours</span><span class="pi">:</span> <span class="m">1</span>
<span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">statistics</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">sun</span><span class="nv"> </span><span class="s">elevation</span><span class="nv"> </span><span class="s">one</span><span class="nv"> </span><span class="s">day</span><span class="nv"> </span><span class="s">ago"</span>
  <span class="na">entity_id</span><span class="pi">:</span> <span class="s">sensor.template_sun_elevation_time_based</span>
  <span class="c1"># measurement resolution is 5/min</span>
  <span class="na">sampling_size</span><span class="pi">:</span> <span class="m">288</span>
  <span class="na">max_age</span><span class="pi">:</span>
    <span class="na">days</span><span class="pi">:</span> <span class="m">1</span>
</code></pre></div></div>

<p>Now <strong>check your configuration file</strong> and if everything looks good, <strong>restart HASS</strong>. Afterwards, check your log file for related errors and if it all looks good, then head to <strong>Developer Tools</strong> &gt; States and you should now see the two new entities we just created:</p>

<p><a href="/assets/posts/2021-06-04-smarter-hass/hass-utility-statistics-01.jpg"><img src="/assets/posts/2021-06-04-smarter-hass/hass-utility-statistics-01.jpg" alt="HASS utility statistics 01" class="PostImage PostImage--large" /></a></p>

<p>Notice that in <code class="language-plaintext highlighter-rouge">sensor.sun_elevation_one_day_ago</code>, the number of actual data points (<code class="language-plaintext highlighter-rouge">count: 101</code>) is lower than expected for this time-range (<code class="language-plaintext highlighter-rouge">sampling_size: 288</code>).  This happened because my HASS instance has not been collecting the <code class="language-plaintext highlighter-rouge">elevation</code> attribute  data from the <code class="language-plaintext highlighter-rouge">sun.sun</code> entity in a reliable fashion over the last day.  However, in <code class="language-plaintext highlighter-rouge">sensor.sun_elevation_one_hour_ago</code>, the number of actual data points (<code class="language-plaintext highlighter-rouge">count: 12</code>) is indeed equal to the expected (<code class="language-plaintext highlighter-rouge">sampling_size: 12</code>).  (Also, inspection of the <code class="language-plaintext highlighter-rouge">min_age</code> and <code class="language-plaintext highlighter-rouge">max_age</code> is very useful in making sure that the time-rage is the expected one.)</p>

<p>In addition, any <code class="language-plaintext highlighter-rouge">statistics</code> sensor entity shows the <code class="language-plaintext highlighter-rouge">mean</code> as both <strong>state</strong> and <strong>attribute</strong>.  Other descriptive statistics for each <code class="language-plaintext highlighter-rouge">statistics</code> sensor entity are shown only as <strong>attribute</strong>.  In the example, the Sun has increased in elevation from 34° to 36° over the last hour (<code class="language-plaintext highlighter-rouge">min_value: 34</code>, <code class="language-plaintext highlighter-rouge">max_value: 36</code>, <code class="language-plaintext highlighter-rouge">change: 2</code>), with an average of 35.2° above the horizon (<code class="language-plaintext highlighter-rouge">mean: 35.17</code>).</p>

<p>Now, weather data are much less predictable and subject to multiple sources of variability over time than the <code class="language-plaintext highlighter-rouge">sun.sun</code> metrics.  As mentioned before, however, many of the default weather metrics (e.g., <code class="language-plaintext highlighter-rouge">temperature</code>, <code class="language-plaintext highlighter-rouge">humidity</code>, <code class="language-plaintext highlighter-rouge">pressure</code>) are provided as attributes of a state-based, cloud polling entity–namely, the <code class="language-plaintext highlighter-rouge">weather.home</code> entity that by default uses data from the <a href="https://www.home-assistant.io/integrations/met/">Met.no</a> integration.  This poses multiple challenges to the analysis of the <code class="language-plaintext highlighter-rouge">weather.home</code> data over time but just as before, we can fix it by creating <a href="https://www.home-assistant.io/integrations/template/">time-pattern, template sensors</a> for each relevant attribute.  To do so, append the following to the <code class="language-plaintext highlighter-rouge">templates.yaml</code> configuration file:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">trigger</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">time_pattern</span>
      <span class="c1"># Update every 1 hour</span>
      <span class="na">hours</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/1"</span>
  <span class="c1"># Hourly sensor templates</span>
  <span class="na">sensor</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">template</span><span class="nv"> </span><span class="s">weather</span><span class="nv"> </span><span class="s">temperature</span><span class="nv"> </span><span class="s">-</span><span class="nv"> </span><span class="s">time-based"</span>
      <span class="na">unit_of_measurement</span><span class="pi">:</span> <span class="s2">"</span><span class="s">C"</span>
      <span class="na">state</span><span class="pi">:</span> <span class="pi">&gt;</span>
        <span class="s">{{ state_attr('weather.home', 'temperature') | float | round(1) }}</span>
      <span class="na">attributes</span><span class="pi">:</span>
        <span class="na">timestamp</span><span class="pi">:</span> <span class="pi">&gt;</span>
          <span class="s">{{ as_timestamp(now()) }}</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">template</span><span class="nv"> </span><span class="s">weather</span><span class="nv"> </span><span class="s">humidity</span><span class="nv"> </span><span class="s">-</span><span class="nv"> </span><span class="s">time-based"</span>
      <span class="na">unit_of_measurement</span><span class="pi">:</span> <span class="s2">"</span><span class="s">%"</span>
      <span class="na">state</span><span class="pi">:</span> <span class="pi">&gt;</span>
        <span class="s">{{ state_attr('weather.home', 'humidity') | int }}</span>
      <span class="na">attributes</span><span class="pi">:</span>
        <span class="na">timestamp</span><span class="pi">:</span> <span class="pi">&gt;</span>
          <span class="s">{{ as_timestamp(now()) }}</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">template</span><span class="nv"> </span><span class="s">weather</span><span class="nv"> </span><span class="s">pressure</span><span class="nv"> </span><span class="s">-</span><span class="nv"> </span><span class="s">time-based"</span>
      <span class="na">unit_of_measurement</span><span class="pi">:</span> <span class="s2">"</span><span class="s">hPa"</span>
      <span class="na">state</span><span class="pi">:</span> <span class="pi">&gt;</span>
        <span class="s">{{ state_attr('weather.home', 'pressure') | float | round(1) }}</span>
      <span class="na">attributes</span><span class="pi">:</span>
        <span class="na">timestamp</span><span class="pi">:</span> <span class="pi">&gt;</span>
          <span class="s">{{ as_timestamp(now()) }}</span>
</code></pre></div></div>

<p class="notice">The <code class="language-plaintext highlighter-rouge">time_pattern</code> trigger is every 1 hour because the measurement resolution for the Met.no integration is 1 hour.  Obviously, if this is different for your weather integration, then set it to a different trigger value to match the measurement resolution.</p>

<p><strong>Check your config</strong> and <strong>restart your HASS</strong>.  Now <strong>wait</strong> for it to collect enough data points to allow meaningful analysis (at least 2 hours).</p>

<p>Afterwards, we will create the following three <code class="language-plaintext highlighter-rouge">statistics</code> sensors for the new entities which will provide descriptive metrics for each of them over a time period of <em>one day</em>:</p>

<ol>
  <li>
    <p><code class="language-plaintext highlighter-rouge">weather temperature one day ago</code>: Descriptive measures for the <code class="language-plaintext highlighter-rouge">sensor.template_weather_temperature_time_based</code> over the last one <em>day</em>;</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">weather humidity one day ago</code>: Descriptive measures for the <code class="language-plaintext highlighter-rouge">sensor.template_weather_humidity_time_based</code> over the last one <em>day</em>;</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">weather pressure one day ago</code>: Descriptive measures for the <code class="language-plaintext highlighter-rouge">sensor.template_weather_pressure_time_based</code> over the last one <em>day</em>;</p>
  </li>
</ol>

<p>To create those three <code class="language-plaintext highlighter-rouge">statistics</code> sensor entities, append the following to the <code class="language-plaintext highlighter-rouge">sensors.yaml</code>:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">statistics</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">weather</span><span class="nv"> </span><span class="s">temperature</span><span class="nv"> </span><span class="s">one</span><span class="nv"> </span><span class="s">day</span><span class="nv"> </span><span class="s">ago"</span>
  <span class="na">entity_id</span><span class="pi">:</span> <span class="s">sensor.template_weather_temperature_time_based</span>
  <span class="c1"># measurement resolution is 1/hour</span>
  <span class="na">sampling_size</span><span class="pi">:</span> <span class="m">24</span>
  <span class="na">max_age</span><span class="pi">:</span>
    <span class="na">days</span><span class="pi">:</span> <span class="m">1</span>
<span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">statistics</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">weather</span><span class="nv"> </span><span class="s">humidity</span><span class="nv"> </span><span class="s">one</span><span class="nv"> </span><span class="s">day</span><span class="nv"> </span><span class="s">ago"</span>
  <span class="na">entity_id</span><span class="pi">:</span> <span class="s">sensor.template_weather_humidity_time_based</span>
  <span class="c1"># measurement resolution is 1/hour</span>
  <span class="na">sampling_size</span><span class="pi">:</span> <span class="m">24</span>
  <span class="na">max_age</span><span class="pi">:</span>
    <span class="na">days</span><span class="pi">:</span> <span class="m">1</span>
<span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">statistics</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">weather</span><span class="nv"> </span><span class="s">pressure</span><span class="nv"> </span><span class="s">one</span><span class="nv"> </span><span class="s">day</span><span class="nv"> </span><span class="s">ago"</span>
  <span class="na">entity_id</span><span class="pi">:</span> <span class="s">sensor.template_weather_pressure_time_based</span>
  <span class="c1"># measurement resolution is 1/hour</span>
  <span class="na">sampling_size</span><span class="pi">:</span> <span class="m">24</span>
  <span class="na">max_age</span><span class="pi">:</span>
    <span class="na">days</span><span class="pi">:</span> <span class="m">1</span>
</code></pre></div></div>

<p>Once again, check your configuration file and then restart your HASS. Check your log file and <strong>wait</strong> at least one hour.  Remember that such sensors will only update when the monitored entities also update, which in our case is every 1 hour.  Afterwards, head to <strong>Developer Tools</strong> &gt; States and you should now see the three new entities we just created:</p>

<p><a href="/assets/posts/2021-06-04-smarter-hass/hass-utility-statistics-02.jpg"><img src="/assets/posts/2021-06-04-smarter-hass/hass-utility-statistics-02.jpg" alt="HASS utility statistics 02" class="PostImage PostImage--large" /></a></p>

<p>This examples shows that over the last 24h, the temperature ranged from 9.7°C to 13.8°C, with a mean of 11.3°C and standard deviation of ±1.2°C.</p>

<h4 id="additional-references-1">Additional references</h4>
<ul>
  <li>Statistics <strong>documentation</strong>: <a href="https://www.home-assistant.io/integrations/statistics/">https://www.home-assistant.io/integrations/statistics/</a></li>
  <li>Statistics <strong>source</strong>: <a href="https://github.com/home-assistant/core/blob/dev/homeassistant/components/statistics/">https://github.com/home-assistant/core/blob/dev/homeassistant/components/statistics/</a></li>
  <li>Statistics noteworthy <strong>dependencies</strong>:
    <ul>
      <li>Python <code class="language-plaintext highlighter-rouge">statistics</code> core pkg: <a href="https://docs.python.org/3/library/statistics.html">https://docs.python.org/3/library/statistics.html</a></li>
    </ul>
  </li>
</ul>

<p><a href="#utilities" class="btn btn--info btn--small">Utilities</a></p>

<h3 id="trend">Trend</h3>
<p>The <a href="https://www.home-assistant.io/integrations/trend/">Trend</a> integration is the only one that depends on an external Python package, namely the <a href="https://numpy.org"><code class="language-plaintext highlighter-rouge">numpy</code></a> package, and it does exactly what you’d expect from its name: it provides a trend coefficient for the data set spanning a user-specified time period.  More specifically, this integration fits a <strong>linear</strong> function to the data points of an entity–via NumPy’s <code class="language-plaintext highlighter-rouge">np.polyfit()</code> method–and outputs the <strong>slope</strong> of the function, which is called by <em>gradient</em>.  As such, it is a very useful integration for any scenario in which we need to know whether the data are <em>increasing</em> or <em>decreasing</em> over time.</p>

<p>The specification of time in this integration is very similar to the <a href="#statistics-01">Statistics</a> integration, except that (a) <code class="language-plaintext highlighter-rouge">sampling_size</code> is now called <code class="language-plaintext highlighter-rouge">max_samples</code>, (b) <code class="language-plaintext highlighter-rouge">max_age</code> is now called <code class="language-plaintext highlighter-rouge">sample_duration</code>, and (c) the latter is specified in <em>seconds</em> instead of using a duration syntax.  Specifically, the time period is specified by the following two time variables:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">max_samples</code>: The maximum number of data points. By default, it uses the last two data points (<code class="language-plaintext highlighter-rouge">max_samples: 2</code>);</li>
  <li><code class="language-plaintext highlighter-rouge">sample_duration</code>: The duration (in seconds) of the oldest data point.  By default, it is unconstrained (<code class="language-plaintext highlighter-rouge">sample_duration: 0</code>).</li>
</ul>

<h4 id="usage-examples-2">Usage examples</h4>
<p>Contrary to the previous two utilities, a <code class="language-plaintext highlighter-rouge">trend</code> sensor is defined as a platform (<code class="language-plaintext highlighter-rouge">- platform: trend</code>) under <strong><code class="language-plaintext highlighter-rouge">binary_sensor:</code></strong> in your <code class="language-plaintext highlighter-rouge">configuration.yaml</code> file.  For this reason, first, let’s include a reference to a <code class="language-plaintext highlighter-rouge">binary_sensors.yaml</code> in the <code class="language-plaintext highlighter-rouge">configuration.yaml</code> file, as follows:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Binary sensors</span>
<span class="na">binary_sensor</span><span class="pi">:</span> <span class="kt">!include</span> <span class="s">binary_sensors.yaml</span>
</code></pre></div></div>

<p>Then using a text editor, create a <code class="language-plaintext highlighter-rouge">binary_sensors.yaml</code> file where we will configure the following four <code class="language-plaintext highlighter-rouge">trend</code> binary sensors to consume the data from the temperature, humidity, and pressure time-based template sensors, as well as the Sun elevation:</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">trend weather temperature six hours</code>: Gradient of the <code class="language-plaintext highlighter-rouge">sensor.template_weather_temperature_time_based</code> template sensor over the <em>last six hours</em>;</li>
  <li><code class="language-plaintext highlighter-rouge">trend weather humidity six hours</code>: Gradient of the <code class="language-plaintext highlighter-rouge">sensor.template_weather_humidity_time_based</code> template sensor over the <em>last six hours</em>;</li>
  <li><code class="language-plaintext highlighter-rouge">trend weather pressure twelve hours</code>: Gradient of the <code class="language-plaintext highlighter-rouge">sensor.template_weather_pressure_time_based</code> template sensor over the <em>last twelve hours</em>;</li>
  <li><code class="language-plaintext highlighter-rouge">trend sun elevation twenty minutes</code>: Gradient of the <code class="language-plaintext highlighter-rouge">sensor.template_sun_elevation_time_based</code> template sensor over the <em>last twenty minutes</em>;</li>
</ol>

<p>To create those <code class="language-plaintext highlighter-rouge">trend</code> entities, append the following to the <code class="language-plaintext highlighter-rouge">binary_sensors.yaml</code> file:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Trend</span>
<span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">trend</span>
  <span class="na">sensors</span><span class="pi">:</span>
    <span class="na">trend_weather_temperature_six_hours</span><span class="pi">:</span>
      <span class="na">entity_id</span><span class="pi">:</span> <span class="s">sensor.template_weather_temperature_time_based</span>
      <span class="c1"># resolution is 1/h</span>
      <span class="na">max_samples</span><span class="pi">:</span> <span class="m">6</span>
      <span class="c1"># 6 hours in seconds</span>
      <span class="na">sample_duration</span><span class="pi">:</span> <span class="m">21600</span>
    <span class="na">trend_weather_humidity_six_hours</span><span class="pi">:</span>
      <span class="na">entity_id</span><span class="pi">:</span> <span class="s">sensor.template_weather_humidity_time_based</span>
      <span class="c1"># resolution is 1/h</span>
      <span class="na">max_samples</span><span class="pi">:</span> <span class="m">6</span>
      <span class="c1"># 6 hours in seconds</span>
      <span class="na">sample_duration</span><span class="pi">:</span> <span class="m">21600</span>
    <span class="na">trend_weather_pressure_twelve_hours</span><span class="pi">:</span>
      <span class="na">entity_id</span><span class="pi">:</span> <span class="s">sensor.template_weather_pressure_time_based</span>
      <span class="c1"># resolution is 1/h</span>
      <span class="na">max_samples</span><span class="pi">:</span> <span class="m">12</span>
      <span class="c1"># 12 hours in seconds</span>
      <span class="na">sample_duration</span><span class="pi">:</span> <span class="m">43200</span>
    <span class="na">trend_sun_elevation_twenty_minutes</span><span class="pi">:</span>
      <span class="na">entity_id</span><span class="pi">:</span> <span class="s">sensor.template_sun_elevation_time_based</span>
      <span class="c1"># resolution is 1 every 5 minutes</span>
      <span class="na">max_samples</span><span class="pi">:</span> <span class="m">4</span>
      <span class="c1"># 20 minutes in seconds</span>
      <span class="na">sample_duration</span><span class="pi">:</span> <span class="m">1200</span>
</code></pre></div></div>

<p><strong>Check your configuration file</strong> and if everything looks good, <strong>restart HASS</strong>. Afterwards, check your log file for related errors and if it all looks good, then head to <strong>Developer Tools</strong> &gt; States and you should now see the new trend entities we just created:</p>

<p><a href="/assets/posts/2021-06-04-smarter-hass/hass-utility-trend-01.jpg"><img src="/assets/posts/2021-06-04-smarter-hass/hass-utility-trend-01.jpg" alt="HASS utility trend 01" class="PostImage PostImage--large" /></a></p>

<p><a href="/assets/posts/2021-06-04-smarter-hass/hass-utility-trend-02.jpg"><img src="/assets/posts/2021-06-04-smarter-hass/hass-utility-trend-02.jpg" alt="HASS utility trend 02" class="PostImage" /></a></p>

<p>Two noteworthy observations need to be made at this point.  First, notice that this integration does not analyze the data from previously stored entity data but actually stores its own data.  Therefore, it’s necessary to keep it running to collect data from all monitored entities before drawing any meaningful conclusions from it.  Second, the slope of the linear function that was fit over the data points (<code class="language-plaintext highlighter-rouge">gradient</code>) is reported as an <strong>attribute</strong> and because it uses <em>seconds</em> as time unit, the coefficient refers to the ratio of change <em>per second</em>.  Therefore, to make it easier working with <code class="language-plaintext highlighter-rouge">gradient</code>, I usually create a slave entity to output the gradient as its state instead. This is accomplished with <strong>template sensors</strong>.  More specifically, let’s append the following <em>Trend helper entities</em> under our default (state-based) <strong>Sensor Templates</strong> in the <code class="language-plaintext highlighter-rouge">templates.yaml</code> file:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c1"># Trend helper entities</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">template</span><span class="nv"> </span><span class="s">trend</span><span class="nv"> </span><span class="s">sun</span><span class="nv"> </span><span class="s">elevation</span><span class="nv"> </span><span class="s">twenty</span><span class="nv"> </span><span class="s">minutes"</span>
      <span class="na">unit_of_measurement</span><span class="pi">:</span> <span class="s2">"</span><span class="s">°/h"</span>
      <span class="c1"># if statement makes sure the gradient is valid</span>
      <span class="c1"># change the scale from sec to hour</span>
      <span class="na">state</span><span class="pi">:</span> <span class="pi">&gt;</span>
        <span class="s">{% if state_attr('binary_sensor.trend_sun_elevation_twenty_minutes', 'gradient') is number %}</span>
           <span class="s">{{ (state_attr('binary_sensor.trend_sun_elevation_twenty_minutes', 'gradient') * 3600) | round(1) }}</span>
        <span class="s">{% endif %}</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">template</span><span class="nv"> </span><span class="s">trend</span><span class="nv"> </span><span class="s">weather</span><span class="nv"> </span><span class="s">temperature</span><span class="nv"> </span><span class="s">six</span><span class="nv"> </span><span class="s">hours"</span>
      <span class="na">unit_of_measurement</span><span class="pi">:</span> <span class="s2">"</span><span class="s">C/h"</span>
      <span class="na">state</span><span class="pi">:</span> <span class="pi">&gt;</span>
        <span class="s">{% if state_attr('binary_sensor.trend_weather_temperature_six_hours', 'gradient') is number %}</span>
           <span class="s">{{ (state_attr('binary_sensor.trend_weather_temperature_six_hours', 'gradient') * 3600) | round(2) }}</span>
        <span class="s">{% endif %}</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">template</span><span class="nv"> </span><span class="s">trend</span><span class="nv"> </span><span class="s">weather</span><span class="nv"> </span><span class="s">humidity</span><span class="nv"> </span><span class="s">six</span><span class="nv"> </span><span class="s">hours"</span>
      <span class="na">unit_of_measurement</span><span class="pi">:</span> <span class="s2">"</span><span class="s">%/h"</span>
      <span class="na">state</span><span class="pi">:</span> <span class="pi">&gt;</span>
        <span class="s">{% if state_attr('binary_sensor.trend_weather_humidity_six_hours', 'gradient') is number %}</span>
           <span class="s">{{ (state_attr('binary_sensor.trend_weather_humidity_six_hours', 'gradient') * 3600) | round(2) }}</span>
        <span class="s">{% endif %}</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">template</span><span class="nv"> </span><span class="s">trend</span><span class="nv"> </span><span class="s">weather</span><span class="nv"> </span><span class="s">pressure</span><span class="nv"> </span><span class="s">twelve</span><span class="nv"> </span><span class="s">hours"</span>
      <span class="na">unit_of_measurement</span><span class="pi">:</span> <span class="s2">"</span><span class="s">hPa/h"</span>
      <span class="na">state</span><span class="pi">:</span> <span class="pi">&gt;</span>
        <span class="s">{% if state_attr('binary_sensor.trend_weather_pressure_twelve_hours', 'gradient') is number %}</span>
           <span class="s">{{ (state_attr('binary_sensor.trend_weather_pressure_twelve_hours', 'gradient') * 3600) | round(0) }}</span>
        <span class="s">{% endif %}</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">if</code> statement is used to validate (<code class="language-plaintext highlighter-rouge">is number</code>) the appropriate variables in the unit conversion and rounding operations.  Otherwise, the template sensor might attempt to perform a mathematical operation on something other than a number, such as when the <code class="language-plaintext highlighter-rouge">gradient</code> attribute is not yet defined, which would result in an error.</p>

<p>Now <strong>reload your configuration</strong> and afterwards, HASS will create new <code class="language-plaintext highlighter-rouge">sensor.template_trend_*</code> entities that should contain the converted gradient as their state.</p>

<p><a href="/assets/posts/2021-06-04-smarter-hass/hass-utility-trend-03.jpg"><img src="/assets/posts/2021-06-04-smarter-hass/hass-utility-trend-03.jpg" alt="HASS utility trend 03" class="PostImage" /></a></p>

<h4 id="additional-references-2">Additional references</h4>
<ul>
  <li>Trend <strong>documentation</strong>: <a href="https://www.home-assistant.io/integrations/trend/">https://www.home-assistant.io/integrations/trend/</a></li>
  <li>Trend <strong>source code</strong>: <a href="https://github.com/home-assistant/core/blob/dev/homeassistant/components/trend/">https://github.com/home-assistant/core/blob/dev/homeassistant/components/trend/</a></li>
  <li>Trend noteworthy <strong>dependencies</strong>:
    <ul>
      <li>Python <code class="language-plaintext highlighter-rouge">numpy</code> pkg: <a href="https://numpy.org/doc/stable/reference/generated/numpy.polyfit.html">https://numpy.org/doc/stable/reference/generated/numpy.polyfit.html</a></li>
    </ul>
  </li>
</ul>

<p><a href="#utilities" class="btn btn--info btn--small">Utilities</a></p>

<h2 id="visualizing-analytical-data">Visualizing analytical data</h2>
<p>There are many different ways of using and visualizing the analytical data reported with the utilities described in this guide.  Using the default configuration, for example, one might be inclined to display the mean or gradient using a <a href="https://www.home-assistant.io/lovelace/history-graph/">History Graph Card</a>.</p>

<p class="notice--info">Of note, if one or more of your sensors make use of the <a href="#long-term-statistics">long-term statistics</a> feature, then the new <a href="https://www.home-assistant.io/lovelace/statistics-graph/">Statistics Graph Card</a> is the only way of visualizing their long-term summary data. The remaining part of this section describes visualization resources for sensor data stored on the <code class="language-plaintext highlighter-rouge">states</code> table of the HASS DB, instead of the <code class="language-plaintext highlighter-rouge">statistics</code> table.</p>

<p>In this section, however, we will learn about two dashboard resources that I think are better alternatives to the History Graph Card, namely the <a href="https://github.com/kalkih/mini-graph-card">Mini Graph Card</a> and the <a href="https://github.com/gadgetchnnel/lovelace-card-templater">Lovelace Card Templater</a>. More specifically, we will use the Mini Graph Card within the Lovelace Card Templater to build the following Dashboard card previewed in the <a href="#introduction">Introduction</a>:</p>

<p><a href="/assets/posts/2021-06-04-smarter-hass/hass-graph-dynamic-temperature-01.gif"><img src="/assets/posts/2021-06-04-smarter-hass/hass-graph-dynamic-temperature-01.gif" alt="HASS graph dynamic temperature 01" class="PostImage" /></a></p>

<p>And here’s how it has changed a few hours later:</p>

<p><a href="/assets/posts/2021-06-04-smarter-hass/hass-graph-dynamic-temperature-02.gif"><img src="/assets/posts/2021-06-04-smarter-hass/hass-graph-dynamic-temperature-02.gif" alt="HASS graph dynamic temperature 02" class="PostImage" /></a></p>

<p>This card displays <strong>six temperature</strong> (Met.no) <strong>metrics</strong> over a 24h time-range:</p>

<ul>
  <li>
    <p>The main (colored) line shows the <strong>current temperature</strong>, in which the colors are selected by the following ever changing (dynamic) thresholds:</p>

    <table>
      <thead>
        <tr>
          <th style="text-align: center">very high</th>
          <th style="text-align: center">high</th>
          <th style="text-align: center">low</th>
          <th style="text-align: center">very low</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td style="text-align: center"><em>max</em> to (<em>mean</em> <strong>+</strong> <em>stdev</em>)</td>
          <td style="text-align: center">(<em>mean</em> <strong>+</strong> <em>stdev</em>) to <em>mean</em></td>
          <td style="text-align: center"><em>mean</em> to (<em>mean</em> <strong>-</strong> <em>stdev</em>)</td>
          <td style="text-align: center">(<em>mean</em> <strong>-</strong> <em>stdev</em>) to <em>min</em></td>
        </tr>
      </tbody>
    </table>

    <p>And the corresponding colors were selected from the following <a href="https://coolors.co">palette</a> (hex color code shown above the color label):</p>

    <p><a href="/assets/posts/2021-06-04-smarter-hass/color-palette.jpg"><img src="/assets/posts/2021-06-04-smarter-hass/color-palette.jpg" alt="Color palette" class="PostImage PostImage--large" /></a></p>
  </li>
  <li>The highest valued shaded area in the background corresponds to the <strong>max temperature</strong> over the last 24hrs;</li>
  <li>The second highest shaded area corresponds to <strong>plus one standard deviation</strong> from the mean temperature over the last 24hrs;</li>
  <li>The middle shaded area corresponds to the <strong>mean temperature</strong> over the last 24hrs;</li>
  <li>The second lowest value shaded area corresponds to <strong>minus one standard deviation</strong> from the mean temperature over the last 24hrs;</li>
  <li>And finally, the lowest shaded area corresponds to the <strong>min temperature</strong> over the last 24hrs.</li>
</ul>

<p>The graph therefore provides a visually appealing way of assessing the current temperature relative to its 24hrs distribution, which is much more convenient than inspecting a table of values over time. Next, I will describe how to create the graph step-by-step.</p>

<h3 id="how-to-temperature-with-dynamic-color-thresholds">How-to: Temperature with dynamic color thresholds</h3>
<p>First, make sure you have an entity for each of the six metrics described before.  All such metrics can be obtained from the <strong><a href="#statistics-01">Statistics</a> integration</strong>, which will consume the data from a temperature sensor (e.g., <code class="language-plaintext highlighter-rouge">weather.home</code> via Met.no) and by using custom <strong>template sensors</strong>.  More specifically, make sure your <code class="language-plaintext highlighter-rouge">configuration.yaml</code> file has an <code class="language-plaintext highlighter-rouge">!include</code> for both <code class="language-plaintext highlighter-rouge">sensors.yaml</code> and <code class="language-plaintext highlighter-rouge">templates.yaml</code>, as follows:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Sensors</span>
<span class="na">sensor</span><span class="pi">:</span> <span class="kt">!include</span> <span class="s">sensors.yaml</span>
<span class="c1"># Templates</span>
<span class="na">template</span><span class="pi">:</span> <span class="kt">!include</span> <span class="s">templates.yaml</span>
</code></pre></div></div>

<p>Then using a text editor, add the following to <code class="language-plaintext highlighter-rouge">templates.yaml</code> to create a <code class="language-plaintext highlighter-rouge">time_pattern</code> triggered entity that extracts and stores the <code class="language-plaintext highlighter-rouge">temperature</code> attribute from <code class="language-plaintext highlighter-rouge">weather.home</code>:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Time pattern trigger</span>
<span class="pi">-</span> <span class="na">trigger</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">time_pattern</span>
      <span class="c1"># Update every 1 hour</span>
      <span class="na">hours</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/1"</span>
  <span class="c1"># Hourly sensor templates</span>
  <span class="na">sensor</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">template</span><span class="nv"> </span><span class="s">weather</span><span class="nv"> </span><span class="s">temperature"</span>
      <span class="na">unit_of_measurement</span><span class="pi">:</span> <span class="s2">"</span><span class="s">C"</span>
      <span class="na">state</span><span class="pi">:</span> <span class="pi">&gt;</span>
        <span class="s">{% if state_attr('weather.home', 'temperature') is number %}</span>
          <span class="s">{{ state_attr('weather.home', 'temperature') }}</span>
        <span class="s">{% endif %}</span>
      <span class="na">attributes</span><span class="pi">:</span>
        <span class="c1"># Force an update with a timestamp change to ensure proper representation of state values over time</span>
        <span class="na">timestamp</span><span class="pi">:</span> <span class="pi">&gt;</span>
          <span class="s">{{ as_timestamp(now()) }}</span>
</code></pre></div></div>

<p>In your <code class="language-plaintext highlighter-rouge">sensors.yaml</code> file, append the following to create a Statistics sensor for the temperature over the last 24hrs:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Statistics</span>
<span class="pi">-</span> <span class="na">platform</span><span class="pi">:</span> <span class="s">statistics</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">weather</span><span class="nv"> </span><span class="s">temperature</span><span class="nv"> </span><span class="s">one</span><span class="nv"> </span><span class="s">day"</span>
  <span class="na">entity_id</span><span class="pi">:</span> <span class="s">sensor.template_weather_temperature</span>
  <span class="c1"># measurement resolution is 1/hour</span>
  <span class="na">sampling_size</span><span class="pi">:</span> <span class="m">24</span>
  <span class="na">max_age</span><span class="pi">:</span>
    <span class="na">days</span><span class="pi">:</span> <span class="m">1</span>
</code></pre></div></div>

<p>Now go back to <code class="language-plaintext highlighter-rouge">templates.yaml</code> and add a few helper entities to extract the attributes from the <code class="language-plaintext highlighter-rouge">sensor.weather_temperature_one_day</code> Statistics sensor, as follows:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Sensor Templates</span>
<span class="pi">-</span> <span class="na">sensor</span><span class="pi">:</span>
    <span class="c1"># Statistics helper entities</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">template</span><span class="nv"> </span><span class="s">weather</span><span class="nv"> </span><span class="s">temperature</span><span class="nv"> </span><span class="s">one</span><span class="nv"> </span><span class="s">day</span><span class="nv"> </span><span class="s">mean</span><span class="nv"> </span><span class="s">plus</span><span class="nv"> </span><span class="s">stdev"</span>
      <span class="na">unit_of_measurement</span><span class="pi">:</span> <span class="s2">"</span><span class="s">C"</span>
      <span class="na">state</span><span class="pi">:</span> <span class="pi">&gt;</span>
        <span class="s">{% if state_attr('sensor.weather_temperature_one_day', 'mean') is number and state_attr('sensor.weather_temperature_one_day', 'standard_deviation') is number %}</span>
           <span class="s">{{ (state_attr('sensor.weather_temperature_one_day', 'mean') + state_attr('sensor.weather_temperature_one_day', 'standard_deviation')) | round(1) }}</span>
        <span class="s">{% endif %}</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">template</span><span class="nv"> </span><span class="s">weather</span><span class="nv"> </span><span class="s">temperature</span><span class="nv"> </span><span class="s">one</span><span class="nv"> </span><span class="s">day</span><span class="nv"> </span><span class="s">mean</span><span class="nv"> </span><span class="s">minus</span><span class="nv"> </span><span class="s">stdev"</span>
      <span class="na">unit_of_measurement</span><span class="pi">:</span> <span class="s2">"</span><span class="s">C"</span>
      <span class="na">state</span><span class="pi">:</span> <span class="pi">&gt;</span>
        <span class="s">{% if state_attr('sensor.weather_temperature_one_day', 'mean') is number and state_attr('sensor.weather_temperature_one_day', 'standard_deviation') is number %}</span>
           <span class="s">{{ (state_attr('sensor.weather_temperature_one_day', 'mean') - state_attr('sensor.weather_temperature_one_day', 'standard_deviation')) | round(1) }}</span>
        <span class="s">{% endif %}</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">template</span><span class="nv"> </span><span class="s">weather</span><span class="nv"> </span><span class="s">temperature</span><span class="nv"> </span><span class="s">one</span><span class="nv"> </span><span class="s">day</span><span class="nv"> </span><span class="s">max"</span>
      <span class="na">unit_of_measurement</span><span class="pi">:</span> <span class="s2">"</span><span class="s">C"</span>
      <span class="na">state</span><span class="pi">:</span> <span class="pi">&gt;</span>
        <span class="s">{% if state_attr('sensor.weather_temperature_one_day', 'max_value') is number %}</span>
           <span class="s">{{ state_attr('sensor.weather_temperature_one_day', 'max_value') | round(1) }}</span>
        <span class="s">{% endif %}</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">template</span><span class="nv"> </span><span class="s">weather</span><span class="nv"> </span><span class="s">temperature</span><span class="nv"> </span><span class="s">one</span><span class="nv"> </span><span class="s">day</span><span class="nv"> </span><span class="s">min"</span>
      <span class="na">unit_of_measurement</span><span class="pi">:</span> <span class="s2">"</span><span class="s">C"</span>
      <span class="na">state</span><span class="pi">:</span> <span class="pi">&gt;</span>
        <span class="s">{% if state_attr('sensor.weather_temperature_one_day', 'min_value') is number %}</span>
           <span class="s">{{ state_attr('sensor.weather_temperature_one_day', 'min_value') | round(1) }}</span>
        <span class="s">{% endif %}</span>
</code></pre></div></div>

<p class="notice">As before, the <code class="language-plaintext highlighter-rouge">if</code> statements ensure the variables are valid (<code class="language-plaintext highlighter-rouge">is number</code>) before performing mathematical operations with them.</p>

<p>Finally, <strong>check your configuration</strong> and <strong>restart your HASS</strong>.  Now <strong>wait at least one day</strong> because your new entities need to collect data before showing anything meaningful.  But in the meantime, go ahead and install the two JavaScripts to your dashboard:</p>

<ul>
  <li><a href="https://github.com/kalkih/mini-graph-card#install">Install Mini Card Graph</a></li>
  <li><a href="https://github.com/gadgetchnnel/lovelace-card-templater#installation">Install Lovelace Card Templater</a></li>
</ul>

<p>Personally, I prefer to install such resources manually, instead of using the Community Store.  To do so:</p>

<ol>
  <li><strong>Download</strong> their respective <code class="language-plaintext highlighter-rouge">.js</code> scripts to your HASS <code class="language-plaintext highlighter-rouge">config/www/</code> directory;</li>
  <li>Navigate to Configuration &gt; Lovelace Dashboards &gt; <strong>Resources</strong> and select <strong>add resource</strong>;</li>
  <li>In the <strong>Add new resource</strong> window, set the URL to <code class="language-plaintext highlighter-rouge">/local/MODULE_NAME.js</code>, in which <code class="language-plaintext highlighter-rouge">MODULE_NAME</code> will be the name of the JavaScript module (e.g., for the Mini Graph Card, that would be <code class="language-plaintext highlighter-rouge">/local/mini-graph-card-bundle.js</code>). HASS should automatically detect that the Resource Type is a <code class="language-plaintext highlighter-rouge">JavaScript Module</code> but if doesn’t, then select it;</li>
  <li>Press <strong>update</strong> and repeat the operation to add as many resources as necessary;</li>
  <li><strong>Restart your HASS</strong>.</li>
</ol>

<p>If an entire day has already passed, then you should be able to configure a proper graph card using the JavaScript modules you added to the HASS dashboard, as follows:</p>

<ol>
  <li>Navigate to Overview &gt; Edit Dashboard and select <strong>add card</strong>;</li>
  <li>Choose a <strong>Manual card</strong> and in the card configuration, paste the following:</li>
</ol>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">type</span><span class="pi">:</span> <span class="s">custom:card-templater</span>
<span class="na">card</span><span class="pi">:</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">custom:mini-graph-card</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">Temperature - Met.no</span>
  <span class="na">hours_to_show</span><span class="pi">:</span> <span class="m">24</span>
  <span class="na">animate</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">align_state</span><span class="pi">:</span> <span class="s">right</span>
  <span class="na">align_icon</span><span class="pi">:</span> <span class="s">left</span>
  <span class="na">align_header</span><span class="pi">:</span> <span class="s">left</span>
  <span class="na">font_size_header</span><span class="pi">:</span> <span class="m">12</span>
  <span class="na">font_size</span><span class="pi">:</span> <span class="m">80</span>
  <span class="na">decimals</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">line_width</span><span class="pi">:</span> <span class="m">4</span>
  <span class="na">entities</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">entity</span><span class="pi">:</span> <span class="s">sensor.template_weather_temperature</span>
      <span class="na">show_fill</span><span class="pi">:</span> <span class="no">false</span>
      <span class="na">state_adaptive_color</span><span class="pi">:</span> <span class="no">true</span>
      <span class="na">unit</span><span class="pi">:</span> <span class="s">°C</span>
    <span class="pi">-</span> <span class="na">entity</span><span class="pi">:</span> <span class="s">sensor.template_weather_temperature_one_day_max</span>
      <span class="na">show_line</span><span class="pi">:</span> <span class="no">false</span>
      <span class="na">show_points</span><span class="pi">:</span> <span class="no">false</span>
      <span class="na">color</span><span class="pi">:</span> <span class="s">white</span>
    <span class="pi">-</span> <span class="na">entity</span><span class="pi">:</span> <span class="s">sensor.template_weather_temperature_one_day_mean_plus_stdev</span>
      <span class="na">show_line</span><span class="pi">:</span> <span class="no">false</span>
      <span class="na">show_points</span><span class="pi">:</span> <span class="no">false</span>
      <span class="na">color</span><span class="pi">:</span> <span class="s">white</span>
    <span class="pi">-</span> <span class="na">entity</span><span class="pi">:</span> <span class="s">sensor.weather_temperature_one_day</span>
      <span class="na">show_line</span><span class="pi">:</span> <span class="no">false</span>
      <span class="na">show_points</span><span class="pi">:</span> <span class="no">false</span>
      <span class="na">color</span><span class="pi">:</span> <span class="s">white</span>
    <span class="pi">-</span> <span class="na">entity</span><span class="pi">:</span> <span class="s">sensor.template_weather_temperature_one_day_mean_minus_stdev</span>
      <span class="na">show_line</span><span class="pi">:</span> <span class="no">false</span>
      <span class="na">show_points</span><span class="pi">:</span> <span class="no">false</span>
      <span class="na">color</span><span class="pi">:</span> <span class="s">white</span>
    <span class="pi">-</span> <span class="na">entity</span><span class="pi">:</span> <span class="s">sensor.template_weather_temperature_one_day_min</span>
      <span class="na">show_line</span><span class="pi">:</span> <span class="no">false</span>
      <span class="na">show_points</span><span class="pi">:</span> <span class="no">false</span>
      <span class="na">color</span><span class="pi">:</span> <span class="s">white</span>
  <span class="na">color_thresholds</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">value_template</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{{</span><span class="nv"> </span><span class="s">states("sensor.template_weather_temperature_one_day_min")</span><span class="nv"> </span><span class="s">}}'</span>
      <span class="na">color</span><span class="pi">:</span> <span class="s1">'</span><span class="s">#0799BA'</span>
    <span class="pi">-</span> <span class="na">value_template</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{{</span><span class="nv"> </span><span class="s">states("sensor.template_weather_temperature_one_day_mean_minus_stdev")</span><span class="nv"> </span><span class="s">}}'</span>
      <span class="na">color</span><span class="pi">:</span> <span class="s1">'</span><span class="s">#30BFBF'</span>
    <span class="pi">-</span> <span class="na">value_template</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{{</span><span class="nv"> </span><span class="s">states("sensor.weather_temperature_one_day")</span><span class="nv"> </span><span class="s">}}'</span>
      <span class="na">color</span><span class="pi">:</span> <span class="s1">'</span><span class="s">#ECD711'</span>
    <span class="pi">-</span> <span class="na">value_template</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{{</span><span class="nv"> </span><span class="s">states("sensor.template_weather_temperature_one_day_mean_plus_stdev")</span><span class="nv"> </span><span class="s">}}'</span>
      <span class="na">color</span><span class="pi">:</span> <span class="s1">'</span><span class="s">#F17D28'</span>
  <span class="na">show</span><span class="pi">:</span>
    <span class="na">labels</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">legend</span><span class="pi">:</span> <span class="no">false</span>
    <span class="na">name_adaptive_color</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">icon_adaptive_color</span><span class="pi">:</span> <span class="no">true</span>
<span class="na">entities</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">sensor.weather_temperature_one_day</span>
  <span class="pi">-</span> <span class="s">sensor.template_weather_temperature_one_day_mean_plus_stdev</span>
  <span class="pi">-</span> <span class="s">sensor.template_weather_temperature_one_day_mean_minus_stdev</span>
  <span class="pi">-</span> <span class="s">sensor.template_weather_temperature_one_day_max</span>
  <span class="pi">-</span> <span class="s">sensor.template_weather_temperature_one_day_min</span>
</code></pre></div></div>

<p>That is it!  You should now be able to see a graph similar to the following one:</p>

<p><a href="/assets/posts/2021-06-04-smarter-hass/hass-graph-dynamic-temperature-03.jpg"><img src="/assets/posts/2021-06-04-smarter-hass/hass-graph-dynamic-temperature-03.jpg" alt="HASS graph dynamic temperature 03" class="PostImage PostImage--large" /></a></p>

<p>If the values are not showing up correctly, check Developer Tools &gt; States to make sure the entities are there and the states are displaying the correct values.  If you want to reset the entity data, go to Developer Tools &gt; Services, select <code class="language-plaintext highlighter-rouge">recorder.purge_entities</code>, select the entities you want to reset in Targets (e.g., <code class="language-plaintext highlighter-rouge">sensor.weather_temperature_one_day</code>), and press <strong>call service</strong> to purge their data.</p>

<p>Of course, many other options are available using the <strong>Mini Graph Card</strong> and the <strong>Lovelace Card Templater</strong> in combination with the other card options (e.g., <a href="https://www.home-assistant.io/lovelace/entities/">Entities Card</a>, <a href="https://www.home-assistant.io/lovelace/gauge/">Gauge Card</a>).  Feel free to explore them (and let me know about it, too).</p>

<p><a href="#" class="btn btn--light-outline btn--small">top</a></p>

<h1 id="development">Development</h1>
<p>In this guide, we’ve seen how the current set of analytical tools can greatly improve the way we <strong>describe</strong> past and current states.  (<em>The following was changed on August 14th, 2021, in connection with the addition of quantiles to the Statistics integration.</em>)  However, the lack of a flexible and standardized specification of the <em>time variables</em> make the current analytical tools very narrow in scope.  Compare, for example, how the <a href="#history-stats">History Stats</a> and the <a href="#statistics-1">Statistics</a> integration deal with the specification of a time period.</p>

<p>In addition, statistics is not just about summarizing the past; it is also a tool for making <strong>data-driven inferences</strong> about the future.  This is a topic that I find largely unexplored in home automation systems and would allow for the creation of what I call <strong>inferential automations</strong>.  Inferential automations determine actions based on abnormal states and measurements, for example, or reliable tendencies over a user-specified period of time:</p>

<ul>
  <li>if the water level is <em>significantly lower than yesterday</em>, then __ .</li>
  <li>if the number of detected cars on my camera is <em>significantly higher than thirty minutes ago</em>, then __ .</li>
  <li>if the temperature started <em>decreasing significantly over the last five minutes</em>, then __ .</li>
  <li>if the VOC started <em>increasing significantly over the last fifteen minutes</em>, then __ .</li>
</ul>

<p><a href="/assets/posts/2021-06-04-smarter-hass/voc-plot-linear-fit.jpg"><img src="/assets/posts/2021-06-04-smarter-hass/voc-plot-linear-fit.jpg" alt="VOC plot linear fit" class="PostImage PostImage--large" /></a></p>

<p>Sadly, none of the integrations currently enables the use of inferential automations.  The closest we have to such a thing is via the use of the <a href="#trend">Trend</a> integration but even then, we lack the output of fit metrics for proper inference, such as the residuals of the least-square fit.</p>

<p>Of course, there’s a lot that can be done via templating but moving forward, there’s a need for advanced analytical integrations if we want to create inferential automations.  As I pointed out before, HASS integrations are written in the Python programming language, which means we can take advantage of the various analytical packages that are already available in Python, such as:</p>

<ul>
  <li><a href="https://pandas.pydata.org/">Pandas</a></li>
  <li><a href="https://numpy.org/">NumPy</a></li>
  <li><a href="https://www.scipy.org/">SciPy</a></li>
</ul>

<p>For anyone who might want to help out, the folks at the HASS wiki were very kind to write a super detailed guide about developing new integrations:</p>

<ul>
  <li><a href="https://developers.home-assistant.io/docs/development_index/">Development Workflow</a></li>
</ul>

<p><a href="/contact">Reach out</a> if you are thinking about development.</p>

<p><a href="#" class="btn btn--light-outline btn--small">top</a></p>

<h1 id="conclusion">Conclusion</h1>
<p>This marks the end of this guide.  My intention was to highlight a few of the currently available <a href="https://www.home-assistant.io/integrations/#utility">Utility integrations</a> because they are rarely used but are fairly easy to implement and incredibly useful.  There are a few gotchas to how data are sampled and stored in HASS, as well as how a few of the reviewed integrations work, which I hope were made verbatim in this guide and will help you decide what is best for your own use-case.</p>

<p>Moving forward, there is a clear trajectory for implementing what I called <strong>inferential automations</strong>.  This begins with improving existing <a href="https://www.home-assistant.io/integrations/#utility">Utility integrations</a> and ends with porting advanced analytical Python packages to the HASS environment.  The culmination of this path is the largely unexplored concept of automating the future using data-driven inferences in home automation systems.</p>

<p><a href="#" class="btn btn--light-outline btn--small">top</a></p>


        
      </section>

      <footer class="page__meta">
        
        


        
  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Posted on:</strong> <time datetime="2021-06-22T15:45:00-03:00">June 22, 2021</time></p>


      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">Share on</h4>
  

  <a href="mailto:?subject=[cgomesu.com] Towards a smarter Home Assistant: Getting started on the analytical tools&amp;body=%2Fblog%2Fsmarter-hass%2F " class="btn btn--inverse" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on E-mail"><i class="fas fa-envelope" aria-hidden="true"></i><span> E-mail</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=%2Fblog%2Fsmarter-hass%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.reddit.com/submit?title=Towards a smarter Home Assistant: Getting started on the analytical tools&url=%2Fblog%2Fsmarter-hass%2F" class="btn btn--reddit" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Reddit"><i class="fab fa-fw fa-reddit" aria-hidden="true"></i><span> Reddit</span></a>

  <a href="https://twitter.com/intent/tweet?text=Towards+a+smarter+Home+Assistant%3A+Getting+started+on+the+analytical+tools%20%2Fblog%2Fsmarter-hass%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/blog/chimarrao-gaucho/" class="pagination--pager" title="How to make a chimarrão Gaúcho
">Previous</a>
    
    
      <a href="/blog/diy-tasmota-bme280/" class="pagination--pager" title="DIY series: ESP-01 Tasmota environmental sensor
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search terms here...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search terms here..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
      
        
      
        
          <li><a href="https://github.com/cgomesu" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
        
      
        
      
        
      
        
          <li><a href="https://www.reddit.com/user/cgomesu/" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-reddit" aria-hidden="true"></i> Reddit</a></li>
        
      
    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> RSS feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2023 CGomesu - Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> and <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a></div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script src="https://kit.fontawesome.com/4eee35f757.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>







  </body>
</html>
